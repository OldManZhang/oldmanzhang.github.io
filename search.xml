<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>seq2seq æ‰‹å·¥å®ç°åŠåŸç†åˆ†æ</title>
    <url>/2024/08/13/%5B%E5%AD%A6%E8%82%A5AI%5D%20seq2seq%20%E6%89%8B%E5%B7%A5%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯é—®é¢˜"><a href="#èƒŒæ™¯é—®é¢˜" class="headerlink" title="èƒŒæ™¯é—®é¢˜"></a>èƒŒæ™¯é—®é¢˜</h2><p>ç°å®ä¸­ï¼Œæœ‰ä¸€ç±»é—®é¢˜æ˜¯ <strong>è¾“å…¥è¾“å‡ºä¸å®šé•¿</strong> çš„ï¼Œæ¯”å¦‚</p>
<ol>
<li>ç¿»è¯‘ï¼Œä»ä¸­æ–‡åˆ°è‹±æ–‡</li>
<li>æ–‡ç”Ÿå›¾ï¼Œä¸€æ®µè¯ç”Ÿæˆä¸€ä¸ªå›¾ç‰‡</li>
<li>æ‘˜è¦ï¼Œæ€»ç»“ä¸€æ®µè¯çš„ä¿¡æ¯</li>
</ol>
<p>æ‰€ä»¥ <code>seq2seq</code> å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§ ä¸€ä¸²åºåˆ— ç”Ÿæˆ å¦å¤–ä¸€ä¸²åºåˆ— é—®é¢˜çš„æ¨¡å‹ã€‚</p>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><code>seq2seq</code>ï¼Œ<code>sequence to sequence</code>ï¼Œä¹Ÿæœ‰å¦å¤–ä¸€ç§å«æ³• <code>encoder and decoder</code>ã€‚ä»–æ˜¯ä¸€ç§ä¸Šå±‚æ¨¡å‹æ¶æ„ï¼Œå³æ˜¯ç»„åˆæ¨¡å‹ï¼Œä»–å¯ä»¥ç”±ä¸åŒçš„åº•å±‚æ¨¡å‹æ¥å®ç°ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å…ˆçœ‹åŸç†å›¾ã€‚<br><em>åŸç†å›¾</em><br><img src="https://qiniu.oldzhangtech.com/mdpic/65e94f22-668b-4d3f-accc-57617096e7d4_cd0a100f-9d6f-44db-86c6-5061e8e974ae.jpeg"><br>ä»åŸç†å›¾ä¸­å¯ä»¥çŸ¥é“ï¼Œ<code>seq2seq </code>æ¨¡å‹ æœ‰ä»¥ä¸‹çš„ç‰¹å¾ï¼š</p>
<ol>
<li>æ¨¡å‹éƒ½ä¼šæœ‰ä¸€ä¸ª <code>Encoder</code> ï¼Œä¸€ä¸ª <code>Decoder</code>ï¼Œå’Œä¸€ä¸ª <code>Context</code></li>
<li><code>Encoder</code> å°±æ˜¯å­—é¢æ„æ€çš„ â€“ ç¼–ç å™¨ï¼Œ<code>src_input</code> ç»è¿‡<code>Encoder</code> å¤„ç†ï¼Œè¾“å‡º <code>Context</code> ä¸­</li>
<li>åŒç†ï¼Œ<code>Decoder</code> å°±æ˜¯è§£ç å™¨ï¼Œ<code>tgt_input</code> å’Œ <code>Context</code> ç»è¿‡ <code>Decoder</code> å¤„ç†, è¾“å‡º <code>tgt_output</code></li>
<li><code>Encoder</code> å’Œ <code>Decoder</code> éƒ½å¿…é¡»èƒ½å¤Ÿè¯†åˆ« <code>Context</code><blockquote>
<p>srcï¼š sourceï¼Œ tgtï¼š target</p>
</blockquote>
</li>
</ol>
<p>ğŸ”¥ <code>Context</code> çš„ç»„æˆæ˜¯éå¸¸é‡è¦çš„ï¼Œä»–æ˜¯ <code>Encoder</code> å’Œ <code>Decoder</code> æ˜¯èƒ½å¤Ÿè¯†åˆ«çš„ä¸€ä¸ªä»‹è´¨ï¼Œæ˜¯é“¾æ¥ä¸¤è€…çš„æ¡¥æ¢ã€‚è¿™ç§ä»‹è´¨å¯ä»¥æ˜¯ _éšçŠ¶æ€_ï¼Œå¯ä»¥æ˜¯ _æ³¨æ„åŠ›çš„åŠ æƒè®¡ç®—å€¼_ï¼Œç­‰ç­‰ï¼Œè¿™äº›éƒ½ç”±åº•å±‚çš„æ¨¡å‹æ¥å†³å®šçš„ã€‚</p>
<p>å°±å¥½æ¯”å›½é™…è´¸æ˜“ä¸­ï¼Œæˆ‘ä»¬æƒ³ä¹°æ¾³å¤§åˆ©äºšé“çŸ¿ã€‚ ç¾å…ƒæ˜¯ç¡¬é€šè´§ï¼Œä¸­é—´ä»‹è´¨ï¼ŒZG å’Œ åœŸæ¾³ éƒ½è®¤ç¾å…ƒï¼Œæ‰€ä»¥ ZG encoder å…ˆæŠŠ RMB è½¬æˆ Dollarï¼Œç»™åˆ°åœŸæ¾³ decoderï¼ŒåœŸæ¾³å†æ¢å›è‡ªå·±çš„ æ¾³å…ƒã€‚</p>
<p>ğŸ”¥ <strong>ä¸å®šé•¿</strong>ï¼Œè¾“å…¥å€¼ï¼ˆæ¯”å¦‚ï¼Œé•¿åº¦æ˜¯ 8ï¼‰åœ¨ <code>Encoder</code> éƒ½è½¬æ¢æˆç»Ÿä¸€çš„ <code>Context</code>ï¼ˆæ¯”å¦‚ï¼Œ128 X 512 çš„ 2 å±‚ç¥ç»ç½‘ç»œï¼‰ï¼ŒåŒæ—¶ è¾“å‡ºå€¼çš„é•¿åº¦ï¼ˆæ¯”å¦‚ï¼Œé•¿åº¦æ˜¯ 10 ï¼‰ ç”± <code>Decoder</code> å’Œ <code>Context</code>  æ¥å†³å®šï¼Œå·²ç»ä¸è¾“å…¥å€¼æ— å…³äº†ã€‚</p>
<p>åŒæ—¶ï¼Œ<code>seq2seq</code> ä»…ä»…æ˜¯ä¸Šå±‚æ¶æ„ï¼Œåº•å±‚å®ç°çš„æ¨¡å‹æ˜¯å•¥éƒ½å¯ä»¥è§†æƒ…å†µè€Œå®šã€‚æ¯”å¦‚ï¼Œåº•å±‚å¯ä»¥æ˜¯ <code>RNN</code>ï¼Œå¯ä»¥æ˜¯ <code>LSTM</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯ <code>GRU</code>ï¼Œ ä¹Ÿå¯ä»¥æ˜¯ <code>Transformer</code>ã€‚æœ¬æ–‡ä¾‹å­ä¸­ä½¿ç”¨ <code>RNN</code> æ¥å®ç°ã€‚</p>
<h2 id="ä¾‹å­-â€“-ç¿»è¯‘"><a href="#ä¾‹å­-â€“-ç¿»è¯‘" class="headerlink" title="ä¾‹å­ â€“ ç¿»è¯‘"></a>ä¾‹å­ â€“ ç¿»è¯‘</h2><blockquote>
<p>ä¸‹é¢æ˜¯æ‰‹å·¥å®ç°ä¸€ä¸ªåŸºäº <code>RNN</code> çš„ <code>seq2seq</code> æ¨¡å‹ã€‚å¯è¿è¡Œçš„ ipynb æ–‡ä»¶çš„<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/seq2seq.ipynb">é“¾æ¥</a>ã€‚</p>
</blockquote>
<h3 id="ä»»åŠ¡ç›®æ ‡"><a href="#ä»»åŠ¡ç›®æ ‡" class="headerlink" title="ä»»åŠ¡ç›®æ ‡"></a>ä»»åŠ¡ç›®æ ‡</h3><p>ä¾‹å­çš„ç›®æ ‡ï¼Œä»æœ‰é™çš„ç¿»è¯‘èµ„æ–™ä¸­ï¼Œè®­ç»ƒå‡ºç¿»è¯‘çš„é€»è¾‘ï¼Œå®ç°ä»è‹±æ–‡ç¿»è¯‘æˆæ³•æ–‡ã€‚</p>
<h3 id="åˆ†æä»»åŠ¡"><a href="#åˆ†æä»»åŠ¡" class="headerlink" title="åˆ†æä»»åŠ¡"></a>åˆ†æä»»åŠ¡</h3><blockquote>
<p>è¿™é‡Œå…ˆä¸è®¨è®ºå­—ç¬¦çš„å¤„ç†æµç¨‹ï¼ˆæ¸…æ´—å­—ç¬¦ï¼Œè¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ç­‰ï¼‰ï¼Œæ‰€æœ‰çš„æµç¨‹ç®€å•åŒ–ï¼Œä»…ä»…æ˜¯éªŒè¯æ¨¡å‹çš„ä½¿ç”¨ã€‚</p>
</blockquote>
<ol>
<li>ç¿»è¯‘æ˜¯ä¸€ä¸ªâ€œåˆ†ç±»â€ä»»åŠ¡</li>
<li>è¿™ä¸ªæ˜¯ä¸€ä¸ªä¸å®šé•¿çš„è¾“å…¥å’Œè¾“å‡ºçš„ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>seq2seq</code> çš„æ¨¡å‹</li>
<li>åŒæ—¶è¾“å…¥å’Œè¾“å‡ºæ˜¯æœ‰æ—¶é—´åºåˆ—çš„ï¼Œæ‰€ä»¥åº•å±‚æ¨¡å‹ä½¿ç”¨å¸¦æœ‰è®°å¿†èƒ½åŠ›çš„æ¨¡å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>RNN</code></li>
</ol>
<p>â“ ä¸ºä»€ä¹ˆæ˜¯ä¸€ä»½åˆ†ç±»çš„ä»»åŠ¡ï¼Ÿ<br>è¿™å…¶å®æ˜¯ <code>word2index</code> çš„è¿‡ç¨‹ï¼Œæ¯ä¸ª <code>word</code> å°±æ˜¯ä¸€ä¸ªåˆ†ç±»ã€‚ä¸¾ä¾‹ï¼šæ¯”å¦‚ è¾“å…¥çš„æ˜¯è‹±æ–‡ï¼Œè‹±æ–‡ä¸­çš„ä¸€å…±æœ‰ 4000 ä¸ªå•è¯ï¼Œé‚£ä¹ˆè¾“å…¥çš„åˆ†ç±»å°±æ˜¯ 4000 ï¼›è¾“å‡ºçš„æ˜¯æ³•æ–‡ï¼Œæ³•æ–‡ä¸­çš„ä¸€å…±æœ‰ 2000 ä¸ªå•è¯ï¼Œé‚£ä¹ˆè¾“å‡ºçš„åˆ†ç±»å°±æ˜¯ 2000ã€‚</p>
<h3 id="ä»£ç ç»“æ„"><a href="#ä»£ç ç»“æ„" class="headerlink" title="ä»£ç ç»“æ„"></a>ä»£ç ç»“æ„</h3><p><img src="https://qiniu.oldzhangtech.com/mdpic/efa06cc1-1371-4e15-a0fd-0e5505739279_54099b97-f43c-47fc-ab0a-7f855bc6ad50.jpeg"><br>ä¸Šå›¾æ˜¯ æ•°æ®åœ¨ seq2seq æµåŠ¨ä¸­ä¸²èµ·ä¸åŒç»„ä»¶çš„è¿‡ç¨‹ã€‚</p>
<p><em>ç»„ä»¶è¯´æ˜ï¼š</em>   </p>
<ol>
<li><code>word_index</code>ï¼Œå°±æ˜¯æŠŠå•è¯è½¬æ¢æˆ <code>index</code></li>
<li><code>embedding</code>ï¼Œå°±è¦æŠŠç¦»æ•£çš„ <code>index</code> è½¬æ¢æˆå¯ä»¥è®¡ç®—çš„è¿ç»­çš„ <code>embedding</code>ï¼Œé€‚åˆæ¨¡å‹çš„è®¡ç®—</li>
<li><code>word_index</code> å’Œ <code>embedding</code> æ­£å¸¸æƒ…å†µæ˜¯ è¾“å…¥å’Œè¾“å‡ºéƒ½ä¸èƒ½å…±ç”¨çš„</li>
<li><code>encoder</code> é‡Œé¢æœ‰ <code>embedding</code>ï¼Œ<code>rnn</code><ol>
<li><code>rnn</code> è¾“å…¥ <code>src</code>ï¼Œ è¾“å‡º <code>hidden</code> éšçŠ¶æ€ï¼Œå³ <code>Context</code></li>
</ol>
</li>
<li><code>decoder</code> é‡Œé¢æœ‰ <code>embedding</code>ï¼Œ<code>rnn</code>ï¼Œ<code>full_connect</code><ol>
<li><code>rnn </code><strong>å¾ªç¯</strong>å åŠ è¾“å…¥ <code>tgt_input</code> å’Œ <code>Context</code>ï¼Œ è¾“å‡º <code>new hidden</code>,  <code>tgt_output</code></li>
<li><code>full_connect</code> è´Ÿè´£æŠŠ <code>tgt_output</code> ç”ŸæˆçœŸæ­£çš„ <code>real_tgt_ouput</code><blockquote>
<p>äº†è§£ä»–ä»¬çš„å…·ä½“èŒè´£åå†å»çœ‹ä»–ä»¬çš„ä»£ç å°±æ¸…æ™°å¤šäº†</p>
</blockquote>
</li>
</ol>
</li>
</ol>
<p><em>ä»£ç ç‰‡æ®µåˆ†æ</em>  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define the Encoder RNN</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EncoderRNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_size, hidden_size</span>):</span><br><span class="line">        <span class="built_in">super</span>(EncoderRNN, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = hidden_size</span><br><span class="line">        <span class="variable language_">self</span>.embedding = nn.Embedding(input_size, hidden_size)</span><br><span class="line">        <span class="variable language_">self</span>.rnn = nn.RNN(hidden_size, hidden_size, batch_first=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, input_seq, hidden</span>):</span><br><span class="line">        <span class="comment"># å†…éƒ¨è¿›è¡Œ embedding</span></span><br><span class="line">        <span class="comment"># ä¼ å…¥çš„æ˜¯ input_indices</span></span><br><span class="line">        embedded = <span class="variable language_">self</span>.embedding(input_seq)</span><br><span class="line">        output, hidden = <span class="variable language_">self</span>.rnn(embedded, hidden)</span><br><span class="line">        <span class="keyword">return</span> output, hidden</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_hidden</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> torch.zeros(<span class="number">1</span>, <span class="number">1</span>, <span class="variable language_">self</span>.hidden_size)</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¯ <code>encoder</code> çš„ä»£ç ï¼Œä½œç”¨å°±æ˜¯ï¼š</p>
<ol>
<li><code>src_input</code> è½¬æˆ <code>embedding</code></li>
<li><code>rnn</code> æŠŠ <code>embedding</code> è½¬æˆ <code>hidden</code>ï¼Œå³ <code>Context</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define the Decoder RNN</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecoderRNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, hidden_size, output_size</span>):</span><br><span class="line">        <span class="built_in">super</span>(DecoderRNN, ).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = hidden_size</span><br><span class="line">        <span class="variable language_">self</span>.embedding = nn.Embedding(output_size, hidden_size)</span><br><span class="line">        <span class="variable language_">self</span>.rnn = nn.RNN(hidden_size, hidden_size, batch_first=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.out = nn.Linear(hidden_size, output_size)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, input_seq, hidden</span>):</span><br><span class="line">        <span class="comment"># å†…éƒ¨è¿›è¡Œ embedding</span></span><br><span class="line">        <span class="comment"># ä¼ å…¥çš„æ˜¯ input_indices</span></span><br><span class="line">        embedded = <span class="variable language_">self</span>.embedding(input_seq)</span><br><span class="line">        output, hidden = <span class="variable language_">self</span>.rnn(embedded, hidden)</span><br><span class="line">        <span class="comment"># å°±æ˜¯ å…¨é“¾æ¥å±‚ ä» hidden -ã€‹ output_feature</span></span><br><span class="line">        output = <span class="variable language_">self</span>.out(output.squeeze(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> output, hidden</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_hidden</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> torch.zeros(<span class="number">1</span>, <span class="number">1</span>, <span class="variable language_">self</span>.hidden_size)</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¯ <code>dncoder</code> çš„ä»£ç ï¼Œä¸ <code>encoder </code>æ¯”è¾ƒå¤šäº†ä¸€ä¸ª <code>full connect</code> ä½¿ç”¨</p>
<ol>
<li><code>tgt_input</code> è½¬æˆ <code>embedding</code></li>
<li><code>rnn</code> æŠŠ <code>embedding</code> è½¬æˆ <code>hidden</code> å’Œ <code>output</code></li>
<li><code>full conect </code>å†æŠŠ <code>output</code> è½¬æˆ <code>output_feature</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define the Seq2Seq model</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Seq2Seq</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, encoder, decoder</span>):</span><br><span class="line">        <span class="built_in">super</span>(Seq2Seq, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># [1]</span></span><br><span class="line">        <span class="variable language_">self</span>.encoder = encoder</span><br><span class="line">        <span class="variable language_">self</span>.decoder = decoder</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, src_seq, tgt_seq, teacher_forcing_ratio=<span class="number">0.5</span></span>):</span><br><span class="line">        batch_size = src_seq.size(<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># count of words [[0, 1, 2, 9]]</span></span><br><span class="line">        max_len = tgt_seq.size(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 11</span></span><br><span class="line">        tgt_vocab_size = <span class="variable language_">self</span>.decoder.out.out_features</span><br><span class="line">        <span class="comment"># æœ‰ 11 ä¸ªéšçŠ¶æ€ï¼Œå°±æ˜¯ target ä¸­çš„å”¯ä¸€å€¼</span></span><br><span class="line">        outputs = torch.zeros(batch_size, max_len, tgt_vocab_size)</span><br><span class="line">        </span><br><span class="line">        encoder_hidden = <span class="variable language_">self</span>.encoder.init_hidden()</span><br><span class="line">        <span class="comment"># encoder çš„ä½œç”¨æ˜¯ è¾“å‡º hiddenï¼Œ output å°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰äº†</span></span><br><span class="line">        <span class="comment"># [2]</span></span><br><span class="line">        encoder_output, encoder_hidden = <span class="variable language_">self</span>.encoder(src_seq, encoder_hidden)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># tgt_seq ä½œç”¨ï¼Œå°±æ˜¯å–å¾—ç¬¬ä¸€ä¸ª &lt;sos&gt; token</span></span><br><span class="line">        decoder_input = tgt_seq[:, <span class="number">0</span>].unsqueeze(<span class="number">1</span>)  <span class="comment"># Start with &lt;sos&gt;</span></span><br><span class="line">        decoder_hidden = encoder_hidden</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># tgt_seq ä½œç”¨ï¼Œæˆªå–è¾“å‡ºçš„é•¿åº¦</span></span><br><span class="line">        <span class="comment"># ä¸å– 0ï¼Œæ˜¯å› ä¸º â€œ0â€œ index æ˜¯ä¸€ä¸ª &lt;sos&gt;</span></span><br><span class="line">        <span class="comment"># [3]</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, max_len):</span><br><span class="line">            <span class="comment"># [4]</span></span><br><span class="line">            decoder_output, decoder_hidden = <span class="variable language_">self</span>.decoder(decoder_input, decoder_hidden)</span><br><span class="line">            <span class="comment"># decoder_output shape (1,11)ï¼Œå…¶å®æ˜¯ä¸€ä¸ªå¤šåˆ†ç±»çš„é—®é¢˜</span></span><br><span class="line">            <span class="comment"># ä¸ outputs[:, t] = decoder_output æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸º batch_size æ’ç­‰äº 1ï¼Œæ‰€ä»¥æš‚æ—¶å½±å“ä¸å¤§ï¼Œä½†æ˜¯å®é™…åº”ç”¨ä¸­ï¼Œåº”è¯¥è¦æ”¹æˆå¯¹åº”çš„ batch</span></span><br><span class="line">            outputs[:, t, :] = decoder_output</span><br><span class="line">            top1 = decoder_output.argmax(<span class="number">1</span>).unsqueeze(<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># è¿™é‡Œæ˜¯å–å·§äº†ï¼Œteacher_forcing_ratio æ˜¯å–å·§äº†ã€‚</span></span><br><span class="line">            <span class="comment"># decode_input_t+1 æœ‰æ—¶æ˜¯ decode_output_tï¼Œ æœ‰æ—¶æ˜¯ real_target_seq_t</span></span><br><span class="line">            <span class="comment"># [5]</span></span><br><span class="line">            decoder_input = tgt_seq[:, t].unsqueeze(<span class="number">1</span>) <span class="keyword">if</span> random.random() &lt; teacher_forcing_ratio <span class="keyword">else</span> top1</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç æ˜¯ <code>seq2seq</code> æ¨¡å‹çš„å®šä¹‰ã€‚</p>
<p><em>è®­ç»ƒè¿‡ç¨‹</em><br>å¯ä»¥æ£€æŸ¥æ•°æ®åœ¨è¿™ä¸ªæ¨¡å‹ä¸­æµåŠ¨å¦‚ä¸‹ï¼š</p>
<ol>
<li>[1] é‡Œé¢åŒ…å«äº†ä¸€ä¸ª <code>encoder</code> å’Œ <code>decoder</code></li>
<li>[2] <code>forword</code> æ—¶,  <code>encoder</code> è½¬æ¢ <code>src_input</code> æˆ <code>hidden</code></li>
<li>[3] å¼€å§‹ <code>decoder</code> å¾ªç¯ï¼Œæœ€å¤§é•¿åº¦æ˜¯ <code>max_len</code>ã€‚åˆå§‹åŒ–å³æ˜¯ï¼š <code>decoder_input = â€œ&lt;sos&gt; indexâ€œ</code>ï¼Œ<code>decoder_hidden = encoder_hidden</code></li>
<li>[4] <code>decoder</code> è¾“å‡ºæ˜¯ <code>output_index</code> + <code>new_hidden</code></li>
<li>[5] <code>decoder_input+= output_index</code>, <code>decoder_hidden += new_hidden</code> å åŠ åå†èµ°æ­¥éª¤ [3] å¾ªç¯</li>
</ol>
<p>ğŸ’¡ <code>teacher_forcing</code> æ˜¯ä»€ä¹ˆï¼Ÿ<br>å°±æ˜¯è®­ç»ƒçš„æ—¶å€™ï¼Œæœ‰ä¸€å®šçš„æ¦‚ç‡è¾“å‡ºæ˜¯ <em>çœŸå®å€¼</em> è€Œä¸æ˜¯ _é¢„æµ‹å€¼_ã€‚å°±èƒ½æ˜¯æ¨¡å‹æ›´åŠ å¿«çš„æ”¶æ•›ï¼ŒåŠ é€Ÿæ¨¡å‹çš„å­¦ä¹ ã€‚ä½†æ˜¯è¿‡äºä¾èµ– _çœŸå®å€¼_ï¼Œå°±ä¼šå¯¼è‡´æ³›åŒ–èƒ½åŠ›å·®ã€‚<code>teacher_forcing_ratio</code> å°±å¯ä»¥è°ƒæ•´é˜ˆå€¼ã€‚</p>
<p><em>æ¨ç†è¿‡ç¨‹</em>  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">input_seq = torch.tensor(indices, dtype=torch.long).unsqueeze(<span class="number">0</span>)  <span class="comment"># (1, seq_len)</span></span><br><span class="line"><span class="comment"># å…¨éƒ¨çš„inputï¼Œéƒ½è½¬æˆ hidden</span></span><br><span class="line">encoder_hidden = model.encoder.init_hidden()</span><br><span class="line"><span class="comment"># encoder å’Œ decoder çš„ä½¿ç”¨æ˜¯åˆ†å¼€çš„ã€</span></span><br><span class="line"><span class="comment"># [1]</span></span><br><span class="line">encoder_output, encoder_hidden = model.encoder(input_seq, encoder_hidden)</span><br><span class="line"><span class="comment"># [2]</span></span><br><span class="line">decoder_input = torch.tensor([[fra_word2idx[<span class="string">&#x27;&lt;sos&gt;&#x27;</span>]]], dtype=torch.long)  <span class="comment"># Start token</span></span><br><span class="line">decoder_hidden = encoder_hidden</span><br><span class="line"></span><br><span class="line">translated_sentence = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># [3]</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(max_length):</span><br><span class="line">    <span class="comment"># decoder_input æ˜¯é€æ­¥çš„ç´¯åŠ çš„ï¼Œå°±æ˜¯ word1+word2+word3...</span></span><br><span class="line">    <span class="comment"># ç¬¬ä¸€ä¸ª decoder_hidden æ˜¯ encoder_hidden</span></span><br><span class="line">    <span class="comment"># ä»ç¬¬äºŒä¸ªå¼€å§‹ï¼Œå°±æ˜¯å¾ªç¯å¾—åˆ° decoder_hidden ä¸åœçš„ä¼ å…¥</span></span><br><span class="line">    <span class="comment"># encoder å’Œ decoder çš„ä½¿ç”¨æ˜¯åˆ†å¼€çš„</span></span><br><span class="line">    <span class="comment"># [4]</span></span><br><span class="line">    decoder_output, decoder_hidden = model.decoder(decoder_input, decoder_hidden)</span><br><span class="line">    top1 = decoder_output.argmax(<span class="number">1</span>).item()</span><br><span class="line">    <span class="comment"># &quot;&lt;UNK&gt;&quot;, which stands for â€œunknown.â€</span></span><br><span class="line">    <span class="comment"># [5]</span></span><br><span class="line">    translated_word = fra_idx2word.get(top1, <span class="string">&quot;&lt;UNK&gt;&quot;</span>)</span><br><span class="line">    translated_sentence.append(translated_word)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># [6]</span></span><br><span class="line">    <span class="keyword">if</span> translated_word == <span class="string">&#x27;&lt;eos&gt;&#x27;</span>:  <span class="comment"># End of sentence</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    decoder_input = torch.tensor([[top1]], dtype=torch.long)  <span class="comment"># Next input token</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> translated_sentence</span><br></pre></td></tr></table></figure>
<p><em>æ¨ç†è¿‡ç¨‹</em> å’Œ _è®­ç»ƒè¿‡ç¨‹_ï¼Œå…·ä½“åŸç†ä¸€è‡´ã€‚ æœ‰ä»¥ä¸‹çš„å·®å¼‚ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li>å¦‚ä½•å®šä¹‰å¼€å§‹è¾“å‡ºçš„æ ‡å¿—</li>
<li>å¦‚ä½•å®šä¹‰ç»“æŸè¾“å‡ºçš„æ ‡å¿—</li>
<li>å¦‚ä½•å®šä¹‰ä¸è®¤è¯†å­—ç¬¦çš„æ ‡å¿—</li>
</ol>
<p>ä»£ç åˆ†æï¼š</p>
<ol>
<li>[1] å•ç‹¬ä½¿ç”¨ <code>seq2seq&#39;s encoder</code>ï¼Œä¸” <em>ä¸€æ¬¡æ€§</em> ç”Ÿæˆ <code>encoder hidden</code></li>
<li>[2] <code>decoder_input</code> åˆå§‹åŒ–ï¼Œä»¥  â€˜<sos>â€˜ å¼€å¤´ï¼Œæ ‡å¿—å¼€å§‹è¾“å‡º</li>
<li>[3] <code>decoder</code> å¼€å§‹å¾ªç¯<ol>
<li>[4] å•ç‹¬ä½¿ç”¨ <code>seq2seq&#39;s decoder</code>, è¾“å‡º <code>ouput </code>å’Œ <code>new_hidden</code></li>
<li>[5] ç¢°åˆ°ä¸è®¤è¯†çš„åˆ†ç±»ï¼Œå°±ä½¿ç”¨ â€˜<UNK>â€˜å–ä»£</li>
<li>[6] å¦‚æœé‡åˆ° â€˜<eos>â€˜ å­—ç¬¦å°±ç›´æ¥ç»“æŸå¾ªç¯</li>
<li>å›åˆ° [3] ç»§ç»­å¾ªç¯</li>
</ol>
</li>
</ol>
<h3 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®­ç»ƒç»“æœ</span></span><br><span class="line">Epoch: <span class="number">0</span>, Loss: <span class="number">2.820215034484863</span></span><br><span class="line">Epoch: <span class="number">100</span>, Loss: <span class="number">1.0663029670715332</span></span><br><span class="line">Epoch: <span class="number">200</span>, Loss: <span class="number">1.1840879678726197</span></span><br><span class="line">Epoch: <span class="number">300</span>, Loss: <span class="number">1.224123215675354</span></span><br><span class="line">Epoch: <span class="number">400</span>, Loss: <span class="number">1.0645174384117126</span></span><br><span class="line">Epoch: <span class="number">500</span>, Loss: <span class="number">1.061875820159912</span></span><br><span class="line">Epoch: <span class="number">600</span>, Loss: <span class="number">1.0744179487228394</span></span><br><span class="line">Epoch: <span class="number">700</span>, Loss: <span class="number">1.0767890691757203</span></span><br><span class="line">Epoch: <span class="number">800</span>, Loss: <span class="number">1.099305510520935</span></span><br><span class="line">Epoch: <span class="number">900</span>, Loss: <span class="number">1.1019723176956178</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„æµ‹</span></span><br><span class="line">test_sentence = [<span class="string">&quot;i&quot;</span>, <span class="string">&quot;am&quot;</span>]</span><br><span class="line">translation = translate(model, test_sentence)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Translation:&quot;</span>, <span class="string">&quot; &quot;</span>.join(translation))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Translation: nous sommes &lt;eos&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li><code>seq2seq</code> æ˜¯ä¸€ç§ä¸Šå±‚æ¨¡å‹æ¶æ„ï¼Œåº”å¯¹è¾“å…¥å’Œè¾“å‡º<strong>ä¸å®šé•¿</strong>çš„åœºæ™¯</li>
<li><code>seq2seq</code> åº•å±‚å¯ä»¥ç”±<strong>ä¸åŒ</strong>çš„æ¨¡å‹æ„æˆ</li>
<li><code>seq2seq</code> çš„ <code>Context</code> æ˜¯ä¿å­˜äº†<strong>ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ï¼Œæ˜¯ <code>encoder</code> å’Œ <code>decoder</code> éƒ½å¿…é¡»èƒ½è¯†åˆ«çš„æ ¼å¼</li>
</ol>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
      <categories>
        <category>å­¦è‚¥AI</category>
      </categories>
      <tags>
        <tag>å­¦è‚¥AI</tag>
        <tag>seq2seq</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰‹å†™ Attention æ³¨æ„åŠ›æœºåˆ¶ åŠç†è§£</title>
    <url>/2024/08/16/%5B%E5%AD%A6%E8%82%A5AI%5D%20%E6%89%8B%E5%86%99%20Attention%20%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6%20%E5%8F%8A%E7%90%86%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯é—®é¢˜"><a href="#èƒŒæ™¯é—®é¢˜" class="headerlink" title="èƒŒæ™¯é—®é¢˜"></a>èƒŒæ™¯é—®é¢˜</h2><p><code>RNN</code> å’Œ å„ç§å˜ä½“ <code>RNN</code> ä¸­ <code>LSTM</code>&#x2F;<code>GRU</code> éƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•è§£å†³ é•¿è·ç¦»ä¿¡æ¯çš„æ„ŸçŸ¥ã€‚<code>RNN</code> çš„è§£å†³åŠæ³•æ˜¯åŠ å¤§ <code>sequence</code>ï¼Œæ›´é•¿çš„çª—å£è®°å¾—æ›´åŠ ä¹…è¿œçš„ä¿¡æ¯ï¼›<code>LSTM</code> å’Œ <code>GRU</code> å°±æ˜¯æŠŠè®°å¿†è®¾ç½®æˆä¸åŒçš„æƒé‡ï¼Œå¯¹é‡è¦çš„ä¿¡æ¯åŠ å¤§æƒé‡ã€‚<code>Attention</code> åˆæ˜¯å¦å¤–ä¸€ä¸ªè§’åº¦ï¼Œå»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="Attention-æ˜¯ä»€ä¹ˆ"><a href="#Attention-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Attention æ˜¯ä»€ä¹ˆ"></a>Attention æ˜¯ä»€ä¹ˆ</h2><p><code>Attention</code> ä¸­æ–‡æ˜¯æ³¨æ„åŠ›æœºåˆ¶ï¼Œæ˜¯å¯¹æŸä¸ªäº‹ç‰©çš„æŸéƒ¨åˆ†çš„å…³æ³¨ç‚¹ã€‚</p>
<p>ä»äººè„‘çš„è§’åº¦æƒ³ï¼Œæ—¶é—´å’Œèµ„æºéƒ½æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥åªèƒ½åœ¨ä¸€å®šçš„é™åº¦å†…å»å…³æ³¨æŸäº›éƒ¨åˆ†ã€‚æ¯”å¦‚çœ‹åˆ°ä¸€ç¾¤äººçš„ç…§ç‰‡ï¼Œæˆ‘ä»¬è‡ªç„¶å»æ‰¾ç¾å¥³ï¼›çœ‹ä¸€ä¸ªç¾å¥³çš„ç…§ç‰‡ï¼Œæˆ‘ä»¬è‡ªç„¶å»çœ‹ç¾å¥³çš„çœ¼ç›ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆä¼šä¸è‡ªä¸»çš„å»çœ‹è¿™äº›éƒ¨åˆ†è€Œä¸æ˜¯çœ‹å…¨æ™¯å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çš„æ³¨æ„åŠ›èµ„æºæ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬åªå¯¹å…³æ³¨ç‚¹é«˜çš„éƒ¨åˆ†æ„Ÿå…´è¶£ã€‚<br>è¿™æ˜¯å±äºåœ¨æˆ‘ä»¬äººè„‘é‡Œé¢çš„æ³¨æ„åŠ›æœºåˆ¶ã€‚<br>ä»æ¨¡å‹çš„è§’åº¦æƒ³ï¼Œç”¨æ•°å­¦å°†ä»–ä»¬å»ºæ¨¡ï¼Œä»–ä»¬åº”è¯¥æ˜¯æ³¨æ„åŠ›å¾—åˆ†æœ€é«˜çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æ¨¡å‹å¯ä»¥é‡ç‚¹å…³æ³¨çš„åœ°æ–¹ã€‚</p>
<p>æ€»ç»“ï¼Œä¸Šè¿°å°±æ˜¯ <code>Attention Score</code> çš„åŸºæœ¬çš„ç†è§£ã€‚è°å¾—åˆ†é«˜ï¼Œè°å°±å¯ä»¥å¾—åˆ°æ›´åŠ å¤šçš„å…³æ³¨ã€‚</p>
<p>ä¸‹é¢æŠŠ <code>Attention Score</code> ç”¨åœ¨ä¸€æ®µè¯çš„ç†è§£ä¸Šã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ä¸€å¥è¯ä½œä¸ºä¾‹å­ï¼šå§šæ˜ï¼Œä»–çˆ¸æœ‰ 2 ç±³é«˜ï¼Œä»–ä»å°çš„æ•°å­¦æˆç»©å¹¶ä¸å¥½ï¼Œç»å¸¸æ—·è¯¾ï¼Œä»–çˆ±åƒè‹¹æœï¼Œä»–è¡€å‹æ˜¯ Aã€‚çˆ±ç©æ¸¸æˆï¼Œä»–æœ€å–œæ¬¢çš„æ¸¸æˆå°±æ˜¯å¡å°”è¾¾ä¼ è¯´ï¼Œä»–è¿˜ç»å¸¸é€ƒè¯¾å»ç©ï¼›æœ‰æ—¶å€™ä»–ä¼šæ‰“ä¸€ä¸‹ç¯®çƒå’Œå…µä¹“çƒï¼Œä»–æœ€å–œæ¬¢çš„è¿åŠ¨æ˜¯è·‘æ­¥ã€‚ä»–ç°åœ¨èº«é«˜æ˜¯ 2.13 ç±³ï¼Œä½“é‡æ˜¯ 200 æ–¤ï¼Œé‹å­è¦ç©¿ 48 ç çš„ã€‚<br>è¯·é—®ï¼šä»–ä¸ºä»€ä¹ˆå¯ä»¥é•¿è¿™ä¹ˆé«˜ã€‚</p>
<p>ä»äººè„‘çš„è§’åº¦ï¼Œâ€œå§šæ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜â€ï¼Œå¾ˆè‡ªç„¶çš„æƒ³åˆ°ï¼Œä»–çˆ¶æ¯é«˜ï¼ŒåŸºå› å¥½ã€‚ä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªåˆ¤æ–­ï¼Œæ˜¯å› ä¸ºé—®é¢˜ï¼Œå’Œ â€œçˆ¶æ¯é«˜â€è¿™ä¸ªä¿¡æ¯æ˜¯ <strong>å…³è”åº¦æœ€é«˜</strong>çš„ã€‚<br>ä»æ¨¡å‹çš„è§’åº¦æƒ³ï¼Œç”¨æ•°å­¦å°†ä»–ä»¬å»ºæ¨¡ï¼Œå³ <em>é—®é¢˜</em> å’Œ <em>ä¿¡æ¯çš„æŸä¸ªéƒ¨åˆ†</em> ï¼Œè®¡ç®—çš„<code>Score</code> å¾—åˆ†æœ€é«˜ï¼Œæ‰€ä»¥ä»–ä»¬çš„å…³è”åº¦æœ€é«˜ï¼Œå³ä»–ä»¬å…·æœ‰é€»è¾‘ç›¸å…³æ€§ã€‚</p>
<p>æ€»ç»“ï¼Œ<code>Attention æœºåˆ¶</code> åœ¨è‡ªç„¶è¯­è¨€ç†è§£ä¸Šï¼Œå³ç›¸äº’çš„ <code>Score</code> è¶Šé«˜åˆ†ï¼Œå³ç›¸äº’çš„å…³è”æ€§å°±è¶Šå¤§ï¼Œå³ä»–ä»¬å…·æœ‰é€»è¾‘æ€§ã€‚</p>
<blockquote>
<p>é¢˜å¤–è¯ï¼š è¿™ä¸ªæœ‰ç‚¹åƒ <strong>é€»è¾‘</strong>ã€‚<br>æˆ‘ä»¬å¤§è„‘æ˜¯ç¥ç»å…ƒæ„æˆçš„ã€‚ç¥ç»å…ƒï¼Œå³æ˜¯ ç»™ä¸€ä¸ªé«˜ç”µå¹³å°±æ˜¯ 1 ï¼Œç»™ä¸€ä¸ªä½ç”µå¹³å°±æ˜¯ 0 çš„è§¦è§’ï¼›è¿™ä¸ªè§¦è§’ï¼Œåˆå¯ä»¥è§¦å‘å¦å¤–çš„ç¥ç»å…ƒã€‚è¿™ç§å°±æ˜¯ â€œä¸€ç”ŸäºŒï¼ŒäºŒç”Ÿä¸‰ï¼Œä¸‰ç”Ÿä¸‡ç‰©â€çš„ä½“ç°ã€‚å› ä¸ºè¿™ç§è§¦è§’çš„è§¦å‘ï¼Œå°±åœ¨æˆ‘ä»¬çš„å¤§è„‘é‡Œé¢å½¢æˆäº† <strong>é€»è¾‘</strong>ã€‚<br><code>Attention Score</code>ï¼Œæœ‰å¯èƒ½æ„æˆäº†æ¨¡å‹é¢†åŸŸä¸­çš„ _åŸºç¡€è§¦è§’_ï¼Œæœ€åå½¢æˆäº†æ¨¡å‹é¢†åŸŸä¸­ <strong>é€»è¾‘</strong>ã€‚</p>
</blockquote>
<h2 id="åˆ†æ¦‚å¿µè®²è§£"><a href="#åˆ†æ¦‚å¿µè®²è§£" class="headerlink" title="åˆ†æ¦‚å¿µè®²è§£"></a>åˆ†æ¦‚å¿µè®²è§£</h2><p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥ç®€å•çš„æ¢³ç†å‡º <code>Attention æœºåˆ¶</code>ã€‚ä½†æ˜¯è½åˆ°ç»†èŠ‚é‡Œé¢ï¼Œ<code>Attention Score</code> æ€ä¹ˆè®¡ç®—ï¼Œå°±æ˜¯ä»å®é™…çš„æ•°å­¦æ¨¡å‹çš„è§’åº¦å»è¯´æ˜äº†ã€‚ä¸‹é¢å°± <code>Attention Score</code> æ€ä¹ˆå»è®¡ç®—ä¸ºçº¿å¤´ï¼Œæ¥è®²è§£ä¸åŒæ¦‚å¿µã€‚</p>
<blockquote>
<p>ä¸‹é¢æ˜¯ä¸€æ­¥ä¸€æ­¥çš„è¯´æ˜ Attention æœºåˆ¶ çš„å„ç§ç»„ä»¶ï¼Œå’Œä»–ä»¬èƒ½å¤Ÿè§£å†³åˆ°ä»€ä¹ˆé—®é¢˜ã€‚</p>
</blockquote>
<h3 id="QKV-æœºåˆ¶"><a href="#QKV-æœºåˆ¶" class="headerlink" title="QKV æœºåˆ¶"></a>QKV æœºåˆ¶</h3><blockquote>
<p>Query Key Value</p>
</blockquote>
<p>å¦‚æœå¯¹ä¸Šè¿°çš„é‚£å¥è¯åˆ†æˆä¸åŒçš„ç‰‡æ®µï¼šâ€œä»–çˆ¸æœ‰ 2 ç±³é«˜â€ seg1ï¼Œâ€œä»–ä»å°çš„æ•°å­¦æˆç»©å¹¶ä¸å¥½â€ seg2ï¼Œâ€œç»å¸¸æ—·è¯¾â€ seg3ï¼Œâ€œä»–çˆ±åƒè‹¹æœâ€ seg4ï¼Œâ€œä»–è¡€å‹æ˜¯ Aâ€ seg5ï¼Œæ¯ä¸ªç‰‡æ®µéƒ½æºå¸¦äº†ä¸€å®šé‡çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç»Ÿç§°ä»–ä»¬æºå¸¦çš„ä¿¡æ¯æ˜¯ <strong>éšçŠ¶æ€</strong> <strong>hidden</strong>ã€‚å¯¹åº”ç€ï¼Œç‰‡æ®µçš„éšçŠ¶æ€å°±æ˜¯ h1, h2â€¦h5ã€‚</p>
<p>é¢å¯¹ â€œå§šæ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜â€ é—®é¢˜çš„æ—¶å€™ï¼Œè‡ªç„¶çš„å°±è®¤ä¸º <code>seg1</code> çš„å…³è”æ€§æ˜¯æœ€é«˜çš„ã€‚ä½†æ˜¯å¦‚æœé¢å¯¹ â€œä»–ä¸‰è§’å‡½æ•°ä¸æ‡‚â€é—®é¢˜çš„æ—¶å€™ï¼Œæ˜¾ç„¶æ˜¯ <code>seg2</code> çš„å…³è”æ€§æ˜¯æœ€é«˜çš„ã€‚<br>æ‰€ä»¥çš„å‡ºï¼Œ åŒä¸€ä¸ª<code>query</code> å¯¹åº”ä¸åŒçš„ <code>segment</code> çš„ï¼Œæœ‰ä¸åŒçš„ <code>Attention Score</code>ï¼›ä¸åŒçš„ <code>query</code> éƒ½åº”è¯¥å¯¹ åŒä¸€æ‰¹çš„ <code>segment</code> æœ‰ä¸åŒçš„ <code>Attention Score</code>ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/27d4a47e-6390-46e1-9cfc-cf807a964c95_1b303e9c-fe57-42f2-80ce-1b15069c47fc.jpeg"><br>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå°±æ˜¯è¿çº¿çš„å®½åº¦ä¸åŒï¼Œæ˜¾ç¤ºäº† <code>query</code> å’Œ ä¸åŒ <code>segment</code> ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œå³ä¸åŒçš„å¾—åˆ†ã€‚</p>
<p>å¦‚æœåŸºäºä¼ ç»Ÿçš„ <code>RNN</code> å»è¡¨è¾¾ <code>Attention</code>ï¼Œæœ‰ä¸€å®šçš„å±€é™æ€§ã€‚ <code>RNN</code> çš„è®¡ç®—éšçŠ¶æ€ <code>hidden</code> éƒ½æ˜¯ä¸å˜çš„ï¼Œå³æ¯ä¸ªä¿¡æ¯ï¼ˆç‰‡æ®µï¼‰ä»…ä»…åªæœ‰ä¸€ä¸ªç»´åº¦ï¼Œåªæœ‰ä¸€ä¸ªå€¼ã€‚<br>æ‰€ä»¥ <code>Attention æœºåˆ¶</code> å°† <code>hidden</code> åˆ†æ‹†æˆ <code>key</code> å’Œ <code>value</code>ï¼Œä¸” <code>query</code> å¾ªç¯å’Œæ‰€æœ‰çš„ <code>key</code> å’Œ <code>value</code> è®¡ç®—åæ‰å¾—åˆ° <code>Score</code>ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/ed7f2a6d-58cc-4d66-ab04-87e683be4ded_b6102f89-59fd-47a1-94f4-4c0096fa84d4.jpeg"><br>ä¸Šå›¾ç®€åŒ–å‡ºæ¥çš„å…¬å¼å°±æ˜¯ <code>Attention Score</code> &#x3D; $Attention(QW^Q,KW^K,VW^V)$ ï¼Œå°±æ˜¯ <strong>æ³¨æ„åŠ›è¯„åˆ†å…¬å¼</strong> äº†ã€‚</p>
<p>è¿™ç§æŠŠ <code>hidden</code> æ‹†åˆ†æˆ <code>key</code> å’Œ <code>value</code>ï¼Œå¹¶ä¸”ç»“åˆ  <code>query</code> è®¡ç®—å°±æ˜¯ <code>QKV æœºåˆ¶</code>ï¼ˆ query key value æœºåˆ¶ï¼‰ã€‚</p>
<h3 id="å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶"><a href="#å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶" class="headerlink" title="å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶"></a>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶</h3><blockquote>
<p>Multiple Head Attention</p>
</blockquote>
<p>ä»ä¸Šè¿°çš„ <code>QKV æœºåˆ¶</code> çŸ¥é“ï¼Œ<code>query</code> å°±æ˜¯æ ¹æ®å…´è¶£ç‚¹ï¼Œè§¦å‘å¯¹ç‰‡æ®µè®¡ç®—è¯„åˆ†ã€‚<br>å¦‚æœä»…ä»…æ˜¯ä¸€ä¸ª <code>query</code>ï¼Œå…¶å®å’Œ å•ä¸€ä½¿ç”¨ <code>RNN hidden</code> æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼›ä½†æ˜¯å¦‚æœå¢åŠ å¤šå‡ ä¸ª <code>query</code>ï¼Œå°±å¯ä»¥å¯¹ä¿¡æ¯è¿›è¡Œä¸åŒç»´åº¦çš„åˆ†å±‚ï¼Œä¹Ÿå°±æ˜¯ <strong>å¤šå¤´</strong> çš„æ„æ€ã€‚</p>
<p>ğŸ”¥ å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼Œå°±æ˜¯å­—å¦‚å…¶åï¼Œå¤šä¸ª <code>head</code>ï¼Œå¤šä¸ª <code>query</code>ï¼› ä¸€ä¸ª <code>head</code> å°±æ˜¯ ä¸€ä¸ª <code>query</code>ã€‚</p>
<p>æ¯”å¦‚ï¼Œâ€œå§šæ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜â€ï¼Œâ€œä»–ä¸‰è§’å‡½æ•°ä¸æ‡‚â€ è¿™ä¸¤ä¸ª <code>query</code> éƒ½åŒæ—¶å¯¹åŸä¿¡æ¯è¿›è¡Œç»Ÿè®¡è¯„åˆ†ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸åŒ <code>segment</code> å¯¹åº”çš„ <code>Attention Score</code>ã€‚</p>
<p>ğŸ”¥ æœ‰ç‚¹åƒæ˜¯  <code>CNN</code> çš„å·ç§¯æ ¸ï¼Œå¯ä»¥æŠ½å–ä¸åŒçš„ç‰¹å¾ç»´åº¦ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/d759a94d-fe06-4a2c-baee-e3600f458cd8_389bd982-7410-49f2-9f81-577b6901d74c.jpeg"><br><code>query</code>, <code>key</code>, <code>value</code> å› ä¸ºä¸åŒçš„ <code>head</code> éƒ½å¸¦æœ‰è‡ªå·±çš„ï¼ˆ$W^Q W^K W^V$ï¼‰ çŸ©é˜µè¿›è¡Œå­¦ä¹ ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå¸¦æ¥æ›´åŠ å¤šçš„å­¦ä¹ æ€§ã€‚</p>
<h3 id="è‡ªæ³¨æ„åŠ›æœºåˆ¶"><a href="#è‡ªæ³¨æ„åŠ›æœºåˆ¶" class="headerlink" title="è‡ªæ³¨æ„åŠ›æœºåˆ¶"></a>è‡ªæ³¨æ„åŠ›æœºåˆ¶</h3><blockquote>
<p>Self Attention</p>
</blockquote>
<p>æœ‰æ—¶å€™ï¼Œä¸€å¥è¯ä¸­ï¼Œå·²ç»è•´å«äº†é€»è¾‘ã€‚æ¯”å¦‚ä¸Šé¢çš„â€œå§šæ˜æè¿°â€ï¼Œå°±ç®—æ²¡æœ‰æé—®ï¼Œéƒ½å¯ä»¥ä»è‡ªèº«çš„å¥å­ä¸­å»ºç«‹äº†å…³è”ã€‚</p>
<p>æ¯”å¦‚ï¼Œâ€œä»–ä»å°çš„æ•°å­¦æˆç»©å¹¶ä¸å¥½â€ <code>seg2</code> å’Œ â€œç»å¸¸æ—·è¯¾â€ <code>seg3</code>ï¼Œä»–ä»¬ä¸¤ä¸ªç‰‡æ®µå°±æœ‰éå¸¸å¼ºçš„ç›¸å…³æ€§ï¼Œä»–ä»¬ <code>Attention Score</code> çš„å¾—åˆ†å°±é«˜ï¼›åŒç†â€œç»å¸¸æ—·è¯¾â€ <code>seg3</code>ï¼Œâ€œä»–çˆ±åƒè‹¹æœâ€ <code>seg4</code>ï¼Œä»–ä»¬çš„å¾—åˆ†å°±ä¸é«˜ã€‚</p>
<p>ğŸ”¥ æ‰€ä»¥å½“ <code>Query Key Value</code> éƒ½æ˜¯è‡ªå·±çš„ï¼Œå°±æ˜¯ <strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong>ï¼Œå¯¹è‡ªå·±çš„ä¿¡æ¯ç‰‡æ®µå»ºç«‹ <code>Attention Score</code>ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/0cdf99e8-066b-4390-a980-6c5ac39ce0b2_e1aab5d8-ebd1-4c02-8f37-6bed0a48f488.jpeg"><br>ä¸Šå›¾å¯ä»¥çŸ¥é“ï¼Œè¶Šç²—çš„çº¿ï¼Œå°±æ˜¯ä»–ä»¬çš„ <code>attention score</code> æ›´åŠ çš„é«˜åˆ†ï¼›ä¸”è¿™æ˜¯è‡ªèº«ç‰‡æ®µå’Œç‰‡æ®µä¹‹é—´çš„è¯„åˆ†ã€‚å°±æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„ä½“ç°ã€‚</p>
<h3 id="æ³¨æ„åŠ›å¾—åˆ†ä»£ç éƒ¨åˆ†"><a href="#æ³¨æ„åŠ›å¾—åˆ†ä»£ç éƒ¨åˆ†" class="headerlink" title="æ³¨æ„åŠ›å¾—åˆ†ä»£ç éƒ¨åˆ†"></a>æ³¨æ„åŠ›å¾—åˆ†ä»£ç éƒ¨åˆ†</h3><p><code>Attention Score</code>ï¼Œåˆ°åº•ä»–ä»¬æ˜¯å¦‚ä½•è®¡ç®—çš„å‘¢ï¼Ÿ<br>ä¸‹é¢æ˜¯ç®€æ˜“è‡ªæ³¨æ„åŠ›å¾—åˆ†çš„ä»£ç ç‰‡æ®µã€‚é‡Œé¢å·²ç»åŒ…å«äº† <strong>QKV æœºåˆ¶</strong>ï¼Œ<strong>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶</strong>ï¼Œå’Œ <strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong>ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># [0]</span></span><br><span class="line">query_f = nn.Linear(d_model, d_model)</span><br><span class="line">key_f = nn.Linear(d_model, d_model)</span><br><span class="line">value_f = nn.Linear(d_model, d_model)</span><br><span class="line">fc = nn.Linear(d_model, d_model)</span><br><span class="line"><span class="comment"># [3]</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, query, key, value, mask=<span class="literal">None</span></span>):</span><br><span class="line">    batch_size = query.size(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">transform</span>(<span class="params">x</span>):</span><br><span class="line">        <span class="keyword">return</span> x.view(batch_size, -<span class="number">1</span>, <span class="variable language_">self</span>.num_heads, <span class="variable language_">self</span>.d_k).transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="comment"># [1] å¯¹ queryï¼Œkeyï¼Œvalue è¿›è¡Œå…¨é“¾æ¥çš„è½¬æ¢</span></span><br><span class="line">    query = transform(query_f(query))</span><br><span class="line">    key = transform(key_f(key))</span><br><span class="line">    value = transform(value_f(value))</span><br><span class="line">    <span class="comment"># [2] å°è£…çš„æ–¹æ³•</span></span><br><span class="line">    attn_output, attn = ScaledDotProductAttention(<span class="variable language_">self</span>.d_k)(query, key, value, mask)</span><br></pre></td></tr></table></figure>
<p>_ä»£ç è§£æ_ï¼š  </p>
<ol>
<li>[0] query_fï¼Œkey_fï¼Œ value_f å®šä¹‰ å…¨é“¾æ¥ç½‘ç»œï¼Œç”¨äºå­¦ä¹ çš„å‚æ•°</li>
<li>[1] queryï¼Œkeyï¼Œvalue è¿›è¡Œå…¨é“¾æ¥çš„è½¬æ¢ï¼Œè¿™é‡Œæœ‰å‚æ•°çš„å­¦ä¹ </li>
<li>[2] å°è£…çš„æ–¹æ³•ï¼Œå¯ä»¥è®¡ç®—å‡ºæœ€åçš„ <code>Attention Sore</code>ï¼Œé‡Œé¢å·²ç»åŒ…å« ç‚¹ç§¯&#x2F;softmax ç­‰è®¡ç®—</li>
<li>[3] å¦‚æœ query, key, value éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ª <strong>å¤šå¤´çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong> çš„è®¡ç®—å…¬å¼</li>
</ol>
<p> å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„æ•°å­¦è¡¨è¾¾å¼ï¼š<br>$head_i&#x3D;Attention(QW_i^Q,KW_i^K,VW_i^V)$ ï¼ˆ $W_i^Q W_i^K W_i^V$ éƒ½æ˜¯ä¸åŒçš„å…¨é“¾æ¥ç½‘ç»œ ï¼‰</p>
<h3 id="ä¾‹å­è¯´æ˜"><a href="#ä¾‹å­è¯´æ˜" class="headerlink" title="ä¾‹å­è¯´æ˜"></a>ä¾‹å­è¯´æ˜</h3><p>å¯è¿è¡Œçš„ ipynb æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/attention.ipynb">é“¾æ¥</a>ã€‚<br>ä»»åŠ¡ï¼šè¾“å…¥æ•°æ®ï¼Œè®¡ç®—æ•°æ®ä¹‹é—´çš„æ³¨æ„åŠ›åˆ†æ•°ï¼Œå¹¶ä¸”å¯ä»¥è§†è§‰åŒ–æ•°æ®ä¹‹é—´çš„å…³æ³¨åº¦ã€‚</p>
<p><em>ä»£ç è§£æ</em>  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">input_seq = torch.tensor([</span><br><span class="line">    [<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>],  <span class="comment"># Token 1</span></span><br><span class="line">    [<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>],  <span class="comment"># Token 2</span></span><br><span class="line">    [<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>],  <span class="comment"># Token 3</span></span><br><span class="line">    [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>],  <span class="comment"># Token 4</span></span><br><span class="line">    [<span class="number">1.0</span>, <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.0</span>]   <span class="comment"># Token 5</span></span><br><span class="line">], dtype=torch.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dimensions</span></span><br><span class="line">d_k = input_seq.shape[<span class="number">1</span>]  <span class="comment"># Embedding dimension (4 in this case)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Query, Key, and Value are all set to the input sequence (self-attention)</span></span><br><span class="line">query = input_seq</span><br><span class="line">key = input_seq</span><br><span class="line">value = input_seq</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calculate attention scores (scaled dot-product)</span></span><br><span class="line"><span class="comment"># [1]</span></span><br><span class="line">scores = torch.matmul(query, key.transpose(-<span class="number">2</span>, -<span class="number">1</span>)) / torch.sqrt(torch.tensor(d_k))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attention scores:\n&quot;</span>, scores)</span><br><span class="line"><span class="comment"># Apply softmax to get attention weights</span></span><br><span class="line"><span class="comment"># [2]</span></span><br><span class="line">attention_weights = F.softmax(scores, dim=-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attention scores afert softmax:\n&quot;</span>, attention_weights)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calculate the output as a weighted sum of the values</span></span><br><span class="line"><span class="comment"># [3]</span></span><br><span class="line">output = torch.matmul(attention_weights, value)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attention Weights:\n&quot;</span>, attention_weights)</span><br></pre></td></tr></table></figure>

<ol>
<li><p>[1] ç®€å•ä½¿ç”¨å¯¹ query key è¿›è¡Œ ç‚¹ç§¯ æ¥è®¡ç®—åˆ†æ•°</p>
<blockquote>
<p>è¿™é‡Œä½¿ç”¨äº†ç®€åŒ–ç‰ˆæœ¬ï¼Œ<strong>æ²¡æœ‰</strong> $W^q$ $W^k$ çš„çŸ©é˜µå­¦ä¹ </p>
</blockquote>
</li>
<li><p>[2] softmax scoreï¼Œå…¨éƒ¨å€¼å½’ä¸€åˆ° (0,1) çš„å€¼ä¸­</p>
</li>
<li><p>[3] score å’Œ value ç›¸ä¹˜ï¼Œå¾—åˆ°æœ€åçš„ weightsï¼Œå°±æ˜¯æœ€åçš„ç»“æœ</p>
<blockquote>
<p>è¿™é‡Œä½¿ç”¨äº†ç®€åŒ–ç‰ˆæœ¬ï¼Œ<strong>æ²¡æœ‰</strong> $W^v$  çš„çŸ©é˜µå­¦ä¹ </p>
</blockquote>
</li>
</ol>
<p><em>è¿è¡Œç»“æœ</em>  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Attention scores:</span></span><br><span class="line"><span class="string"> tensor([[1.0000, 0.0000, 0.5000, 0.5000, 0.7500],</span></span><br><span class="line"><span class="string">        [0.0000, 1.0000, 0.5000, 0.5000, 0.2500],</span></span><br><span class="line"><span class="string">        [0.5000, 0.5000, 1.0000, 0.0000, 0.7500],</span></span><br><span class="line"><span class="string">        [0.5000, 0.5000, 0.0000, 1.0000, 0.2500],</span></span><br><span class="line"><span class="string">        [0.7500, 0.2500, 0.7500, 0.2500, 0.7500]])</span></span><br><span class="line"><span class="string">Attention scores afert softmax:</span></span><br><span class="line"><span class="string"> tensor([[0.2976, 0.1095, 0.1805, 0.1805, 0.2318],</span></span><br><span class="line"><span class="string">        [0.1205, 0.3275, 0.1986, 0.1986, 0.1547],</span></span><br><span class="line"><span class="string">        [0.1805, 0.1805, 0.2976, 0.1095, 0.2318],</span></span><br><span class="line"><span class="string">        [0.1986, 0.1986, 0.1205, 0.3275, 0.1547],</span></span><br><span class="line"><span class="string">        [0.2374, 0.1440, 0.2374, 0.1440, 0.2374]])</span></span><br><span class="line"><span class="string">Attention Weights:</span></span><br><span class="line"><span class="string"> tensor([[0.2976, 0.1095, 0.1805, 0.1805, 0.2318],</span></span><br><span class="line"><span class="string">        [0.1205, 0.3275, 0.1986, 0.1986, 0.1547],</span></span><br><span class="line"><span class="string">        [0.1805, 0.1805, 0.2976, 0.1095, 0.2318],</span></span><br><span class="line"><span class="string">        [0.1986, 0.1986, 0.1205, 0.3275, 0.1547],</span></span><br><span class="line"><span class="string">        [0.2374, 0.1440, 0.2374, 0.1440, 0.2374]])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/6d9f194c-b314-4af9-bb93-dd782176ad6a_169e0c5f-3757-4035-b6eb-aa505bd920b9.png" alt="image.png"><br>ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œæ³¨æ„åŠ›çš„çƒ­å›¾ï¼Œè¡¨ç¤ºæ¯ä¸ª token ä¹‹é—´çš„æ³¨æ„åŠ›çš„å…³ç³»ã€‚ Y è½´æ˜¯ <code>Query Token</code>ï¼ŒX è½´æ˜¯ <code>Key Token</code>ã€‚å›¾ä¸­æ¯ä¸€è¡Œä¸­è¶Šæ·±è‰²çš„æ–¹å—ï¼Œå°±ä»£è¡¨ <code>Query</code> åœ¨è¿™è¡Œä¸­çš„  <code>Key</code> çš„å¾—åˆ†æœ€é«˜ã€‚<br>æ¯”å¦‚ï¼Œç¬¬ä¸€è¡Œï¼Œ<code>query1</code> å¯¹ <code>key1</code>ï¼ˆè‡ªå·±ï¼‰çš„é¢œè‰²æœ€æ·±ï¼Œè¯´æ˜æ¯ä¸ª <code>Token</code> éƒ½åº”è¯¥ä¸è‡ªå·±çš„å…³è”åº¦é«˜ï¼›ç¬¬ 5 è¡Œï¼Œ<code>query5</code> å¯¹ <code>key1</code>ï¼Œ<code>key3</code>ï¼Œ<code>key5</code> çš„å¾—åˆ†ä¸€æ ·ä¸”é¢œè‰²æœ€æ·±ï¼Œè¯´æ˜ <code>query5</code> çš„å…³è”ä¸ <code>key1</code>ï¼Œ<code>key3</code>ï¼Œ<code>key5</code> ç›¸ä¸€æ ·ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>Attention æœºåˆ¶</code> çš„ä¼˜åŠ¿  </p>
<ol>
<li>å…³æ³¨ä½ æƒ³è¦çš„ä¿¡æ¯ï¼Œè§£å†³äº†é•¿åºåˆ—çš„é—®é¢˜</li>
<li>å¯ä»¥æœ‰å¤šç»´çš„è§’åº¦å»ç†è§£æ•°æ®</li>
<li>å…¶ä¸­è•´å«äº†é€»è¾‘</li>
</ol>
<p><code>Attention æœºåˆ¶</code> æ˜¯ <code>Transformer</code> çš„åŸºç¡€ï¼Œæ‰€æœ‰æ‰€æœ‰çš„ <code>NLP</code> ä¸­æ‰“å¼€äº†æ–°çš„ä¸€æ‰‡çª—ã€‚</p>
<h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://zh-v2.d2l.ai/chapter_attention-mechanisms/attention-cues.html#id4">Dive into deep learning</a></p>
]]></content>
      <categories>
        <category>å­¦è‚¥AI</category>
      </categories>
      <tags>
        <tag>å­¦è‚¥AI</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>Attention</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰‹å†™ LSTM å’Œ GRU ä¸”åŸç†åˆ†æ</title>
    <url>/2024/08/09/%5B%E5%AD%A6%E8%82%A5AI%5D%20%E6%89%8B%E5%86%99%20LSTM%20%E5%92%8C%20GRU%20%E4%B8%94%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯é—®é¢˜"><a href="#èƒŒæ™¯é—®é¢˜" class="headerlink" title="èƒŒæ™¯é—®é¢˜"></a>èƒŒæ™¯é—®é¢˜</h2><p><code>RNN</code> æ˜¯è§£å†³æ—¶é—´åºåˆ—æ•°æ®çš„æ¨¡å‹ã€‚ä½†æ˜¯ä»–æ— æ³•è§£å†³æ—¶é—´æ­¥è¿‡é•¿è€Œæ— æ³•è®°ä½é•¿æœŸä¿¡æ¯çš„è¿™ä¸ªé—®é¢˜ã€‚ä»è€Œè¯ç”Ÿäº†å¾ˆå¤š <code>RNN</code> çš„å˜ç§æ¨¡å‹æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚æˆ‘ä»¬ä»Šå¤©æ¥çœ‹ä¸‹ä»–ä»¬çš„åŸç†å’Œæ‰‹å†™ä»–ä»¬çš„å®ç°ã€‚</p>
<h2 id="å¤æ‚-RNN"><a href="#å¤æ‚-RNN" class="headerlink" title="å¤æ‚ RNN"></a>å¤æ‚ RNN</h2><p>å¸¸è§„çš„ <code>RNN</code> çš„é€»è¾‘å›¾å¦‚ä¸‹ï¼š<br><img src="https://qiniu.oldzhangtech.com/mdpic/95f069d6-06bc-4df6-bbc8-89dc1ab54513_145485d3-8e45-4726-b6e8-fcf46df277fa.jpeg"></p>
<p>ä»£ç å¦‚ä¸‹ï¼š<br>$h_{t} &#x3D; f(h_{t-1},x_t)$<br>$o_t &#x3D; g(h_t)$ </p>
<p>ä¸ºäº†è§£å†³ ä¼ ç»Ÿ <code>RNN</code> çš„é—®é¢˜ï¼Œå°±æœ‰äº†ä»¥ä¸‹çš„æ€è·¯ï¼š  </p>
<ol>
<li>åœ¨ä¸åŒçš„è½¬æ¢è¿‡ç¨‹ï¼ˆæ¯ä¸ªè¿çº¿ï¼‰ä¸­å¢åŠ å¤š ä¸€äº›è½»é‡çº§çš„è½¬æ¢ï¼Œå¢åŠ è®°å¿†åº¦</li>
<li>åŠ ä¸Šæ®‹å·®å±‚</li>
<li>å¢åŠ å¤šæ›´å¤šçš„è¾“å‡ºå±‚ï¼Œå…ˆæŠ½å–ä½ç»´ç‰¹å¾ï¼Œå†æŠ½å–é«˜ç»´ç‰¹å¾çš„æ–¹æ³•</li>
</ol>
<p>å„ç§çš„å˜ä½“çš„ <code>RNN</code> çš„æ¶æ„å›¾å¦‚ä¸‹ï¼š<br><img src="https://qiniu.oldzhangtech.com/mdpic/e58e3b3d-03da-4c17-bd57-fdde80d71a73_184ba76b-3fd9-45d1-b587-d4dd986b95fc.jpeg"></p>
<p>å…¶ä¸­æœ€ä¼˜ç§€çš„ä¸¤ç§å˜ä½“æ¨¡å‹å°±æ˜¯ <code>LSTM</code> å’Œ <code>GRU</code> çš„æ¨¡å‹ã€‚ä¸‹é¢åˆ†åˆ«å¯¹ä¸‹é¢çš„æ¨¡å‹è¿›è¡Œä»‹ç»ã€‚</p>
<h2 id="LSTM"><a href="#LSTM" class="headerlink" title="LSTM"></a>LSTM</h2><p><code>LSTM</code>ï¼ˆLong Short-Term Memoryï¼‰å…¨ç§° é•¿çŸ­æœŸè®°å¿†ã€‚ç®€å•çš„è¯´ï¼Œå°±æ˜¯è®°å¿†åˆ†é•¿æœŸå’ŒçŸ­æœŸçš„ã€‚é•¿æœŸçš„è®°å¿†ï¼Œå¯ä»¥é•¿æ—¶é—´å­˜æ´»ï¼›åŒç†ï¼ŒçŸ­æœŸè®°å¿†ç”Ÿå­˜æ—¶é—´å°±æ¯”è¾ƒçŸ­ã€‚</p>
<p>ğŸ”¥ <code>RNN</code> è®°å¿†æ˜¯å­˜åœ¨æ¯ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€ä¸­çš„ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œä¼šâ€œé—å¿˜â€æ—¶é—´é•¿çš„éšçŠ¶æ€ï¼Œå³æƒé‡é€æ­¥å‡å°‘ï¼› <code>LSTM</code> å°±æ˜¯ é’ˆå¯¹é‡è¦çš„è®°å¿†ï¼Œæ‹¿ä¸ªè®°äº‹æœ¬è®°ä½ï¼Œè®©ä»–ä¸ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå¿˜è®°äº†ã€‚</p>
<p><code>LSTM</code> ä¸äººç±»çš„æ—¥è®°ä¹ æƒ¯ä¸€è‡´ï¼Œæ¯å¤©è®°å½•åˆ°æ—¥è®°çš„äº‹æƒ…éƒ½æ˜¯é‡è¦çš„äº‹æƒ…ï¼Œä½†æ˜¯ä¸ä¼š 24 å°æ—¶æ¯åˆ†æ¯ç§’çš„äº‹æƒ…éƒ½è®°ä½ã€‚æŸå¹´æŸæœˆæŸæ—¥ä¸­äº†åŒè‰²çƒå¤´å¥–ï¼ˆé•¿æœŸè®°å¿†ï¼‰ï¼Œéƒ½ä¼šè®°å½•ä¸‹æ¥ï¼Œå¤šå¹´åå†ç¿»çœ‹ï¼Œéƒ½ä¼šè®°å¿†çŠ¹æ–°ï¼›åŒæ—¶ï¼Œ489 å¤©å‰çš„æ™šé¥­åƒäº†ä»€ä¹ˆï¼ˆçŸ­æœŸè®°å¿†ï¼‰ï¼Œå¤§ä½“ä¸ä¼šå‡ºç°åœ¨ä½ æ—¥è®°æœ¬å†…ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šåœ¨ä½ çš„è„‘æµ·å†…ã€‚</p>
<blockquote>
<p>è®°ä½äº†åŸç†å°±å¯ä»¥ï¼Œä¸éœ€è¦è¿‡å¤šçš„ç»†èŠ‚</p>
</blockquote>
<h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p><em>åŸç†å›¾</em><br><img src="https://qiniu.oldzhangtech.com/mdpic/6cf90fbb-3bef-4376-afa2-49b857b98e89_9a2d9ced-e5a5-4497-95db-0418b57fc8da.jpeg"><br>å¯¹æ¯” <code>RNN</code>ï¼Œ<code>LSTM</code> å°±å¯ä»¥å¯¹æŸäº›è®°å¿†è®¤ä¸ºæ˜¯é•¿æœŸçš„ä¸”é‡è¦çš„ï¼Œè¿›è¡ŒåŠ æƒï¼Œè®©ä»–çš„æƒé‡ä¸å‡å¼±ã€‚</p>
<p><em>é€»è¾‘è¯´æ˜</em><br>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µï¼š<code>Cell è®°å¿†</code> ä»–æ˜¯åŒ…å«åœ¨ <code>LSTMCell</code> é‡Œé¢ä¸€ä¸ªå†…ç½®çš„è®°å¿†ä½“ï¼Œä»–å°±æ˜¯ç”¨äºè®°ä½å“ªäº› <code>Long Term Memory</code>ã€‚ </p>
<p><code>LSTMCell</code>  å°±æ˜¯ <code>LSTMModel</code> çš„åŸºç¡€çš„ç»„ä»¶ï¼Œä¸‹å›¾å°±æ˜¯ <code>LSTMCell</code> çš„åŸç†å›¾ã€‚æ•´ä¸ª <code>Cell</code>  æœ‰ 3 ä¸ªé—¨æ¥æ§åˆ¶è®°å¿†ï¼ŒåŒ…æ‹¬äº† é—å¿˜é—¨&#x2F;è¾“å…¥é—¨&#x2F;è¾“å‡ºé—¨ï¼Œç”±ä»–ä»¬æ¥æ§åˆ¶ è¾“å…¥&#x2F;è¾“å‡º&#x2F;éšçŠ¶æ€&#x2F;è®°å¿† ä¹‹é—´çš„å…³ç³»ã€‚<br><img src="https://qiniu.oldzhangtech.com/mdpic/bdf5c0f7-e18f-401e-b7b5-c43ddab01baf_dbd5558a-4c81-447c-8bb6-a83b18f14a7c.png" alt="image.png"></p>
<blockquote>
<p>æˆ‘ä»¬ç›´æ¥ dive deep into codeï¼Œå¯¹ç…§è¿™ä¸ªåŸç†å›¾ï¼Œä¼šæ›´åŠ å®¹æ˜“ç†è§£ã€‚</p>
</blockquote>
<h3 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h3><p>ä¸‹é¢æ˜¯èŠ‚é€‰<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/lstm.ipynb">ä¾‹å­</a>ä¸­çš„ <strong>æ‰‹å†™LSTM</strong> çš„ <code>LSTM Cell</code> ä»£ç ç‰‡æ®µã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LSTMCell</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_size, hidden_size</span>):</span><br><span class="line">        <span class="built_in">super</span>(LSTMCell, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = hidden_size</span><br><span class="line">        <span class="comment"># è¾“å…¥é—¨</span></span><br><span class="line">        <span class="variable language_">self</span>.input_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="comment"># é—å¿˜é—¨</span></span><br><span class="line">        <span class="variable language_">self</span>.forget_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="comment"># è¾“å‡ºé—¨</span></span><br><span class="line">        <span class="variable language_">self</span>.output_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="comment"># æœ¬ Cell çš„è®°å¿†é—¨</span></span><br><span class="line">        <span class="variable language_">self</span>.cell_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, interState</span>):</span><br><span class="line">        h_prev, c_prev = interState</span><br><span class="line"></span><br><span class="line">        combined = torch.cat((x, h_prev), dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        i_t = torch.sigmoid(<span class="variable language_">self</span>.input_gate(combined))</span><br><span class="line">        f_t = torch.sigmoid(<span class="variable language_">self</span>.forget_gate(combined))</span><br><span class="line">        o_t = torch.sigmoid(<span class="variable language_">self</span>.output_gate(combined))</span><br><span class="line">        c_tilde = torch.tanh(<span class="variable language_">self</span>.cell_gate(combined))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¸»è¦é€»è¾‘ï¼Œä¸‹é¢ä¸¤è¡Œ</span></span><br><span class="line">        c_t = f_t * c_prev + i_t * c_tilde</span><br><span class="line">        h_t = o_t * torch.tanh(c_t)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> h_t, (h_t, c_t)</span><br></pre></td></tr></table></figure>
<p>è¯·ç»“åˆæ³¨é‡Šå’ŒåŸç†å›¾ï¼Œè¿›è¡Œé˜…è¯»</p>
<p><em>æ€»ç»“</em>   </p>
<ol>
<li>ä¸Šè¿°é€»è¾‘ éƒ½æ˜¯ç®€å•çš„ <strong>å…¨é“¾æ¥</strong> å’Œ <strong>æ¿€æ´»å‡½æ•°</strong> æ„æˆï¼Œæ‰€ä»¥ç†è§£åŸç†æ˜¯æœ€é‡è¦çš„ï¼Œå†…éƒ¨éƒ½æ˜¯ç»„è£…è€Œå·²</li>
<li>å› ä¸ºæ˜¯æ‰‹å†™ <code>LSTMCell</code>ï¼Œç®€åŒ–äº†é€»è¾‘ï¼Œä»…ä»…æ˜¯é’ˆå¯¹ å•ä¸ªæ•°æ® + è®°å¿† å¤„ç†ï¼›sequence çš„æ•°æ® å°±æ˜¯åœ¨è®­ç»ƒçš„æ—¶å€™ï¼Œè¿›è¡Œå¾ªç¯ï¼›batch çš„æ¦‚å¿µï¼Œå½“ç„¶ä¹Ÿæ˜¯æ²¡æœ‰çš„ã€‚<blockquote>
<p>âš ï¸ è¿™é‡Œå½±å“åˆ°äº† 1. X, y çš„æ•°æ®ç»“æ„ï¼› 2. æ¨¡å‹å†…çš„ forward çš„å¤„ç†æ–¹æ³•ï¼›3. train çš„æ–¹æ³•ã€‚å¯ä»¥å¯¹æ¯”æ–‡ä»¶åé¢çš„  nn.LSTM çš„è§£å†³æ–¹æ³•ï¼Œæ¥ä¸€èµ·æœç”¨ã€‚<br>æœ€å¥½çš„æ–¹å¼å½“ç„¶æ˜¯æŠŠ æ‰‹å†™ LSTMCell æ”¹å†™æˆ (batch, sequence, input_feature) X æ•°æ®ç»“æ„ éƒ½é€‚ç”¨çš„ä»£ç ã€‚</p>
</blockquote>
</li>
</ol>
<h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>ä¾‹å­ç›®æ ‡ï¼š è¾“å…¥ 5 ä¸ªæ•°å­—ï¼Œå¯ä»¥é¢„æµ‹ä¸‹ä¸€ä¸ªæ•°æ®æ˜¯å¤šå°‘ã€‚</p>
<p><em>åˆ†æè¿‡ç¨‹</em>  </p>
<ol>
<li>æ˜¯ å›å½’é—®é¢˜</li>
<li>â€œ5 ä¸ªæ•°å­—â€ æ˜¯ä¸€ä¸ªæœ‰è¿ç»­å…ˆåå…³ç³»çš„è¾“å…¥ï¼Œæ‰€ä»¥ä½¿ç”¨ç±» RNN çš„æ¨¡å‹</li>
<li>å®šä¹‰ RNN çš„æ—¶å€™ input_feature å’Œ output_feature éƒ½æ˜¯ 1</li>
</ol>
<p>è¯¦ç»†çš„ä»£ç å¯ä»¥ç›´æ¥è®¿é—® ipynb æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/lstm.ipynb">é“¾æ¥</a>ã€‚é‡Œé¢æœ‰ æ‰‹åŠ¨LSTM å’Œ nn.LSTM ä¸¤ç§ä¸åŒçš„å®ç°æ–¹æ¡ˆã€‚</p>
<p><em>è®­ç»ƒåçš„ç»“æœ</em>   </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®­ç»ƒè¿‡ç¨‹</span></span><br><span class="line">epoch: <span class="number">400</span> loss: <span class="number">0.01360714</span></span><br><span class="line">epoch: <span class="number">450</span> loss: <span class="number">0.00120955</span></span><br><span class="line">epoch: <span class="number">499</span> loss: <span class="number">0.0031908983</span></span><br><span class="line"><span class="comment"># åœ¨ 500 åæ”¶æ•›</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥ 45,46,47,48,49,50</span></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">[<span class="number">49.966102600097656</span>, <span class="number">50.8197021484375</span>, <span class="number">51.54384231567383</span>, <span class="number">52.14518737792969</span>, <span class="number">52.62910842895508</span>]</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="GRU"><a href="#GRU" class="headerlink" title="GRU"></a>GRU</h2><p><code>GRU</code>ï¼ˆGated Recurrent Unitï¼‰å…¨ç§° é—¨æ§å¾ªç¯å•å…ƒï¼Œå°±æ˜¯ä½¿ç”¨ é€»è¾‘ç”µè·¯çš„æ€è·¯å»è§£å†³æ¨¡å‹çš„é—®é¢˜ã€‚</p>
<p>ä»–å’Œ <code>LSTM</code> ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸ºäº†è§£å†³ <code>RNN</code> çš„é•¿æœŸè®°å¿†çš„é—®é¢˜ã€‚åŒæ—¶æ¯” <code>LSTM</code> çš„ä¼˜åŠ¿æ˜¯ï¼Œä»…ä»…æ˜¯ç”¨äº†ä¸¤ä¸ªé—¨ â€“ é‡ç½®é—¨ å’Œ æ›´æ–°é—¨ã€‚é—¨çš„æ•°é‡çš„å‡å°‘ï¼Œè‡ªç„¶å‚æ•°é‡å¯ä»¥è¿›ä¸€æ­¥çš„å‡å°‘ã€‚</p>
<blockquote>
<p>è®°ä½äº†åŸç†å°±å¯ä»¥ï¼Œä¸éœ€è¦è¿‡å¤šçš„ç»†èŠ‚</p>
</blockquote>
<h3 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h3><p><em>åŸç†å›¾</em><br><img src="https://qiniu.oldzhangtech.com/mdpic/98cd28fc-f93a-49b2-873c-6a432f819079_fbdfb78f-be9e-4200-b583-2b2205b6bd64.png" alt="image.png"><br><code>GRUCell</code>  å°±æ˜¯ <code>GRUModel</code> çš„åŸºç¡€çš„ç»„ä»¶ï¼Œä¸Šå›¾å°±æ˜¯ <code>GRUCell</code> çš„åŸç†å›¾ã€‚æ•´ä¸ª <code>Cell</code>  æœ‰ 2 ä¸ªé—¨æ¥æ§åˆ¶è®°å¿†ï¼ŒåŒ…æ‹¬äº† é‡ç½®é—¨&#x2F;æ›´æ–°é—¨ï¼Œç”±ä»–ä»¬æ¥æ§åˆ¶ è¾“å…¥&#x2F;è¾“å‡º&#x2F;éšçŠ¶æ€ ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p>âš ï¸ æ³¨æ„ï¼Œä¸ <code>LSTM</code> å¯¹æ¯”ï¼Œ<code>GRU</code> æ²¡æœ‰ <strong>è®°å¿†</strong> çš„æ¦‚å¿µï¼Œä»–çš„æ‰€æœ‰çš„è®°å¿†éƒ½æ˜¯éšçŠ¶æ€ä¸­ï¼Œå¹¶ä¸”ä»–æ˜¯ä½¿ç”¨ <code>é—¨</code> æ¥æ›´æ–°&#x2F;é‡ç½® éšçŠ¶æ€ã€‚ </p>
<h3 id="ç»„ä»¶-1"><a href="#ç»„ä»¶-1" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h3><p>ä¸‹é¢æ˜¯èŠ‚é€‰<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/gru.ipynb">ä¾‹å­</a>ä¸­çš„ <strong>æ‰‹å†™GRU</strong> çš„ <code>GRUCell</code> ä»£ç ç‰‡æ®µã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GRUCell</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_size, hidden_size</span>):</span><br><span class="line">        <span class="built_in">super</span>(GRUCell, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = hidden_size</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.update_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="variable language_">self</span>.reset_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="variable language_">self</span>.hidden_candidate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, hidden</span>):</span><br><span class="line">        <span class="comment"># print(f&quot;cell forward : &#123;x.shape&#125; &#123;hidden.shape&#125;&quot;)</span></span><br><span class="line">        <span class="comment"># cell forward : torch.Size([1]) torch.Size([50])</span></span><br><span class="line">        combined = torch.cat((x, hidden), dim=<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        update_gate = torch.sigmoid(<span class="variable language_">self</span>.update_gate(combined))</span><br><span class="line">        reset_gate = torch.sigmoid(<span class="variable language_">self</span>.reset_gate(combined))</span><br><span class="line">        <span class="comment"># process reset</span></span><br><span class="line">        combined_hidden = torch.cat((x, reset_gate * hidden), dim=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># activate after process reset</span></span><br><span class="line">        hidden_candidate = torch.tanh(<span class="variable language_">self</span>.hidden_candidate(combined_hidden))</span><br><span class="line">        <span class="comment"># process update</span></span><br><span class="line">        hidden = (<span class="number">1</span> - update_gate) * hidden + update_gate * hidden_candidate</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hidden</span><br></pre></td></tr></table></figure>
<p>è¯·ç»“åˆæ³¨é‡Šå’ŒåŸç†å›¾ï¼Œè¿›è¡Œé˜…è¯»ã€‚</p>
<p>ä¸ <code>LSTM</code> å¯¹æ¯”   </p>
<ol>
<li><strong>æ²¡æœ‰</strong>äº† <code>Cell</code> çš„è®°å¿†ï¼Œä»–æ˜¯ç›´æ¥ä¿®æ”¹äº† éšçŠ¶æ€ <code>hidden</code></li>
<li>åªæœ‰ä¸¤ä¸ªé—¨ï¼Œæ›´æ–°é—¨ å’Œ é‡ç½®é—¨ï¼Œç»“æ„æ›´åŠ çš„ç®€å•</li>
</ol>
<p><em>æ€»ç»“</em>   </p>
<ol>
<li>ä¸Šè¿°é€»è¾‘ éƒ½æ˜¯ç®€å•çš„ <strong>å…¨é“¾æ¥</strong> å’Œ <strong>æ¿€æ´»å‡½æ•°</strong> æ„æˆï¼Œæ‰€ä»¥ç†è§£åŸç†æ˜¯æœ€é‡è¦çš„ï¼Œå†…éƒ¨éƒ½æ˜¯ç»„è£…è€Œå·²</li>
<li>å› ä¸ºæ˜¯æ‰‹å†™ <code>GRUCell</code>ï¼Œç®€åŒ–äº†é€»è¾‘ï¼Œä»…ä»…æ˜¯é’ˆå¯¹ å•ä¸ªæ•°æ® + è®°å¿† å¤„ç†ï¼›sequence çš„æ•°æ® å°±æ˜¯åœ¨è®­ç»ƒçš„æ—¶å€™ï¼Œè¿›è¡Œå¾ªç¯ï¼›batch çš„æ¦‚å¿µï¼Œå½“ç„¶ä¹Ÿæ˜¯æ²¡æœ‰çš„ã€‚<blockquote>
<p>âš ï¸ è¿™é‡Œå½±å“åˆ°äº† 1. X, y çš„æ•°æ®ç»“æ„ï¼› 2. æ¨¡å‹å†…çš„ forward çš„å¤„ç†æ–¹æ³•ï¼›3. train çš„æ–¹æ³•ã€‚å¯ä»¥å¯¹æ¯”æ–‡ä»¶åé¢çš„  nn.GRU çš„è§£å†³æ–¹æ³•ï¼Œæ¥ä¸€èµ·æœç”¨ã€‚<br>æœ€å¥½çš„æ–¹å¼å½“ç„¶æ˜¯æŠŠ æ‰‹å†™ GRUCell æ”¹å†™æˆ (batch, sequence, input_feature) X æ•°æ®ç»“æ„ éƒ½é€‚ç”¨çš„ä»£ç ã€‚</p>
</blockquote>
</li>
</ol>
<h3 id="ä¾‹å­-1"><a href="#ä¾‹å­-1" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>ä¸ <code>LSTM</code> çš„ä¾‹å­çš„é¢˜ç›®æ˜¯ä¸€è‡´çš„ï¼Œåˆ†æçš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€è‡´ã€‚</p>
<p>è¯¦ç»†çš„ä»£ç å¯ä»¥ç›´æ¥è®¿é—® ipynb æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/gru.ipynb">é“¾æ¥</a>ã€‚é‡Œé¢æœ‰ æ‰‹åŠ¨GRU å’Œ nn.GRU ä¸¤ç§ä¸åŒçš„å®ç°æ–¹æ¡ˆã€‚</p>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li>æ— è®ºæ˜¯ <code>RNN</code> å’Œ <code>ç±»RNN</code> æ¨¡å‹ <code>LSTM</code>&#x2F;<code>GRU</code> éƒ½æ˜¯ <strong>è¾“å‡ºæ—¶é—´æ­¥çš„éšçŠ¶æ€</strong>ï¼Œè¿™æ˜¯ æ—¶åºåºåˆ—ç›¸å…³çš„æ¨¡å‹çš„å…³é”®</li>
<li><code>LSTM</code> å’Œ <code>GRU</code> ï¼Œå…·æœ‰æ¨¡å‹çš„å¯è§£é‡Šæ€§ï¼ŒåŒæ—¶ä»–æ˜¯è§£å†³å…¶ä»–é—®é¢˜çš„æ–¹å¼ç”¨åœ¨å®šä¹‰æ¨¡å‹ä¸Šï¼Œä½“ç°è·¨å­¦ç§‘å­¦ä¹ çš„é‡è¦æ€§</li>
<li><code>LSTM</code> å’Œ <code>GRU</code> åœ¨ä½¿ç”¨åœºæ™¯ä¸Šéƒ½å¯ä»¥äº¤æ›¿ä½¿ç”¨ï¼Œçœ‹å“ªä¸ªæ¯”è¾ƒé€‚åˆ</li>
</ol>
]]></content>
      <categories>
        <category>å­¦è‚¥AI</category>
      </categories>
      <tags>
        <tag>å­¦è‚¥AI</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>LSTM</tag>
        <tag>GRU</tag>
      </tags>
  </entry>
  <entry>
    <title>å¾®ä¿¡äº‘å¼€å‘åŠäº‘å‡½æ•°</title>
    <url>/2024/11/07/%5B%E5%AD%A6%E8%82%A5%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91%5D%20%E5%BE%AE%E4%BF%A1%E4%BA%91%E5%BC%80%E5%8F%91-%E4%BA%91%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h2 id="äº‘å¼€å‘æ˜¯ä»€ä¹ˆ"><a href="#äº‘å¼€å‘æ˜¯ä»€ä¹ˆ" class="headerlink" title="äº‘å¼€å‘æ˜¯ä»€ä¹ˆ"></a>äº‘å¼€å‘æ˜¯ä»€ä¹ˆ</h2><p>å¦‚æœå¾®ä¿¡å°ç¨‹åºæ˜¯å‰ç«¯ï¼Œé‚£ä¹ˆåç«¯å°±æ˜¯ æœåŠ¡å™¨&#x2F;åç«¯ä»£ç è¿è¡Œ&#x2F;äº‘å­˜å‚¨&#x2F;æ•°æ®åº“ç­‰ï¼Œå‰åç«¯é…åˆæ‰æ˜¯ä¸€ä¸ªå®Œæ•´çš„é¢å‘æœåŠ¡çš„ç¨‹åºã€‚</p>
<p>å‰åç«¯é…ç½®ï¼Œä¸Šè¿°æ˜¯æ­£å¸¸çš„å¼€å‘çš„ç»„åˆã€‚ä½†æ˜¯åç«¯æ¶‰åŠåˆ°å¾ˆå¤šç¹ççš„æ­¥éª¤ï¼Œæ¯”å¦‚ åŸŸåç”³è¯·&#x2F;åŸŸåè§£æ&#x2F;åç«¯ä»£ç éƒ¨ç½²â€¦ä¸€ç³»åˆ—çš„é—®é¢˜ã€‚ç­‰è§£å†³å¥½è¿™äº›é—®é¢˜ï¼Œæ—¶é—´éƒ½è€—è´¹äº†åŠå¤©äº†ã€‚</p>
<p>å¾®ä¿¡äº‘å¼€å‘ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°çš„é—®é¢˜ã€‚åœ¨ <strong>å¾®ä¿¡å¼€å‘è€…å·¥å…·</strong> ä¸­å°±å¯ä»¥ä¸€é”®å¼€å‘ <strong>æ•°æ®åº“&#x2F;äº‘å‡½æ•°&#x2F;äº‘å­˜å‚¨</strong>ï¼Œæ–¹ä¾¿çµæ´»ã€‚</p>
<p>ç›¸åº”çš„ç½‘ç«™è¯´æ˜ï¼š <a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloudservice/wxcloud/guide/init.html">äº‘å¼€å‘ </a>ã€‚ä¸‹é¢å°±ç€ äº‘å‡½æ•°ï¼Œè¯´æ˜ä¸€ä¸‹ã€‚</p>
<h2 id="äº‘å‡½æ•°-hello-world"><a href="#äº‘å‡½æ•°-hello-world" class="headerlink" title="äº‘å‡½æ•° hello world"></a>äº‘å‡½æ•° hello world</h2><ol>
<li>æ–°å»ºä¸€ä¸ª <strong>äº‘ç¯å¢ƒ</strong>ï¼Œæ‰“å¼€ _å¾®ä¿¡å¼€å‘è€…å·¥å…·_ï¼Œç‚¹å‡» <em>äº‘å¼€å‘</em> æŒ‰é’®ã€‚</li>
</ol>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/a3303d65-ae28-4a4a-b024-d00ad6ff4095_ff179b1c-7af2-4c3e-90a7-90529e880779.png"></p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/55118c6e-7dd0-4378-aaad-398c8fa4f6f9_d3cdcadd-4568-4b51-81ad-2d66fe249616.png"></p>
<p>çº¢è‰²ç®­å¤´æ˜¯ <code>envId</code>ï¼Œåç»­åœ¨ä»£ç ä¸­ç”¨ä¸Šã€‚æš‚æ—¶å…ˆå»ºç«‹ä¸€ä¸ªç¯å¢ƒ <code>test</code>ã€‚</p>
<blockquote>
<p>â“ç¯å¢ƒæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>å°±æ˜¯ç”¨æ¥éš”ç¦»ä¸åŒ äº‘å‡½æ•°&#x2F;æ•°æ®åº“&#x2F;äº‘å­˜å‚¨çš„ ç©ºé—´ã€‚å¯ä»¥æƒ³è±¡ï¼Œä¸åŒçš„ç¯å¢ƒï¼Œå°±ç­‰äºä¸åŒçš„æˆ¿å­ï¼›ä¸åŒçš„æˆ¿å­é‡Œé¢è™½ç„¶éƒ½æœ‰ æ¡Œå­æ¤…å­ï¼Œä½†æ˜¯ä»–ä»¬éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚</p>
</blockquote>
<ol start="2">
<li>æ–°å»ºç›®å½•ï¼Œ<code>cloudfunctions</code> ï¼Œæ˜¯äº‘å‡½æ•°çš„ä¿å­˜ç›®å½•ã€‚åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰¾åˆ° <code>project.config.json</code> æ–‡ä»¶ï¼Œæ–°å¢ <code>cloudfunctionRoot</code> å­—æ®µï¼Œ<code>value</code> å°±æ˜¯ <code>cloudfunctions</code>ã€‚</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;cloudfunctionRoot&quot;</span>: <span class="string">&quot;cloudfunctions/&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ <strong>æ–°å»ºçš„ç›®å½•</strong> ä¸Šè¦é€‰æ‹©ä½ è¦åœ¨ <code>å“ªä¸ªç¯å¢ƒ</code> ä¸­è¿›è¡Œå¼€å‘äº‘å‡½æ•°ï¼Œæ¯”å¦‚ä¸‹å›¾ï¼Œé€‰æ‹©äº† æ–°å»ºçš„ <code>test</code> ç¯å¢ƒã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/5bed85c0-d45a-4bc6-84b7-4b3601f05b1d_678f3efa-eef6-4d5d-94a6-f9f2acf75f09.png"></p>
<ol start="3">
<li>åˆ›å»ºäº‘å‡½æ•°ï¼Œåœ¨ <code>cloudfunctions</code> ç›®å½• å³é”®ï¼Œç‚¹å‡» ã€æ–°å»º node.js äº‘å‡½æ•°ã€‘ï¼Œåå­—å« <code>add</code>ã€‚</li>
</ol>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/1e29e888-7ffc-4c8e-ad45-9211e11c3688_6c840fc5-13f7-4e5e-b1c0-257e5525e4c3.png"></p>
<p>add ç›®å½•ä¸‹ å¢åŠ å¤š 3 ä¸ªæ–‡ä»¶</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/b062fd6a-be83-4b1f-adaa-abc4b1c445aa_55aae544-8c59-4f95-8fee-fa139fc5b325.png"></p>
<ol start="4">
<li>ä¿®æ”¹ <code>add/index.js</code> ï¼Œå…¨æ–‡æ›¿æ¢æˆä¸‹é¢çš„ä»£ç ã€‚</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// äº‘å‡½æ•°å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">main</span> = <span class="title function_">async</span> (event, context) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">sum</span>: event.<span class="property">a</span> + event.<span class="property">b</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="5">
<li>ä¿®æ”¹ <code>package.json</code>ï¼Œ åˆ é™¤ <code>dependencies</code> é‡Œé¢çš„å€¼ï¼Œç±»ä¼¼çš„ä»£ç å¦‚ä¸‹</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<ol start="6">
<li>ä¸Šä¼ å‡½æ•°ï¼Œå˜æˆ <code>äº‘</code></li>
</ol>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/8677fd70-f4e7-48dc-8151-500ce61fc6c5_2e030105-4f2e-4076-9e42-aa5d749a7d49.png"></p>
<blockquote>
<p>å¦‚æœï¼Œæœ‰ä»¥ä¸‹çš„æƒ…å†µ</p>
<ol>
<li><code>index.js</code> ä¸­ <strong>æ²¡æœ‰</strong> <code>const cloud = require(&#39;wx-server-sdk&#39;)</code> ä»£ç </li>
<li><code>package.json</code> çš„ <code>dependencies</code> å­—æ®µ æ²¡æœ‰å€¼</li>
</ol>
<p>å°±å¯ä»¥  ç‚¹å‡»ã€ä¸Šä¼ å¹¶éƒ¨ç½²: æ‰€æœ‰æ–‡ä»¶ã€‘èœå•ï¼Œæ¯”å¦‚ æœ¬ä¾‹ã€‚</p>
<p>å¦‚æœæœ‰ä¸Šè¿°çš„æƒ…å†µï¼Œå°±å¯ä»¥  ç‚¹å‡»ã€ä¸Šä¼ å¹¶éƒ¨ç½²: äº‘ç«¯å®‰è£…ä¾èµ–ã€‘èœå•ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/beccdf18-d285-4e40-a6f3-1ab02736ce83_c349e39c-ec34-4d3a-9292-92cbc54a50e9.png"></p>
</blockquote>
<blockquote>
<p>ğŸ’¡ â€˜wx-server-sdkâ€™ çš„å®‰è£…ï¼Œæ˜¯ä¸ºäº† äº‘å‡½æ•°ä¸­å¯ä»¥ è°ƒç”¨ <strong>æ•°æ®åº“</strong> å’Œ <strong>äº‘å­˜å‚¨</strong>ã€‚å¦‚æœä½ åœ¨å¾®ä¿¡å°ç¨‹åºä¸­æ˜¯ç›´æ¥ è°ƒç”¨ æ•°æ®åº“ å’Œ äº‘å­˜å‚¨ï¼Œå°±æ²¡æœ‰å¿…è¦åœ¨ äº‘å‡½æ•° ä¸­å€’ä¸€å€’äº†ã€‚</p>
</blockquote>
<ol start="7">
<li>è°ƒè¯•äº‘å‡½æ•°ï¼Œåœ¨ <strong>å¼€å‘è€…å·¥å…·</strong> å°±å¯ä»¥è°ƒè¯•åˆšåˆšä¸Šä¼ çš„äº‘å‡½æ•°</li>
</ol>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/1ae346b2-e450-4d10-b42a-c05843452c69_385b46fd-7871-4826-8fb7-348178fcd442.png"></p>
<ol start="8">
<li>å°ç¨‹åºä¸­è°ƒç”¨ äº‘å‡½æ•° add</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">wx.<span class="property">cloud</span>.<span class="title function_">init</span>(&#123;</span><br><span class="line">      <span class="attr">env</span>: <span class="string">&#x27;test-safjlfjasdfasf&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">wx.<span class="property">cloud</span>.<span class="title function_">callFunction</span>(&#123;</span><br><span class="line">      <span class="comment">// äº‘å‡½æ•°åç§°</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">      <span class="comment">// ä¼ ç»™äº‘å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">b</span>: <span class="number">2</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">result</span>.<span class="property">sum</span>) <span class="comment">// 3</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">fail</span>: <span class="variable language_">console</span>.<span class="property">error</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>



<ol start="9">
<li>æ’’èŠ±</li>
</ol>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><em>å¾®ä¿¡äº‘å¼€å‘</em> å¼€å‘ _äº‘å‡½æ•°_ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå·¥å…·é‡Œé¢åŒæ—¶å¼€å‘å‰ç«¯å’Œåç«¯çš„ä»£ç ï¼Œå‡å°‘ç¹ççš„æ­¥éª¤ï¼ŒåŠ å¿«å¼€å‘çš„æ•ˆç‡ã€‚</p>
]]></content>
      <categories>
        <category>å¾®ä¿¡äº‘å¼€å‘</category>
      </categories>
      <tags>
        <tag>å¾®ä¿¡</tag>
        <tag>å¾®ä¿¡äº‘å¼€å‘</tag>
        <tag>äº‘å¼€å‘</tag>
        <tag>äº‘å‡½æ•°</tag>
        <tag>äº‘æ•°æ®åº“</tag>
        <tag>äº‘å­˜å‚¨</tag>
      </tags>
  </entry>
  <entry>
    <title>CNN çš„ç†è§£</title>
    <url>/2024/07/26/%5B%E5%AD%A6%E8%82%A5AI%5D%20CNN%E7%9A%84%E7%90%86%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯é—®é¢˜"><a href="#èƒŒæ™¯é—®é¢˜" class="headerlink" title="èƒŒæ™¯é—®é¢˜"></a>èƒŒæ™¯é—®é¢˜</h2><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨æ·±åº¦ç¥ç»ç½‘ç»œæ¥å­¦ä¹ æ•°æ®ã€‚å¦‚æœæ•ˆæœä¸ç†æƒ³ï¼Œå¸¸å¸¸éƒ½ä¼š <strong>åŠ æ·±å’ŒåŠ å®½å…¨è¿æ¥å±‚</strong> æ¥è®©æ•ˆæœæ›´åŠ çš„å®Œå–„ã€‚ä½†æ˜¯åŠ æ·±åŠ å®½ç½‘ç»œä¼šå¼•æ¥æ›´åŠ å¤šçš„é—®é¢˜ï¼Œæ¯”å¦‚ æ¢¯åº¦æ¶ˆå¤±&#x2F;æ¢¯åº¦çˆ†ç‚¸ ç­‰ã€‚<br>ç‰¹åˆ«æ˜¯é¢å¯¹å›¾åƒè¯†åˆ«é—®é¢˜çš„æ—¶å€™ï¼Œæ¯”å¦‚æ‰‹å†™æ•°å­—è¯†åˆ«ï¼Œä¸€å¹…å›¾ç‰‡æœ¬æ¥å°±æœ‰å¤§é‡çš„ä¿¡æ¯ï¼Œ<code>width</code>&#x2F;<code>height</code>&#x2F;<code>3 color channels </code>ç­‰ï¼ŒåŠ æ·±åŠ å®½ç½‘ç»œä¸‹çš„æ¨¡å‹ï¼Œç»“æœå¾€å¾€æœªå¦‚ç†æƒ³ã€‚<br><code>CNN</code> å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°çš„é—®é¢˜çš„ã€‚<code>CNN</code> å³æ˜¯ <code>Convolution Neural Network</code>ï¼Œå·ç§¯ç¥ç»ç½‘ç»œã€‚</p>
<blockquote>
<p>å…ˆè®²è§£ä¸åŒçš„å­ç»„ä»¶ï¼Œå†ç»„åˆèµ·æ¥ï¼Œå½¢æˆæ‰‹å†™çš„æ¨¡å‹ï¼Œè¿™æ ·å°±æ›´åŠ å®¹æ˜“çš„å»ç†è§£æ¨¡å‹ã€‚</p>
</blockquote>
<h2 id="å·ç§¯å’Œå·ç§¯æ ¸"><a href="#å·ç§¯å’Œå·ç§¯æ ¸" class="headerlink" title="å·ç§¯å’Œå·ç§¯æ ¸"></a>å·ç§¯å’Œå·ç§¯æ ¸</h2><p><em>å·ç§¯</em><br>å·ç§¯ï¼Œæ˜¯ <em>æ¥æºçŸ©é˜µ</em> å’Œ <em>å·ç§¯æ ¸çŸ©é˜µ</em> ä¸€ä¸ªä¸ªå¯¹åº”ä½ç½®è¿›è¡Œç›¸ä¹˜åï¼Œå†ç›¸åŠ çš„è¿ç®—ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¯¹ ã€ä¸­å¿ƒç‚¹ã€‘è¿›è¡Œå·ç§¯è¿ç®—</span></span><br><span class="line"><span class="comment"># æ¥æºä¸¾è¯</span></span><br><span class="line">input_array = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">                        [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">                        [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])</span><br><span class="line"><span class="comment"># å·ç§¯æ ¸</span></span><br><span class="line">kernel_array = np.array([[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">                         [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">                         [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]])</span><br><span class="line"><span class="comment"># å·ç§¯æ“ä½œ</span></span><br><span class="line"><span class="comment"># 1*1+2*0+3*0+4*0+5*1+6*0+7*0+8*0+9*1 = 15</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹åº”å·ç§¯å</span></span><br><span class="line">Output:</span><br><span class="line">[[<span class="number">15</span>]]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¦‚æœåŠ ä¸Š <code>padding</code> å’Œ <code>stride</code> çš„è¯ï¼Œå³å·ç§¯æ ¸å°±å¯ä»¥æ²¿ç€ <em>æ¥æºçŸ©é˜µ</em> æ»‘åŠ¨ï¼Œå®Œæˆæ•´ä¸ªå·ç§¯æ“ä½œã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># padding = 1 ï¼Œstride = 1</span></span><br><span class="line"><span class="comment"># æ¥æºçŸ©é˜µ</span></span><br><span class="line">input_array = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">                        [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">                        [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])</span><br><span class="line"><span class="comment"># å·ç§¯æ ¸</span></span><br><span class="line">kernel_array = np.array([[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">                         [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">                         [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹åº”å·ç§¯å</span></span><br><span class="line">Output:</span><br><span class="line">[[ <span class="number">6</span>  <span class="number">8</span>  <span class="number">3</span>]</span><br><span class="line"> [<span class="number">12</span> <span class="number">15</span>  <span class="number">8</span>]</span><br><span class="line"> [ <span class="number">7</span> <span class="number">12</span> <span class="number">14</span>]]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å·ç§¯æ ¸ <code>kernel&#39;s</code> <code>size</code>,<code>padding</code> , <code>stride</code> ä¸ è¾“å…¥çŸ©é˜µ <code>input</code> å’Œè¾“å‡ºçŸ©é˜µ <code>output</code> å¤§å°çš„å¯¹åº”å…³ç³»ï¼š<br><img src="https://qiniu.oldzhangtech.com/mdpic/13a44c6b-038c-4851-acf6-e9310d02fc03_76d71cf8-f27f-4cb3-87cb-ae5cf16fe43f.png" alt="image.png"></p>
<blockquote>
<p>å¦‚æœæ˜¯ 3*3 çš„å·ç§¯æ ¸ï¼Œpadding&#x3D;1 stride&#x3D;1ï¼Œè¾“å…¥å’Œè¾“å‡ºçš„çŸ©é˜µå¤§å°ä¸€è‡´ã€‚</p>
</blockquote>
<p><em>å·ç§¯æ ¸</em><br>ä¸Šä¾‹ä¸­ï¼Œå·ç§¯æ ¸ï¼Œå°±æ˜¯ <code>kernel_array</code>ï¼Œ<code>[[1, 0, 0],[0, 1, 0],[0, 0, 1]]</code>ï¼Œä»–æ˜¯ 3X3 çš„å·ç§¯æ ¸ã€‚</p>
<p>ä» <a href="https://setosa.io/ev/image-kernels/">ç½‘ç«™</a> çŸ¥é“ï¼Œä¸åŒçš„å·ç§¯æ ¸åº”ç”¨åˆ°ç›¸åŒçš„å›¾ç‰‡ä¸Šï¼Œå¯ä»¥å¾—åˆ°ä¸åŒçš„ç»“æœã€‚æ¯”å¦‚æœ‰ä¸€äº›æ˜¯å¯ä»¥æå–è¾¹ç¼˜ç‰¹å¾ï¼Œæœ‰äº›æ˜¯å¯ä»¥æ¨¡ç³Šçš„ã€‚</p>
<p>ğŸ’Š å·ç§¯æ ¸ï¼Œå°±æ˜¯æå–ç‰¹å¾çš„çŸ©é˜µã€‚æœ‰å¤šå°‘ä¸ªå·ç§¯æ ¸ï¼Œå°±æ˜¯ä»£è¡¨æå–å¤šå°‘ä¸ªç‰¹å¾ã€‚ä¸åŒçš„å·ç§¯æ ¸å¯ä»¥æå–ä¸åŒçš„ç‰¹å¾ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç ï¼Œå°±æ˜¯ä½¿ç”¨é¢„è®¾çš„å·ç§¯æ ¸ï¼ˆæå–è¾¹ç¼˜è½®å»“ç‰¹å¾çš„å·ç§¯æ ¸ï¼‰å»è·å–ç‰¹å¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›´æ¥è¾“å‡ºçš„ç»“æœã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a sample input image (1, 1, 5, 5)</span></span><br><span class="line">input_image = torch.tensor([[[[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">                              [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>],</span><br><span class="line">                              [<span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">                              [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">                              [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>]]]], dtype=torch.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define a convolutional layer</span></span><br><span class="line">conv_layer = nn.Conv2d(in_channels=<span class="number">1</span>, out_channels=<span class="number">1</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize the kernel weights for demonstration purposes (e.g., edge detection kernel)</span></span><br><span class="line">edge_detection_kernel = torch.tensor([[[[-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>],</span><br><span class="line">                                        [-<span class="number">1</span>,  <span class="number">8</span>, -<span class="number">1</span>],</span><br><span class="line">                                        [-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>]]]], dtype=torch.float32)</span><br><span class="line">conv_layer.weight = torch.nn.Parameter(edge_detection_kernel)</span><br><span class="line">conv_layer.bias = torch.nn.Parameter(torch.zeros(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Apply the convolutional layer to the input image</span></span><br><span class="line">output_image = conv_layer(input_image)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Convert the output to a NumPy array for visualization</span></span><br><span class="line">output_image_np = output_image.detach().numpy().squeeze()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Visualize the input and output images</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize_images</span>(<span class="params">input_img, output_img</span>):</span><br><span class="line">    fig, axes = plt.subplots(<span class="number">1</span>, <span class="number">2</span>, figsize=(<span class="number">10</span>, <span class="number">5</span>))</span><br><span class="line">    axes[<span class="number">0</span>].imshow(input_img.squeeze(), cmap=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">    axes[<span class="number">0</span>].set_title(<span class="string">&#x27;Input Image&#x27;</span>)</span><br><span class="line">    axes[<span class="number">0</span>].axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    axes[<span class="number">1</span>].imshow(output_img, cmap=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">    axes[<span class="number">1</span>].set_title(<span class="string">&#x27;Output Image&#x27;</span>)</span><br><span class="line">    axes[<span class="number">1</span>].axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Display the images</span></span><br><span class="line">visualize_images(input_image, output_image_np)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Print the input and output values for comparison</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Input Image:\n&quot;</span>, input_image.squeeze().numpy())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nOutput Image:\n&quot;</span>, output_image_np)</span><br></pre></td></tr></table></figure>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/3423f3d3-a187-45cf-9aef-e5867ace1d1f_09bf874f-a2b9-4cc2-9c3a-287e72917b67.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Input Image:</span><br><span class="line"> [[<span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">0.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">3.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">0.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">0.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">0.</span>]]</span><br><span class="line"></span><br><span class="line">Output Image:</span><br><span class="line"> [[  <span class="number">5.</span>   <span class="number">9.</span>  <span class="number">16.</span> -<span class="number">10.</span>   <span class="number">4.</span>]</span><br><span class="line"> [ -<span class="number">7.</span>  -<span class="number">4.</span>   <span class="number">4.</span>  <span class="number">14.</span>   <span class="number">2.</span>]</span><br><span class="line"> [ <span class="number">20.</span> -<span class="number">13.</span>  -<span class="number">5.</span>   <span class="number">5.</span>  -<span class="number">7.</span>]</span><br><span class="line"> [  <span class="number">2.</span>   <span class="number">5.</span>  <span class="number">13.</span> -<span class="number">12.</span>   <span class="number">3.</span>]</span><br><span class="line"> [ -<span class="number">4.</span>   <span class="number">0.</span>   <span class="number">7.</span>  <span class="number">18.</span>  -<span class="number">4.</span>]]</span><br></pre></td></tr></table></figure>
<p>ä»ç»“æœçŸ¥é“ï¼ˆä»ç°åº¦å›¾çœ‹ä¸å‡ºé—®é¢˜ï¼Œä½†æ˜¯ä»æ•°å­—çŸ©é˜µå¯ä»¥çœ‹å‡ºï¼‰ï¼Œè¿™ä¸ªå·ç§¯æ ¸ä»¤åˆ° é»‘çš„æ›´åŠ çš„é»‘ï¼Œ ç™½çš„æ›´åŠ çš„ç™½ï¼Œçªå‡ºäº†ç‰¹å¾ã€‚</p>
<p><em>å·ç§¯çš„å¥½å¤„</em></p>
<ul>
<li>å…±äº«å‚æ•°</li>
</ul>
<p>å·ç§¯æ ¸ï¼Œå°±æ˜¯æ»‘è¿‡æ•°æ®çš„å…±äº«å‚æ•°ï¼Œé‚£ä¹ˆä»–èƒ½å¤Ÿæå–å¯¹åº”çš„ç‰¹å¾æ•°æ®ã€‚æ‰€ä»¥ä¸€ä¸ªå·ç§¯æ ¸å¯¹åº”ç€ä¸€ä¸ªç‰¹å¾ã€‚éœ€è¦æå–çš„ç‰¹å¾ï¼Œä¸è®ºæ˜¯åœ¨å›¾ç‰‡çš„å“ªä¸ªä½ç½®ï¼Œéƒ½å¯ä»¥æå–å‡ºæ¥ã€‚</p>
<ul>
<li>å‚æ•°å‡å°‘</li>
</ul>
<p>æ¯”å¦‚ 100 * 100 çš„å›¾åƒï¼Œè¦å»è¯†åˆ«è‹¹æœï¼Œä½†æ˜¯è¿™ä¸ªè‹¹æœæœ‰å¯èƒ½å‡ºç°åœ¨ä¸Šä¸‹å·¦å³ï¼Œéšæœºçš„ä½ç½®ã€‚<br>å¦‚æœä½¿ç”¨ <code>NN</code> ç¥ç»ç½‘ç»œ å°±è¦ä½¿ç”¨ (100 * 100, n, n) ç½‘ç»œï¼Œ ç½‘ç»œçš„è¾“å…¥æ˜¯æ¯ä¸ªåæ ‡åƒç´ ã€‚ä½†æ˜¯è‹¹æœçš„å‡ºç°çš„ä½ç½®æ˜¯éšæœºçš„ï¼Œå³åæ ‡æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥å¯¹åº”çš„ç¥ç»å…ƒä¹Ÿæ˜¯éœ€è¦å­¦ä¹ ï¼Œå¯¼è‡´éå¸¸éš¾æ”¶æ•›ã€‚åŒæ—¶ï¼Œå‚æ•°é‡å°±æ˜¯å·¨å¤§çš„ï¼Œè¾¾åˆ° 10000 * n * nã€‚<br>ä½†æ˜¯ä½¿ç”¨ <code>CNN</code>ï¼Œå¯ä»¥é’ˆå¯¹ è‹¹æœè½®å»“ è®­ç»ƒ å¯¹åº”å·ç§¯æ ¸ï¼Œè¾¾åˆ°è¯†åˆ«çš„æ•ˆæœï¼Œå°±å¤§å¤§å‡å°‘å‚æ•°é‡ã€‚å‚æ•°é‡å°±æ˜¯ å·ç§¯æ ¸ä¸Šçš„æ•°å€¼ å’Œ åç»­çš„é«˜ç»´åº¦çš„å…¨é“¾æ¥ç½‘ç»œçš„å‚æ•°ã€‚</p>
<ul>
<li>ä½ç½®ä¿¡æ¯çš„å…±äº«</li>
</ul>
<p>å¦‚æœä¸Šä¾‹å­ä¸­ï¼Œè‹¹æœè½®å»“ä¿¡æ¯æ˜¯å…±äº«çš„ã€‚</p>
<h2 id="æ± åŒ–"><a href="#æ± åŒ–" class="headerlink" title="æ± åŒ–"></a>æ± åŒ–</h2><p>æœ‰å¹³å‡æ± åŒ–å’Œæœ€å¤§å€¼æ± åŒ–ï¼Œä»– <strong>æ²¡æœ‰å‚æ•°å­¦ä¹ </strong>ï¼Œå®Œå…¨æ˜¯æŒ‰ç…§é»˜è®¤çš„é€»è¾‘å»è¿è¡Œçš„ã€‚</p>
<ul>
<li>å¹³å‡æ± åŒ–ï¼Œå–å¹³å‡å€¼ï¼Œä¼šæ¨¡ç³Šç‰¹å¾ï¼Œä»–å¯ä»¥è€ƒè™‘åˆ°æ‰€æœ‰åƒç´ çš„å…³ç³»ï¼›</li>
<li>æœ€å¤§å€¼æ± åŒ–ï¼Œå–æœ€å¤§å€¼ï¼Œå°±çªå‡ºäº†ç‰¹å¾äº†ï¼Œå®Œå…¨æ˜¯å¿½è§†äº†æœ€å°å€¼ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Input_array:</span><br><span class="line">[[ <span class="number">1.</span>  <span class="number">2.</span>  <span class="number">3.</span>  <span class="number">4.</span>]</span><br><span class="line"> [ <span class="number">5.</span>  <span class="number">6.</span>  <span class="number">7.</span>  <span class="number">8.</span>]</span><br><span class="line"> [ <span class="number">9.</span> <span class="number">10.</span> <span class="number">11.</span> <span class="number">12.</span>]</span><br><span class="line"> [<span class="number">13.</span> <span class="number">14.</span> <span class="number">15.</span> <span class="number">16.</span>]]</span><br><span class="line"></span><br><span class="line">åº”ç”¨ kernel_size=<span class="number">2</span>, stride=<span class="number">2</span> çš„ æ± åŒ–</span><br><span class="line"></span><br><span class="line">Average Pooled Image:</span><br><span class="line"> [[ <span class="number">3.5</span>  <span class="number">5.5</span>]</span><br><span class="line"> [<span class="number">11.5</span> <span class="number">13.5</span>]]</span><br><span class="line"></span><br><span class="line">Max Pooled Image:</span><br><span class="line"> [[ <span class="number">6.</span>  <span class="number">8.</span>]</span><br><span class="line"> [<span class="number">14.</span> <span class="number">16.</span>]]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä»ç»“æœçŸ¥é“ï¼Œå¦‚æœæ± åŒ–åï¼Œè®¡ç®—é‡æ˜¯åŠ ä¸Šäº† 3&#x2F;4ï¼ŒåŒæ—¶å¯ä»¥ä¿ç•™åŸæ¥å›¾åƒçš„ç‰¹å¾ã€‚</p>
<p><em>æ± åŒ–å¥½å¤„</em><br>å°±æ˜¯ä¸ºäº†å‡å°‘è¿ç®—é‡ï¼Œè€Œä¸”æ²¡æœ‰å‚æ•°ï¼Œä¸ç”¨å­¦ä¹ ã€‚æ¢ä¸€å¥è¯ï¼Œæœ‰å¾ˆå¤šçš„æ•°æ®æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œè®¡ç®—ä»–ä»¬æŠ•å…¥äº§å‡ºæ¯”å¤ªä½ï¼Œä¸å¦‚ç›´æ¥æ”¾å¼ƒã€‚</p>
<h2 id="æ‰‹å†™ç®€å•-CNN-ç½‘ç»œ"><a href="#æ‰‹å†™ç®€å•-CNN-ç½‘ç»œ" class="headerlink" title="æ‰‹å†™ç®€å• CNN ç½‘ç»œ"></a>æ‰‹å†™ç®€å• CNN ç½‘ç»œ</h2><p>ç»„è£… <em>å·ç§¯</em> å’Œ _æ± åŒ– _çš„ä¸€ä¸ªç½‘ç»œï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„ <code>CNN</code> ç½‘ç»œï¼Œæ¯”å¦‚ ä»¥ä¸‹çš„ä»£ç å°±æ˜¯ä¸€ä¸ªç®€å•çš„ å·ç§¯å’Œæ± åŒ–æ“ä½œç›¸ç»“åˆã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># éƒ¨åˆ†ä»£ç çš„æ¼”ç¤º</span></span><br><span class="line"><span class="comment"># conv å®šä¹‰å·ç§¯</span></span><br><span class="line">conv = .Conv2d(<span class="number">1</span>, <span class="number">32</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span></span><br><span class="line"><span class="comment"># pool å®šä¹‰æ± åŒ–</span></span><br><span class="line">pool = nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“åˆæ¿€æ´»å‡½æ•°</span></span><br><span class="line">x = pool(relu(conv(x)))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ‰€æœ‰æ¨¡å‹ï¼ˆåŒ…æ‹¬ <code>NN</code>ï¼Œ<code>CNN</code>ï¼Œ<code>AlexNet</code>ï¼Œ<code>ResNet</code>ï¼Œ<code>RNN</code> ç­‰ ï¼‰ï¼Œéƒ½æ˜¯ä¸€ä¸ªä¸ªçš„å­ç»„ä»¶çš„ç»„è£…ï¼Œå°±å¥½åƒç§¯æœ¨ä¸€æ ·ã€‚æ‰€ä»¥ç†è§£å¥½ä¸åŒçš„ å­ç»„ä»¶çš„åŸç†å’Œç”¨æ³•ï¼Œå°±æ›´åŠ å®¹æ˜“ç†è§£ç”±ä»–ä»¬ç»„è£…è€Œæˆçš„å¤§æ¨¡å‹ã€‚</p>
</blockquote>
<h3 id="å®Œæ•´ä»£ç æ£€æµ‹æ‰‹å†™æ•°å­—çš„å›¾ç‰‡"><a href="#å®Œæ•´ä»£ç æ£€æµ‹æ‰‹å†™æ•°å­—çš„å›¾ç‰‡" class="headerlink" title="å®Œæ•´ä»£ç æ£€æµ‹æ‰‹å†™æ•°å­—çš„å›¾ç‰‡"></a>å®Œæ•´ä»£ç æ£€æµ‹æ‰‹å†™æ•°å­—çš„å›¾ç‰‡</h3><p>å¯¼å…¥æ‰‹å†™æ•°å­—çš„å›¾ç‰‡åº“ï¼ŒåŒæ—¶ä½¿ç”¨ä¸€ä¸ª ç®€å•çš„ CNN æ¥è®­ç»ƒ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define the CNN model</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleCNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(SimpleCNN, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">32</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.pool = nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line">        <span class="variable language_">self</span>.conv2 = nn.Conv2d(<span class="number">32</span>, <span class="number">64</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc1 = nn.Linear(<span class="number">64</span> * <span class="number">7</span> * <span class="number">7</span>, <span class="number">64</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc2 = nn.Linear(<span class="number">64</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = <span class="variable language_">self</span>.pool(F.relu(<span class="variable language_">self</span>.conv1(x)))</span><br><span class="line">        x = <span class="variable language_">self</span>.pool(F.relu(<span class="variable language_">self</span>.conv2(x)))</span><br><span class="line">        x = x.view(-<span class="number">1</span>, <span class="number">64</span> * <span class="number">7</span> * <span class="number">7</span>)</span><br><span class="line">        x = F.relu(<span class="variable language_">self</span>.fc1(x))</span><br><span class="line">        x = <span class="variable language_">self</span>.fc2(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load and preprocess the MNIST dataset</span></span><br><span class="line">transform = transforms.Compose([</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    transforms.Normalize((<span class="number">0.5</span>,), (<span class="number">0.5</span>,))</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">trainset = torchvision.datasets.MNIST(root=<span class="string">&#x27;../data/mnist&#x27;</span>, train=<span class="literal">True</span>, download=<span class="literal">True</span>, transform=transform)</span><br><span class="line">trainloader = DataLoader(trainset, batch_size=<span class="number">64</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">testset = torchvision.datasets.MNIST(root=<span class="string">&#x27;../data/mnist&#x27;</span>, train=<span class="literal">False</span>, download=<span class="literal">True</span>, transform=transform)</span><br><span class="line">testloader = DataLoader(testset, batch_size=<span class="number">64</span>, shuffle=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Instantiate the model, define the loss function and the optimizer</span></span><br><span class="line">model = SimpleCNN()</span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = optim.SGD(model.parameters(), lr=<span class="number">0.001</span>, momentum=<span class="number">0.9</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Training loop</span></span><br><span class="line">num_epochs = <span class="number">5</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">    running_loss = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(trainloader, <span class="number">0</span>):</span><br><span class="line">        inputs, labels = data</span><br><span class="line">        </span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        </span><br><span class="line">        outputs = model(inputs)</span><br><span class="line">        loss = criterion(outputs, labels)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">        </span><br><span class="line">        running_loss += loss.item()</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">100</span> == <span class="number">99</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[Epoch <span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>, Batch <span class="subst">&#123;i + <span class="number">1</span>&#125;</span>] loss: <span class="subst">&#123;running_loss / <span class="number">100</span>:<span class="number">.3</span>f&#125;</span>&#x27;</span>)</span><br><span class="line">            running_loss = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Finished Training&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test the model</span></span><br><span class="line">correct = <span class="number">0</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> testloader:</span><br><span class="line">        images, labels = data</span><br><span class="line">        outputs = model(images)</span><br><span class="line">        _, predicted = torch.<span class="built_in">max</span>(outputs.data, <span class="number">1</span>)</span><br><span class="line">        total += labels.size(<span class="number">0</span>)</span><br><span class="line">        correct += (predicted == labels).<span class="built_in">sum</span>().item()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;Accuracy of the network on the 10000 test images: <span class="subst">&#123;<span class="number">100</span> * correct / total:<span class="number">.2</span>f&#125;</span>%&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># éƒ¨åˆ†æ‰“å°</span></span><br><span class="line"><span class="string">[Epoch 5, Batch 600] loss: 0.075</span></span><br><span class="line"><span class="string">[Epoch 5, Batch 700] loss: 0.093</span></span><br><span class="line"><span class="string">[Epoch 5, Batch 800] loss: 0.074</span></span><br><span class="line"><span class="string">[Epoch 5, Batch 900] loss: 0.081</span></span><br><span class="line"><span class="string">Finished Training</span></span><br><span class="line"><span class="string">Accuracy of the network on the 10000 test images: 98.08%</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ¨¡å‹è®­ç»ƒçš„ç»“æœæ˜¯å¦äººæ»¡æ„çš„ã€‚</p>
<h3 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h3><p>ä¸Šé¢çš„ä¾‹å­ï¼Œå·²ç»è¯´æ˜äº† CNN çš„æ•´ä½“çš„æ¡†æ¶ã€‚</p>
<p><em>ç»“æ„å›¾</em><br><img src="https://qiniu.oldzhangtech.com/mdpic/9a6823f2-13ed-4c75-ad84-17d4c79c27b6_1666cf21-784f-4e6f-8991-32451823b357.png" alt="image.png"><br>é¢å¯¹ åˆ†ç±»ä»»åŠ¡ï¼Œä¸»ä½“ä¸Šåˆ†æˆä¸¤å±‚ï¼š Feature Extraction ç‰¹å¾æå– å’Œ Classification åˆ†ç±»<br><code>Feature Extraction</code>ï¼š input å°±æ˜¯è¾“å…¥çš„æ•°æ®ï¼ŒConvolution å°±æ˜¯å·ç§¯ï¼ŒPooling å°±æ˜¯æ± åŒ–ï¼Œåˆ°è¿™æ­¥ä¸ºæ­¢ï¼Œå°±æ˜¯ä»ä½ç»´åº¦ç‰¹å¾çš„æå–ã€‚<br><code>Classification</code>ï¼šä¹‹åå¯¹æå–åçš„ç‰¹å¾è¿›è¡Œ é«˜ç»´å…¨ç½‘ç»œå­¦ä¹  å’Œ softmax è¿›è¡Œåˆ†ç±»ã€‚</p>
<p><em>ä¸€å¥è¯åŸç†</em></p>
<ol>
<li><strong>å…¨æ•°æ®</strong>å…ˆç”¨<strong>å·ç§¯</strong>æå–<strong>ç‰¹å¾ï¼Œå†ä½¿ç”¨ æ± åŒ–å±‚ è¿›è¡Œæ•°æ®é‡çš„ç®€åŒ–ï¼ŒåŒæ—¶ä¿ç•™ç‰¹å¾</strong></li>
<li><strong>ç‰¹å¾</strong>å†ç”¨<strong>å…¨é“¾æ¥</strong>å­¦ä¹ è§„å¾‹<blockquote>
<p>æ€»ç»“æˆä¸€å¥è¯å°±æ˜¯ï¼Œæ¯ä¸ªç»„ä»¶éƒ½åœ¨è‡ªå·±æ“…é•¿ä¸œè¥¿ã€‚</p>
</blockquote>
</li>
</ol>
<p>â“å·ç§¯æ ¸çš„ <code>out_channel</code> æ˜¯å¦é‡è¦ï¼Ÿ</p>
<blockquote>
<p><code>nn.Conv2d(32, 64, kernel_size=3, padding=1)</code> ä¸­çš„ <code>64</code> å°±æ˜¯ <code>out_channel</code></p>
</blockquote>
<p>é‡è¦ï¼Œä»–æ˜¯å†³å®šäº†å¤šå°‘ä¸ªå·ç§¯æ ¸ï¼Œå³å¤šå°‘ä¸ª features å¯ä»¥ç»™æå–ã€‚</p>
<p>é¢˜å¤–è¯ï¼Œå·ç§¯æ ¸çš„ <code>size</code>ï¼Œæ˜¯å†³å®šäº†ä»–å¯ä»¥è¯†åˆ«çš„èŒƒå›´ï¼ˆæ¥æ”¶é‡ receptive fieldï¼‰ï¼Œæ¯”å¦‚ å°çš„å·ç§¯æ ¸ï¼Œå°±å¯ä»¥è¯†åˆ«ç²¾ç»†çš„ç‰¹å¾ï¼›å¤§çš„ï¼Œå¯ä»¥è¯†åˆ«è½®å»“çš„ç‰¹å¾ã€‚</p>
<p>â“å·ç§¯æ ¸çš„å‚æ•°æ˜¯å­¦ä¹ è€Œæ¥ï¼Œè¿˜æ˜¯é¢„è®¾å®šçš„å‘¢ï¼Ÿ<br>å¯ä»¥é¢„è®¾ï¼Œä¹Ÿå¯ä»¥å­¦ä¹ è€Œæ¥çš„ã€‚<br>ä½†æ˜¯åœ¨ CNN ä¸­ï¼Œå°½é‡<strong>ä¸ç”¨</strong>æŒ‡å®šå·ç§¯æ ¸ï¼Œè®©ä»–å»è¿›è¡Œè®­ç»ƒä¹ å¾—ã€‚ </p>
<h2 id="ç®€è¦æ€»ç»“"><a href="#ç®€è¦æ€»ç»“" class="headerlink" title="ç®€è¦æ€»ç»“"></a>ç®€è¦æ€»ç»“</h2><p><em>å·ç§¯</em></p>
<ol>
<li>å…±äº«å‚æ•°</li>
<li>å‚æ•°å‡å°‘</li>
<li>å¯ä»¥æœ‰ä½ç½®ä¿¡æ¯çš„å…±äº«</li>
</ol>
<p><em>å·ç§¯æ ¸</em></p>
<ol>
<li>out_channel å†³å®šäº†æå–å¤šå°‘ä¸ªç‰¹å¾</li>
<li>kernel_size å†³å®šä½ æœ‰å¤šå°‘çš„è§†é‡</li>
</ol>
<p>_æ± åŒ–_ï¼Œå°±æ˜¯ä¸ºäº†ç®€åŒ–æ•°é‡çš„åŒæ—¶ï¼Œåˆå¯ä»¥ä¿ç•™ç‰¹å¾ï¼›_å…¨é“¾æ¥å±‚_ï¼Œå¯¹æŠ½å–çš„ç‰¹å¾è¿›è¡Œå­¦ä¹ ã€‚</p>
<p>_CNN _å°±æ˜¯ç»„åˆä¸Šè¿°ç»„ä»¶ï¼Œå½¢æˆä¸€ä¸ªå¤§çš„ç½‘ç»œã€‚</p>
<h2 id="ä¼˜ç¼ºç‚¹å’Œåœºæ™¯"><a href="#ä¼˜ç¼ºç‚¹å’Œåœºæ™¯" class="headerlink" title="ä¼˜ç¼ºç‚¹å’Œåœºæ™¯"></a>ä¼˜ç¼ºç‚¹å’Œåœºæ™¯</h2><ol>
<li>æœ‰ç©ºé—´ä½ç½®ä¿¡æ¯ï¼Œå°±å¯ä»¥ä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œ</li>
<li>ç‰¹åˆ«å›¾åƒè¯†åˆ«</li>
</ol>
]]></content>
      <categories>
        <category>å­¦è‚¥AI</category>
      </categories>
      <tags>
        <tag>å­¦è‚¥AI</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>CNN</tag>
        <tag>NN</tag>
        <tag>å·ç§¯ç¥ç»ç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title>CNN ä¸€äº›ä¾‹å­-å…¶ä¸­åŒ…æ‹¬ LeNet</title>
    <url>/2024/08/02/%5B%E5%AD%A6%E8%82%A5AI%5D%20CNN%20%E4%B8%80%E4%BA%9B%E4%BE%8B%E5%AD%90-%E5%85%B6%E4%B8%AD%E5%8C%85%E6%8B%AC%20LeNet/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯é—®é¢˜"><a href="#èƒŒæ™¯é—®é¢˜" class="headerlink" title="èƒŒæ™¯é—®é¢˜"></a>èƒŒæ™¯é—®é¢˜</h2><p>å‰æ–‡ä¸­å·²ç»å¯¹ CNN ç»„ä»¶ ä»¥åŠæ•´ä½“çš„æ•°æ®æµåŠ¨æœ‰äº†è§£ï¼Œæœ‰éœ€è¦çš„å¯ä»¥ç¿»çœ‹ä¹‹å‰çš„<a href="https://blog.csdn.net/weixin_49113487/article/details/140717493?spm=1001.2014.3001.5501">æ–‡ç« </a>ï¼Œåé¢æˆ‘ä»¬ç›´æ¥åº”ç”¨ CNN æ¥è§£å†³å®é™…é—®é¢˜ï¼ŒåŠ¨æ‰‹æ“ä½œæ‰æ˜¯å­¦ä¹ çš„æ ¹æœ¬ã€‚</p>
<p>æœ¬ç¯‡çš„æ‰€æœ‰çš„ä¾‹å­ï¼Œè¯¦ç»†çš„ <code>ipynb</code> éƒ½å¯ä»¥ä»ä¸‹é¢é“¾æ¥ä¸­æ‰¾åˆ°ã€‚ NNvsCNN <a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/cnn_compareNN.ipynb">ipynb é“¾æ¥</a>ï¼Œè¯†åˆ«å›¾å½¢ <a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/cnn_classify_triangleCycleRectangle.ipynb">ipynb é“¾æ¥</a>ã€‚</p>
<h2 id="NN-vs-CNN"><a href="#NN-vs-CNN" class="headerlink" title="NN vs CNN"></a>NN vs CNN</h2><p>æœ¬ä¾‹å­çš„ç›®çš„æ˜¯ï¼šåŒæ ·é¢å¯¹ <code>mnist</code> æ‰‹å†™æ•°å­—æ•°æ®é›†çš„æ—¶å€™ï¼Œå¯¹æ¯” ä½¿ç”¨ <code>NN</code> å’Œ ä½¿ç”¨ <code>CNN</code> ï¼Œçœ‹ä¸€ä¸‹ä»–ä»¬è¡¨ç°çš„å·®å¼‚ã€‚å¯è¿è¡Œæ–‡ä»¶ <code>ipynb</code> çš„<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/cnn_compareNN.ipynb">é“¾æ¥</a>ã€‚</p>
<h3 id="prepare-data"><a href="#prepare-data" class="headerlink" title="prepare data"></a>prepare data</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"></span><br><span class="line"><span class="comment"># %%</span></span><br><span class="line">transformation = torchvision.transforms.ToTensor()</span><br><span class="line"><span class="comment"># æ‰§è¡Œè°ƒæ•´æ–‡ä»¶çš„ä½ç½®</span></span><br><span class="line">train_dataset = torchvision.datasets.MNIST(root=<span class="string">&#x27;../data/mnist/&#x27;</span>, train=<span class="literal">True</span>, download=<span class="literal">True</span>, transform=transformation)</span><br><span class="line">test_dataset = torchvision.datasets.MNIST(root=<span class="string">&#x27;../data/mnist/&#x27;</span>, train=<span class="literal">False</span>, download=<span class="literal">True</span>, transform=transformation)</span><br><span class="line"></span><br><span class="line">batch_size = <span class="number">64</span></span><br><span class="line">train_dataloader = torch.utils.data.DataLoader(train_dataset, batch_size=batch_size, shuffle=<span class="literal">True</span>)</span><br><span class="line">test_dataloader = torch.utils.data.DataLoader(test_dataset, batch_size=batch_size, shuffle=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<h3 id="NN-çš„å®ç°"><a href="#NN-çš„å®ç°" class="headerlink" title="NN çš„å®ç°"></a>NN çš„å®ç°</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> torchinfo <span class="keyword">import</span> summary</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> * <span class="comment"># tqdmç”¨äºæ˜¾ç¤ºè¿›åº¦æ¡å¹¶è¯„ä¼°ä»»åŠ¡æ—¶é—´å¼€é”€</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_size, hidden_sizes, output_size</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.fcin = nn.Linear(input_size, hidden_sizes[<span class="number">0</span>]) <span class="keyword">if</span> hidden_sizes <span class="keyword">else</span> nn.Linear(input_size, output_size)</span><br><span class="line">        <span class="variable language_">self</span>.fcout = nn.Linear(hidden_sizes[-<span class="number">1</span>], output_size) <span class="keyword">if</span> hidden_sizes <span class="keyword">else</span> nn.Identity()</span><br><span class="line">        <span class="variable language_">self</span>.relu = nn.ReLU()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create a list of intermediate layers</span></span><br><span class="line">        layers = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(hidden_sizes) - <span class="number">1</span>):</span><br><span class="line">            layers.append(nn.Linear(hidden_sizes[i], hidden_sizes[i+<span class="number">1</span>]))</span><br><span class="line">            layers.append(nn.ReLU())</span><br><span class="line">        <span class="comment"># Convert the list of layers into a Sequential module</span></span><br><span class="line">        <span class="variable language_">self</span>.hidden_layers = nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">     </span><br><span class="line">        out = <span class="variable language_">self</span>.fcin(x)</span><br><span class="line">        out = <span class="variable language_">self</span>.relu(out)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Pass through the hidden layers</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.hidden_layers) &gt; <span class="number">0</span>:</span><br><span class="line">            out = <span class="variable language_">self</span>.hidden_layers(out)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å°†ä¸Šä¸€æ­¥ç»“æœä¼ é€’ç»™fcout</span></span><br><span class="line">        out = <span class="variable language_">self</span>.fcout(out)</span><br><span class="line">        <span class="comment"># è¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="comment"># %%</span></span><br><span class="line">input_size = <span class="number">28</span>*<span class="number">28</span></span><br><span class="line">output_size = <span class="number">10</span></span><br><span class="line">model = NNet(input_size, [<span class="number">512</span>, <span class="number">512</span>], output_size)</span><br><span class="line"><span class="built_in">print</span>(summary(model))</span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = torch.optim.SGD(model.parameters(), lr=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">model, data_loader</span>):</span><br><span class="line"><span class="comment">#     è¯„ä¼°</span></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    correct = <span class="number">0</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> x, y <span class="keyword">in</span> data_loader:</span><br><span class="line">            x = x.view(-<span class="number">1</span>, input_size)</span><br><span class="line">            logits = model(x)</span><br><span class="line"><span class="comment">#             _ æ˜¯ value ï¼Œ predicted æ˜¯ index</span></span><br><span class="line">            _, predicted = torch.<span class="built_in">max</span>(logits.data, <span class="number">1</span>)</span><br><span class="line">            total += y.size(<span class="number">0</span>)</span><br><span class="line">            correct += (predicted == y).<span class="built_in">sum</span>().item()</span><br><span class="line">    <span class="keyword">return</span> correct / total</span><br><span class="line"></span><br><span class="line">loss_history = []  <span class="comment"># åˆ›å»ºæŸå¤±å†å²è®°å½•åˆ—è¡¨</span></span><br><span class="line">acc_history = []   <span class="comment"># åˆ›å»ºå‡†ç¡®ç‡å†å²è®°å½•åˆ—è¡¨</span></span><br><span class="line">num_epochs = <span class="number">10</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(num_epochs), file=sys.stdout):</span><br><span class="line">    <span class="comment"># è®°å½•æŸå¤±å’Œé¢„æµ‹æ­£ç¡®æ•°</span></span><br><span class="line">    total_loss = <span class="number">0</span></span><br><span class="line">    total_correct = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    model.train()</span><br><span class="line">    <span class="keyword">for</span> images, labels <span class="keyword">in</span> train_dataloader:</span><br><span class="line">        <span class="comment"># å°†å›¾åƒå’Œæ ‡ç­¾è½¬æ¢æˆå¼ é‡</span></span><br><span class="line">        <span class="comment"># [64, 1, 28, 28] -&gt; [64, 784]</span></span><br><span class="line">        images = images.view(-<span class="number">1</span>, <span class="number">28</span>*<span class="number">28</span>)  </span><br><span class="line">        labels = labels.long()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å‰å‘ä¼ æ’­</span></span><br><span class="line">        outputs = model(images)</span><br><span class="line">        loss = criterion(outputs, labels)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•è®­ç»ƒé›†loss</span></span><br><span class="line">        total_loss += loss.item()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åå‘ä¼ æ’­å’Œä¼˜åŒ–</span></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">    loss_history.append(np.log10(total_loss))    </span><br><span class="line">    accuracy = evaluate(model, test_dataloader)</span><br><span class="line">    acc_history.append(accuracy)</span><br><span class="line">    <span class="keyword">if</span>(epoch%<span class="number">3</span> == <span class="number">0</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Epoch <span class="subst">&#123;epoch+<span class="number">1</span>&#125;</span>: test accuracy = <span class="subst">&#123;acc_history[-<span class="number">1</span>]:<span class="number">.2</span>f&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨Matplotlibç»˜åˆ¶æŸå¤±å’Œå‡†ç¡®ç‡çš„æ›²çº¿å›¾</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.plot(loss_history, label=<span class="string">&#x27;loss&#x27;</span>)</span><br><span class="line">plt.plot(acc_history, label=<span class="string">&#x27;accuracy&#x27;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºå‡†ç¡®ç‡</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Accuracy:&quot;</span>, acc_history[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/55ff4334-4439-494f-aa82-709af8e79db0_d98edf1a-29fd-456c-8a2e-8e4b28464ff6.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># éƒ¨åˆ†çš„è¾“å‡º</span></span><br><span class="line">Accuracy: <span class="number">0.9422</span></span><br></pre></td></tr></table></figure>
<h3 id="CNN-çš„å®ç°"><a href="#CNN-çš„å®ç°" class="headerlink" title="CNN çš„å®ç°"></a>CNN çš„å®ç°</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥å¿…è¦çš„åº“ï¼Œtorchinfoç”¨äºæŸ¥çœ‹æ¨¡å‹ç»“æ„</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torchinfo <span class="keyword">import</span> summary</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰LeNetçš„ç½‘ç»œç»“æ„</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleCnnNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_classes=<span class="number">10</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SimpleCnnNet, <span class="variable language_">self</span>).__init__()</span><br><span class="line"><span class="comment">#         æ­¥é•¿é»˜è®¤ä¸º1ï¼Œå¡«å……é»˜è®¤ä¸º0 ä¸€å®šè¦è®°å¾—</span></span><br><span class="line">        <span class="variable language_">self</span>.conv1 = nn.Conv2d(in_channels=<span class="number">1</span>, out_channels=<span class="number">6</span>, kernel_size=<span class="number">5</span>)</span><br><span class="line">        <span class="comment"># å·ç§¯å±‚2ï¼šè¾“å…¥6ä¸ªé€šé“ï¼Œè¾“å‡º16ä¸ªé€šé“ï¼Œå·ç§¯æ ¸å¤§å°ä¸º5x5</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.conv2 = nn.Conv2d(in_channels=<span class="number">6</span>, out_channels=<span class="number">16</span>, kernel_size=<span class="number">5</span>)</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚1ï¼šè¾“å…¥16x4x4=256ä¸ªèŠ‚ç‚¹ï¼Œè¾“å‡º120ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="variable language_">self</span>.fc1 = nn.Linear(in_features=<span class="number">16</span> * <span class="number">4</span> * <span class="number">4</span>, out_features=<span class="number">120</span>)</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚2ï¼šè¾“å…¥120ä¸ªèŠ‚ç‚¹ï¼Œè¾“å‡º84ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="variable language_">self</span>.fc2 = nn.Linear(in_features=<span class="number">120</span>, out_features=<span class="number">84</span>)</span><br><span class="line">        <span class="comment"># è¾“å‡ºå±‚ï¼šè¾“å…¥84ä¸ªèŠ‚ç‚¹ï¼Œè¾“å‡º10ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="variable language_">self</span>.fc3 = nn.Linear(in_features=<span class="number">84</span>, out_features=num_classes)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ReLUæ¿€æ´»å‡½æ•°ï¼Œå¹¶è¿›è¡Œæœ€å¤§æ± åŒ–</span></span><br><span class="line">        x = torch.relu(<span class="variable language_">self</span>.conv1(x)) </span><br><span class="line">        <span class="comment"># input: 1,28,28, output: 6,24,24</span></span><br><span class="line">        <span class="comment"># output è®¡ç®—é€»è¾‘ï¼š(28-5+2*0)/1 + 1 = 24</span></span><br><span class="line">        x = nn.functional.max_pool2d(x, kernel_size=<span class="number">2</span>)  <span class="comment"># output: 6,12,12</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ReLUæ¿€æ´»å‡½æ•°ï¼Œå¹¶è¿›è¡Œæœ€å¤§æ± åŒ–</span></span><br><span class="line">        x = torch.relu(<span class="variable language_">self</span>.conv2(x))  </span><br><span class="line">        <span class="comment"># input: 6,12,12, output: 16,8,8</span></span><br><span class="line">        <span class="comment"># output è®¡ç®—é€»è¾‘ï¼š(12-5+2*0)/1 + 1 = 8</span></span><br><span class="line">        x = nn.functional.max_pool2d(x, kernel_size=<span class="number">2</span>)  </span><br><span class="line">        <span class="comment"># output: 16,4,4</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å°†å¤šç»´å¼ é‡å±•å¹³ä¸ºä¸€ç»´å¼ é‡</span></span><br><span class="line">        x = x.view(-<span class="number">1</span>, <span class="number">16</span> * <span class="number">4</span> * <span class="number">4</span>)</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚</span></span><br><span class="line">        x = torch.relu(<span class="variable language_">self</span>.fc1(x))</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚</span></span><br><span class="line">        x = torch.relu(<span class="variable language_">self</span>.fc2(x))</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚</span></span><br><span class="line">        x = <span class="variable language_">self</span>.fc3(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    </span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¨¡å‹ç»“æ„åŠå‚æ•°é‡ï¼Œinput_sizeè¡¨ç¤ºç¤ºä¾‹è¾“å…¥æ•°æ®çš„ç»´åº¦ä¿¡æ¯</span></span><br><span class="line"><span class="built_in">print</span>(summary(SimpleCnnNet(), input_size=(<span class="number">1</span>, <span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥å¿…è¦çš„åº“</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> datasets, transforms</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> * <span class="comment"># tqdmç”¨äºæ˜¾ç¤ºè¿›åº¦æ¡å¹¶è¯„ä¼°ä»»åŠ¡æ—¶é—´å¼€é”€</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®éšæœºç§å­</span></span><br><span class="line">torch.manual_seed(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ¨¡å‹ã€ä¼˜åŒ–å™¨ã€æŸå¤±å‡½æ•°</span></span><br><span class="line">model = SimpleCnnNet()</span><br><span class="line">optimizer = optim.SGD(model.parameters(), lr=<span class="number">0.02</span>)</span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ•°æ®å˜æ¢å’Œæ•°æ®åŠ è½½å™¨</span></span><br><span class="line">transform = transforms.Compose([</span><br><span class="line">    transforms.ToTensor(),  <span class="comment"># å°†æ•°æ®è½¬æ¢ä¸ºå¼ é‡</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®epochæ•°å¹¶å¼€å§‹è®­ç»ƒ</span></span><br><span class="line">num_epochs = <span class="number">10</span>  <span class="comment"># è®¾ç½®epochæ•°</span></span><br><span class="line">loss_history = []  <span class="comment"># åˆ›å»ºæŸå¤±å†å²è®°å½•åˆ—è¡¨</span></span><br><span class="line">acc_history = []   <span class="comment"># åˆ›å»ºå‡†ç¡®ç‡å†å²è®°å½•åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tqdmç”¨äºæ˜¾ç¤ºè¿›åº¦æ¡å¹¶è¯„ä¼°ä»»åŠ¡æ—¶é—´å¼€é”€</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(num_epochs), file=sys.stdout):</span><br><span class="line">    <span class="comment"># è®°å½•æŸå¤±å’Œé¢„æµ‹æ­£ç¡®æ•°</span></span><br><span class="line">    total_loss = <span class="number">0</span></span><br><span class="line">    total_correct = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ‰¹é‡è®­ç»ƒ</span></span><br><span class="line">    model.train()</span><br><span class="line">    <span class="keyword">for</span> inputs, labels <span class="keyword">in</span> train_dataloader:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é¢„æµ‹ã€æŸå¤±å‡½æ•°ã€åå‘ä¼ æ’­</span></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        outputs = model(inputs)</span><br><span class="line">        loss = criterion(outputs, labels)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•è®­ç»ƒé›†loss</span></span><br><span class="line">        total_loss += loss.item()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æµ‹è¯•æ¨¡å‹ï¼Œä¸è®¡ç®—æ¢¯åº¦</span></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> inputs, labels <span class="keyword">in</span> test_dataloader:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># é¢„æµ‹</span></span><br><span class="line">            outputs = model(inputs)</span><br><span class="line">            <span class="comment"># è®°å½•æµ‹è¯•é›†é¢„æµ‹æ­£ç¡®æ•°</span></span><br><span class="line">            total_correct += (outputs.argmax(<span class="number">1</span>) == labels).<span class="built_in">sum</span>().item()</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># è®°å½•è®­ç»ƒé›†æŸå¤±å’Œæµ‹è¯•é›†å‡†ç¡®ç‡</span></span><br><span class="line">    loss_history.append(np.log10(total_loss))  <span class="comment"># å°†æŸå¤±åŠ å…¥æŸå¤±å†å²è®°å½•åˆ—è¡¨ï¼Œç”±äºæ•°å€¼æœ‰æ—¶è¾ƒå¤§ï¼Œè¿™é‡Œå–å¯¹æ•°</span></span><br><span class="line">    acc_history.append(total_correct / <span class="built_in">len</span>(test_dataset))<span class="comment"># å°†å‡†ç¡®ç‡åŠ å…¥å‡†ç¡®ç‡å†å²è®°å½•åˆ—è¡¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ‰“å°ä¸­é—´å€¼</span></span><br><span class="line">    <span class="keyword">if</span> epoch % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        tqdm.write(<span class="string">&quot;Epoch: &#123;0&#125; Loss: &#123;1&#125; Acc: &#123;2&#125;&quot;</span>.<span class="built_in">format</span>(epoch, loss_history[-<span class="number">1</span>], acc_history[-<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨Matplotlibç»˜åˆ¶æŸå¤±å’Œå‡†ç¡®ç‡çš„æ›²çº¿å›¾</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.plot(loss_history, label=<span class="string">&#x27;loss&#x27;</span>)</span><br><span class="line">plt.plot(acc_history, label=<span class="string">&#x27;accuracy&#x27;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºå‡†ç¡®ç‡</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Accuracy:&quot;</span>, acc_history[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p><img src="https://qiniu.oldzhangtech.com/mdpic/4413e664-0d64-4025-8085-61dfb55dd43d_069afa8c-7ef4-416f-ac1b-9f499a31c7a5.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># éƒ¨åˆ†çš„è¾“å‡º</span></span><br><span class="line">Accuracy: <span class="number">0.9832</span></span><br></pre></td></tr></table></figure>
<h3 id="å¯¹æ¯”æ•ˆæœ"><a href="#å¯¹æ¯”æ•ˆæœ" class="headerlink" title="å¯¹æ¯”æ•ˆæœ"></a>å¯¹æ¯”æ•ˆæœ</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨Matplotlibç»˜åˆ¶æŸå¤±å’Œå‡†ç¡®ç‡çš„æ›²çº¿å›¾</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.plot(nn_loss_history, label=<span class="string">&#x27;nn loss&#x27;</span>)</span><br><span class="line">plt.plot(nn_acc_history, label=<span class="string">&#x27;nn accuracy&#x27;</span>)</span><br><span class="line">plt.plot(cnn_loss_history, label=<span class="string">&#x27;cnn loss&#x27;</span>)</span><br><span class="line">plt.plot(cnn_acc_history, label=<span class="string">&#x27;cnn accuracy&#x27;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºå‡†ç¡®ç‡</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ACCURACY:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;nn:&quot;</span>, nn_acc_history[-<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cnn:&quot;</span>, cnn_acc_history[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—å‚æ•°é‡</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_parameters</span>(<span class="params">model</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(p.numel() <span class="keyword">for</span> p <span class="keyword">in</span> model.parameters() <span class="keyword">if</span> p.requires_grad)</span><br><span class="line"></span><br><span class="line">nn_total_params = count_parameters(nn_model)</span><br><span class="line">cnn_total_params = count_parameters(cnn_model)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;count of PARAMETERS:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;nn:&quot;</span>, nn_total_params)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cnn:&quot;</span>, cnn_total_params)</span><br></pre></td></tr></table></figure>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/3e483fa6-5eec-4eb5-8ce9-6cfc2967bd9b_3874b442-7387-4608-bf5a-0ff2e2b34337.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ACCURACY:</span><br><span class="line">nn: <span class="number">0.9422</span></span><br><span class="line">cnn: <span class="number">0.9832</span></span><br><span class="line"></span><br><span class="line">count of PARAMETERS:</span><br><span class="line">nn: <span class="number">669706</span></span><br><span class="line">cnn: <span class="number">44426</span></span><br></pre></td></tr></table></figure>

<p>ğŸ”¥ ä»å›¾ä¸­å¯ä»¥çœ‹åˆ° <code>CNN</code> æ¯” <code>NN</code> çš„ <strong>å‡†ç¡®åº¦æ›´åŠ é«˜</strong>ï¼Œ åŒæ—¶ä»–çš„ä½¿ç”¨çš„ <strong>å‚æ•°é‡ä¼šæ›´åŠ çš„å°‘</strong>ã€‚</p>
<p>ğŸ’¡ å½“ç„¶æ¨¡å‹åº”ç”¨ä¸åŒçš„è¶…å‚æ•°ä¼šæœ‰ä¸åŒçš„æ•ˆæœï¼Œå¯ä»¥å¯¹ <code>NN</code> å’Œ <code>CNN</code> è¿›è¡Œä¿®æ”¹ï¼Œçœ‹ä¸€ä¸‹æ•ˆæœå¦‚ä½•ã€‚åŒæ—¶ <a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/cnn_compareNN.ipynb">é“¾æ¥</a> ä¸­å·²ç»æœ‰ <code>girdSearch</code> çš„æ–¹æ³•ï¼Œç”¨äºå¯»æ‰¾æœ€ä½³çš„ <code>NN</code> å‚æ•°ã€‚</p>
<h2 id="LeNet-ç½‘ç»œ-è¯†åˆ«æ‰‹å†™æ•°å­—"><a href="#LeNet-ç½‘ç»œ-è¯†åˆ«æ‰‹å†™æ•°å­—" class="headerlink" title="LeNet ç½‘ç»œ è¯†åˆ«æ‰‹å†™æ•°å­—"></a>LeNet ç½‘ç»œ è¯†åˆ«æ‰‹å†™æ•°å­—</h2><p>å‚è€ƒäº†åˆ«äººçš„å„ç§å·ç§¯ç¥ç»ç½‘ç»œçš„æ—¶é—´çº¿è´´å›¾ã€‚<br><img src="https://qiniu.oldzhangtech.com/mdpic/20431588-e607-4106-817c-68d54848a902_83fc8c68-cce1-4663-85a0-e94f939f9052.png"><br><code>LeNet</code> ä¸ºå·ç§¯ç¥ç»ç½‘ç½‘ç»œå¥ å®šäº†åŸºçŸ³ã€‚æ‰€æœ‰çš„åç»­çš„ç½‘ç»œéƒ½æ˜¯åŸºäºè¿™ä¸ªç½‘ç»œè¿›è¡Œæ‰©å±•çš„ã€‚</p>
<h3 id="æ•´ä½“æ¡†æ¶"><a href="#æ•´ä½“æ¡†æ¶" class="headerlink" title="æ•´ä½“æ¡†æ¶"></a>æ•´ä½“æ¡†æ¶</h3><p><img src="https://qiniu.oldzhangtech.com/mdpic/b990ca3c-7939-4610-b9d8-cafc9586a8bd_5119f828-a66b-4e1d-a03b-7703add2107a.png"><br><code>LeNet</code> æ˜¯ç”± å¤šä¸ªå·ç§¯å±‚ï¼Œæ± åŒ–å±‚ï¼Œå…¨è¿æ¥å±‚ ç»„åˆæ„å»ºè€Œæ¥ã€‚<br>ç»“æ„å¹¶ä¸å¤æ‚ï¼Œä¸‹é¢å°±å¯ä»¥æ‰‹åŠ¨å»å®ç°è¿™ä¸ªç½‘ç»œã€‚å¦‚æœå¯¹ <code>å·ç§¯</code>ï¼Œ<code>æ± åŒ–</code> å¹¶ä¸ç†Ÿæ‚‰çš„ï¼Œå¯ä»¥å‰å¾€ <a href="https://blog.csdn.net/weixin_49113487/article/details/140717493">æ–‡ç« </a> è¿›è¡Œäº†è§£ã€‚</p>
<h3 id="æ‰‹å†™-LeNet-ç½‘ç»œ"><a href="#æ‰‹å†™-LeNet-ç½‘ç»œ" class="headerlink" title="æ‰‹å†™ LeNet ç½‘ç»œ"></a>æ‰‹å†™ LeNet ç½‘ç»œ</h3><p>å…¶å®æ‰‹å†™ <code>LeNet</code>  å°±æ˜¯ ä¸Šè¿°ä¾‹å­ä¸­çš„ <code>CNN</code> çš„ <code>SimpleCnnNet</code>ã€‚ä¸‹é¢åˆ—å‡ºéƒ¨åˆ†çš„ä»£ç ç‰‡æ®µã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleCnnNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_classes=<span class="number">10</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SimpleCnnNet, <span class="variable language_">self</span>).__init__()</span><br><span class="line"><span class="comment">#         æ­¥é•¿é»˜è®¤ä¸º1ï¼Œå¡«å……é»˜è®¤ä¸º0 ä¸€å®šè¦è®°å¾—</span></span><br><span class="line">        <span class="variable language_">self</span>.conv1 = nn.Conv2d(in_channels=<span class="number">1</span>, out_channels=<span class="number">6</span>, kernel_size=<span class="number">5</span>)</span><br><span class="line">        <span class="comment"># å·ç§¯å±‚2ï¼šè¾“å…¥6ä¸ªé€šé“ï¼Œè¾“å‡º16ä¸ªé€šé“ï¼Œå·ç§¯æ ¸å¤§å°ä¸º5x5 </span></span><br><span class="line">        <span class="variable language_">self</span>.conv2 = nn.Conv2d(in_channels=<span class="number">6</span>, out_channels=<span class="number">16</span>, kernel_size=<span class="number">5</span>)</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚1ï¼šè¾“å…¥16x4x4=256ä¸ªèŠ‚ç‚¹ï¼Œè¾“å‡º120ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="variable language_">self</span>.fc1 = nn.Linear(in_features=<span class="number">16</span> * <span class="number">4</span> * <span class="number">4</span>, out_features=<span class="number">120</span>)</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚2ï¼šè¾“å…¥120ä¸ªèŠ‚ç‚¹ï¼Œè¾“å‡º84ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="variable language_">self</span>.fc2 = nn.Linear(in_features=<span class="number">120</span>, out_features=<span class="number">84</span>)</span><br><span class="line">        <span class="comment"># è¾“å‡ºå±‚ï¼šè¾“å…¥84ä¸ªèŠ‚ç‚¹ï¼Œè¾“å‡º10ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="variable language_">self</span>.fc3 = nn.Linear(in_features=<span class="number">84</span>, out_features=num_classes)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ReLUæ¿€æ´»å‡½æ•°ï¼Œå¹¶è¿›è¡Œæœ€å¤§æ± åŒ–</span></span><br><span class="line">        x = torch.relu(<span class="variable language_">self</span>.conv1(x)) </span><br><span class="line">        <span class="comment"># input: 1,28,28, output: 6,24,24</span></span><br><span class="line">        <span class="comment"># output è®¡ç®—é€»è¾‘ï¼š(28-5+2*0)/1 + 1 = 24</span></span><br><span class="line">        x = nn.functional.max_pool2d(x, kernel_size=<span class="number">2</span>)  <span class="comment"># output: 6,12,12</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ReLUæ¿€æ´»å‡½æ•°ï¼Œå¹¶è¿›è¡Œæœ€å¤§æ± åŒ–</span></span><br><span class="line">        x = torch.relu(<span class="variable language_">self</span>.conv2(x))  </span><br><span class="line">        <span class="comment"># input: 6,12,12, output: 16,8,8</span></span><br><span class="line">        <span class="comment"># output è®¡ç®—é€»è¾‘ï¼š(12-5+2*0)/1 + 1 = 8</span></span><br><span class="line">        x = nn.functional.max_pool2d(x, kernel_size=<span class="number">2</span>)  </span><br><span class="line">        <span class="comment"># output: 16,4,4</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å°†å¤šç»´å¼ é‡å±•å¹³ä¸ºä¸€ç»´å¼ é‡</span></span><br><span class="line">        x = x.view(-<span class="number">1</span>, <span class="number">16</span> * <span class="number">4</span> * <span class="number">4</span>)</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚</span></span><br><span class="line">        x = torch.relu(<span class="variable language_">self</span>.fc1(x))</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚</span></span><br><span class="line">        x = torch.relu(<span class="variable language_">self</span>.fc2(x))</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚</span></span><br><span class="line">        x = <span class="variable language_">self</span>.fc3(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<p>ç”±ä¸Šé¢å®šä¹‰çš„æ¨¡å‹çš„ç»“æ„å¾—çŸ¥ï¼š<br><code>Feature extraction</code>ï¼š ç”± 2 *ã€å·ç§¯ *  æ¿€æ´»   * æ± åŒ–ã€‘ç»„æˆï¼Œæ¯å±‚çš„å·ç§¯å’Œæ± åŒ–çš„å‚æ•°æœ‰ä¸åŒã€‚ç”¨äºæŠ½å–ç‰¹å¾ã€‚<br><code>Classification</code>ï¼š ç”± 2 *ã€å…¨è¿æ¥å±‚ * æ¿€æ´»ã€‘ ç»„æˆã€‚å¯¹ç‰¹å¾è¿›è¡Œé€»è¾‘å…³è”ã€‚</p>
<h2 id="è¯†åˆ«ä¸‰è§’å½¢-åœ†å½¢-æ­£æ–¹å½¢"><a href="#è¯†åˆ«ä¸‰è§’å½¢-åœ†å½¢-æ­£æ–¹å½¢" class="headerlink" title="è¯†åˆ«ä¸‰è§’å½¢&#x2F;åœ†å½¢&#x2F;æ­£æ–¹å½¢"></a>è¯†åˆ«ä¸‰è§’å½¢&#x2F;åœ†å½¢&#x2F;æ­£æ–¹å½¢</h2><p>ç›®çš„ï¼šç”Ÿæˆéšæœºçš„ ä¸‰è§’å½¢&#x2F;åœ†å½¢&#x2F;æ­£æ–¹å½¢ çš„é»‘ç™½å›¾æ•°æ®é›†ï¼Œå¹¶ç”¨ CNN çš„æ¨¡å‹è¯†åˆ«ä»–ä»¬ã€‚å¯è¿è¡Œ ipynb çš„æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/cnn_classify_triangleCycleRectangle.ipynb">é“¾æ¥</a>ã€‚<br><em>Prepare data</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !pip install opencv-python</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_shape</span>(<span class="params">shape, img_size=<span class="number">1000</span></span>):</span><br><span class="line">    img = np.zeros((img_size, img_size), dtype=np.uint8)</span><br><span class="line">    <span class="keyword">if</span> shape == <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        radius = np.random.randint(img_size // <span class="number">8</span>, img_size // <span class="number">4</span>)</span><br><span class="line">        center = (np.random.randint(radius, img_size - radius), np.random.randint(radius, img_size - radius))</span><br><span class="line">        cv2.circle(img, center, radius, <span class="number">255</span>, -<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> shape == <span class="string">&#x27;triangle&#x27;</span>:</span><br><span class="line">        pt1 = (np.random.randint(<span class="number">0</span>, img_size), np.random.randint(<span class="number">0</span>, img_size))</span><br><span class="line">        pt2 = (np.random.randint(<span class="number">0</span>, img_size), np.random.randint(<span class="number">0</span>, img_size))</span><br><span class="line">        pt3 = (np.random.randint(<span class="number">0</span>, img_size), np.random.randint(<span class="number">0</span>, img_size))</span><br><span class="line">        points = np.array([pt1, pt2, pt3])</span><br><span class="line">        cv2.drawContours(img, [points], <span class="number">0</span>, <span class="number">255</span>, -<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> shape == <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">        pt1 = (np.random.randint(<span class="number">0</span>, img_size // <span class="number">2</span>), np.random.randint(<span class="number">0</span>, img_size // <span class="number">2</span>))</span><br><span class="line">        pt2 = (np.random.randint(img_size // <span class="number">2</span>, img_size), np.random.randint(img_size // <span class="number">2</span>, img_size))</span><br><span class="line">        cv2.rectangle(img, pt1, pt2, <span class="number">255</span>, -<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_dataset</span>(<span class="params">num_samples=<span class="number">1000</span>, img_size=<span class="number">1000</span></span>):</span><br><span class="line">    shapes = [<span class="string">&#x27;circle&#x27;</span>, <span class="string">&#x27;triangle&#x27;</span>, <span class="string">&#x27;rectangle&#x27;</span>]</span><br><span class="line">    data = []</span><br><span class="line">    labels = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_samples):</span><br><span class="line">        shape = np.random.choice(shapes)</span><br><span class="line">        img = create_shape(shape, img_size)</span><br><span class="line">        data.append(img)</span><br><span class="line">        labels.append(shapes.index(shape))</span><br><span class="line">    <span class="keyword">return</span> np.array(data), np.array(labels)</span><br></pre></td></tr></table></figure>

<p>å¯è§†åŒ–å›¾åƒã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Visualize some samples</span></span><br><span class="line"><span class="comment"># img_size = 200 æ˜¯æ¯”è¾ƒå¥½çš„ä½“ç°å‡º å½¢çŠ¶</span></span><br><span class="line">fig, axes = plt.subplots(<span class="number">1</span>, <span class="number">3</span>, figsize=(<span class="number">10</span>, <span class="number">5</span>))</span><br><span class="line"><span class="keyword">for</span> i, shape <span class="keyword">in</span> <span class="built_in">enumerate</span>([<span class="string">&#x27;circle&#x27;</span>, <span class="string">&#x27;triangle&#x27;</span>, <span class="string">&#x27;rectangle&#x27;</span>]):</span><br><span class="line">    axes[i].imshow(create_shape(shape, img_size=<span class="number">200</span>), cmap=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">    axes[i].set_title(shape)</span><br><span class="line">    axes[i].axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/4a51309b-3fe5-4280-9bbd-da97b8c6925d_bf9181d6-8b22-499c-a013-52ec993b5c47.png" alt="image.png"></p>
<p>éšæœºæ£€æŸ¥æ•°æ®é›†ï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦åˆç†ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">num = <span class="number">5</span></span><br><span class="line">ran_indexes = np.random.randint(<span class="number">0</span>, <span class="built_in">len</span>(data), num)</span><br><span class="line">fig, axes = plt.subplots(<span class="number">1</span>, num, figsize=(<span class="number">10</span>, <span class="number">5</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">    axes[ i].imshow(data[ran_indexes[i]], cmap=<span class="string">&#x27;gray&#x27;</span>)  <span class="comment">## &#x27;Axes&#x27; object is not subscriptable</span></span><br><span class="line">    axes[ i].set_title(<span class="string">f&#x27;index : <span class="subst">&#123;ran_indexes[i]&#125;</span> <span class="subst">&#123;labels[ran_indexes[i]]&#125;</span>&#x27;</span>)</span><br><span class="line">    axes[ i].axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">plt.show()</span><br><span class="line"><span class="comment"># 0: cycle, 1: triangle, 2: rectangle</span></span><br></pre></td></tr></table></figure>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/0e26b843-b82c-4cb3-8617-54f7eb265e20_f96bca9b-901b-4724-bd06-6b9fab029a9a.png" alt="image.png"></p>
<p><em>define model</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset, DataLoader</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShapeDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data, labels, transform=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.data = data</span><br><span class="line">        <span class="variable language_">self</span>.labels = labels</span><br><span class="line">        <span class="variable language_">self</span>.transform = transform</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, idx</span>):</span><br><span class="line">        image = <span class="variable language_">self</span>.data[idx]</span><br><span class="line">        label = <span class="variable language_">self</span>.labels[idx]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.transform:</span><br><span class="line">            image = <span class="variable language_">self</span>.transform(image)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> image, label</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleCNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(SimpleCNN, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># output:32*200*200</span></span><br><span class="line">        <span class="variable language_">self</span>.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">32</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># output:32*50*50</span></span><br><span class="line">        <span class="variable language_">self</span>.pool = nn.MaxPool2d(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="comment"># output:64*50*50</span></span><br><span class="line">        <span class="variable language_">self</span>.conv2 = nn.Conv2d(<span class="number">32</span>, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># output:128</span></span><br><span class="line">        <span class="variable language_">self</span>.fc1 = nn.Linear(<span class="number">64</span> * <span class="number">50</span> * <span class="number">50</span>, <span class="number">128</span>)  <span class="comment"># Adjust input size for the new image size</span></span><br><span class="line">        <span class="comment"># output: 3</span></span><br><span class="line">        <span class="variable language_">self</span>.fc2 = nn.Linear(<span class="number">128</span>, <span class="number">3</span>)  <span class="comment"># 3 classes: circle, triangle, rectangle</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = <span class="variable language_">self</span>.pool(F.relu(<span class="variable language_">self</span>.conv1(x)))</span><br><span class="line">        x = <span class="variable language_">self</span>.pool(F.relu(<span class="variable language_">self</span>.conv2(x)))</span><br><span class="line">        x = x.view(-<span class="number">1</span>, <span class="number">64</span> * <span class="number">50</span> * <span class="number">50</span>)  <span class="comment"># Flatten the tensor</span></span><br><span class="line">        x = F.relu(<span class="variable language_">self</span>.fc1(x))</span><br><span class="line">        x = <span class="variable language_">self</span>.fc2(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>

<p><em>train model</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Data transformation</span></span><br><span class="line">transform = transforms.Compose([</span><br><span class="line">    <span class="comment"># transforms.Grayscale(num_output_channels=1),  # Ensure single channel for grayscale images</span></span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    transforms.Normalize((<span class="number">0.5</span>,), (<span class="number">0.5</span>,))</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the dataset and data loaders</span></span><br><span class="line">train_dataset = ShapeDataset(data, labels, transform=transform)</span><br><span class="line">train_loader = DataLoader(train_dataset, batch_size=<span class="number">32</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Instantiate the model</span></span><br><span class="line">model = SimpleCNN()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define loss function and optimizer</span></span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = optim.Adam(model.parameters(), lr=<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># validate dataset</span></span><br><span class="line">val_data, val_labels = generate_dataset(num_samples=<span class="number">200</span>, img_size=<span class="number">200</span>)</span><br><span class="line">val_dataset = ShapeDataset(val_data, val_labels, transform=transform)</span><br><span class="line">val_loader = DataLoader(val_dataset, batch_size=<span class="number">32</span>, shuffle=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Training method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">model, train_loader, val_loader, criterion, optimizer, num_epochs</span>):</span><br><span class="line">    model.train()</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        running_loss = <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">for</span> _data, _labels <span class="keyword">in</span> train_loader:</span><br><span class="line">            <span class="comment"># Zero the parameter gradients</span></span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Forward pass</span></span><br><span class="line">            outputs = model(_data)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># print(_data.shape, _labels.shape, outputs.shape)</span></span><br><span class="line"></span><br><span class="line">            loss = criterion(outputs, _labels)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Backward pass and optimize</span></span><br><span class="line">            loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Print statistics</span></span><br><span class="line">            running_loss += loss.item()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Epoch [<span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_epochs&#125;</span>], Loss: <span class="subst">&#123;running_loss / <span class="built_in">len</span>(train_loader):<span class="number">.4</span>f&#125;</span>&#x27;</span>)</span><br><span class="line">        validate(model, val_loader, criterion)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Finished Training&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Validation method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate</span>(<span class="params">model, val_loader, criterion</span>):</span><br><span class="line">    model.<span class="built_in">eval</span>()  <span class="comment"># Set the model to evaluation mode</span></span><br><span class="line">    val_loss = <span class="number">0.0</span></span><br><span class="line">    correct = <span class="number">0</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> _data, _labels <span class="keyword">in</span> val_loader:</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="comment"># Forward pass</span></span><br><span class="line">            outputs = model(_data)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># print(_data.shape, _labels.shape, outputs.shape)</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Calculate accuracy</span></span><br><span class="line">            _, predicted = torch.<span class="built_in">max</span>(outputs, <span class="number">1</span>)</span><br><span class="line">            total += _labels.size(<span class="number">0</span>)</span><br><span class="line">            correct += (predicted == _labels).<span class="built_in">sum</span>().item()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Optional: Calculate loss if needed</span></span><br><span class="line">            <span class="comment"># loss = criterion(outputs, _labels)</span></span><br><span class="line">            <span class="comment"># val_loss += loss.item()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Optional: Calculate average loss if needed</span></span><br><span class="line">    <span class="comment"># avg_loss = val_loss / len(val_loader)</span></span><br><span class="line">    accuracy = <span class="number">100</span> * correct / total</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Accuracy: <span class="subst">&#123;accuracy:<span class="number">.2</span>f&#125;</span>%&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Train the model with validation</span></span><br><span class="line">num_epochs = <span class="number">20</span></span><br><span class="line">train(model, train_loader, val_loader, criterion, optimizer, num_epochs)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Epoch [17/20], Loss: 0.0005</span></span><br><span class="line"><span class="string">Accuracy: 92.00%</span></span><br><span class="line"><span class="string">Epoch [18/20], Loss: 0.0005</span></span><br><span class="line"><span class="string">Accuracy: 92.00%</span></span><br><span class="line"><span class="string">Epoch [19/20], Loss: 0.0004</span></span><br><span class="line"><span class="string">Accuracy: 92.00%</span></span><br><span class="line"><span class="string">Epoch [20/20], Loss: 0.0003</span></span><br><span class="line"><span class="string">Accuracy: 92.00%</span></span><br><span class="line"><span class="string">Finished Training</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><em>evalue</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Generate test data</span></span><br><span class="line">test_data, test_labels = generate_dataset(num_samples=<span class="number">100</span>, img_size=<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the test dataset and data loader</span></span><br><span class="line">test_dataset = ShapeDataset(test_data, test_labels, transform=transform)</span><br><span class="line">test_loader = DataLoader(test_dataset, batch_size=<span class="number">1</span>, shuffle=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Evaluate the model</span></span><br><span class="line">model.<span class="built_in">eval</span>()  <span class="comment"># Set the model to evaluation mode</span></span><br><span class="line">correct = <span class="number">0</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="keyword">for</span> inputs, labels <span class="keyword">in</span> test_loader:</span><br><span class="line">        <span class="comment"># Ensure inputs have the correct shape</span></span><br><span class="line">        inputs, labels = inputs.<span class="built_in">float</span>(), labels</span><br><span class="line">        outputs = model(inputs)</span><br><span class="line">        _, predicted = torch.<span class="built_in">max</span>(outputs, <span class="number">1</span>)</span><br><span class="line">        total += labels.size(<span class="number">0</span>)</span><br><span class="line">        correct += (predicted == labels).<span class="built_in">sum</span>().item()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;Accuracy of the model on the test images: <span class="subst">&#123; correct / total:<span class="number">.2</span>f&#125;</span>%&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Accuracy of the model on the test images: 0.90%</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>_NOTE_ï¼š å‡†ç¡®ç‡è¿˜æ˜¯å¯ä»¥çš„ã€‚</p>
<p><em>æ¨ç†å¹¶ä¸”è§†è§‰éªŒè¯</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Visualize some test samples and their predictions</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize_predictions</span>(<span class="params">inputs, labels, predictions</span>):</span><br><span class="line">    fig, axes = plt.subplots(<span class="number">1</span>, <span class="number">5</span>, figsize=(<span class="number">15</span>, <span class="number">5</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        axes[i].imshow(inputs[i].squeeze(), cmap=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">        axes[i].set_title(<span class="string">f&#x27;True: <span class="subst">&#123;labels[i]&#125;</span>, Pred: <span class="subst">&#123;predictions[i]&#125;</span>&#x27;</span>)</span><br><span class="line">        axes[i].axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate test data</span></span><br><span class="line">visual_data, visual_labels = generate_dataset(num_samples=<span class="number">5</span>, img_size=<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the test dataset and data loader</span></span><br><span class="line">visual_dataset = ShapeDataset(visual_data, visual_labels, transform=transform)</span><br><span class="line">visual_loader = DataLoader(visual_dataset, batch_size=<span class="number">5</span>, shuffle=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># torch.from_numpy(visual_data).float().unsqueeze(1).shape = 5,1,200,200</span></span><br><span class="line">outputs = model(torch.from_numpy(visual_data).<span class="built_in">float</span>().unsqueeze(<span class="number">1</span>))</span><br><span class="line">_, predictions = torch.<span class="built_in">max</span>(outputs, <span class="number">1</span>)</span><br><span class="line">visualize_predictions(visual_data, visual_labels, predictions.numpy())</span><br></pre></td></tr></table></figure>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/03db3b3d-0d90-4dac-9888-fcf3f9c809c2_39713376-9e7f-4693-93da-b60856f1a06f.png" alt="image.png"></p>
<h2 id="NOTE"><a href="#NOTE" class="headerlink" title="NOTE"></a>NOTE</h2><p><code>CNN</code> æ˜¯ä¸€ç§æœ‰æ•ˆçš„ <code>è§£å†³ç©ºé—´</code> ä¿¡æ¯çš„æ·±åº¦å­¦ä¹ ç½‘ç»œï¼Œç‰¹åˆ«é€‚ç”¨äºå›¾åƒé—®é¢˜çš„è§£å†³ä¸­ã€‚</p>
]]></content>
      <categories>
        <category>å­¦è‚¥AI</category>
      </categories>
      <tags>
        <tag>å­¦è‚¥AI</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>CNN</tag>
        <tag>LeNet</tag>
      </tags>
  </entry>
  <entry>
    <title>Serverlesså®‰è£…ç¬¬ä¸‰æ–¹packageå¹¶æ„å»ºlayer</title>
    <url>/2024/12/09/%5B%E8%82%A5%E7%94%A8%E4%BA%91%E8%AE%A1%E7%AE%97%5D%20Serverless%E5%AE%89%E8%A3%85%E7%AC%AC%E4%B8%89%E6%96%B9package%E5%B9%B6%E6%9E%84%E5%BB%BAlayer/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰é¢ä»‹ç»çš„éƒ½æ²¡æœ‰è¿›è¡Œé¢å¤–çš„ package å®‰è£…çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æœ¬ç« å°±é‡ç‚¹æ˜¯ å¦‚ä½•åœ¨ serverless ä¸­å®‰è£…ç¬¬ä¸‰æ–¹çš„ packag å’Œ å¦‚ä½•å»æ„å»º layer ä½¿å¾— package å¯ä»¥å¤ç”¨ã€‚</p>
<blockquote>
<p>ä¸‹é¢æ˜¯åç»­æ‰€æœ‰ä¾‹å­éœ€æ±‚ï¼š</p>
<ol>
<li>å®‰è£… emoji packageï¼Œä¸”è¿è¡Œ</li>
</ol>
</blockquote>
<h2 id="å®‰è£…æ–¹å¼ï¼špackage-å®‰è£…åœ¨æœ¬åœ°"><a href="#å®‰è£…æ–¹å¼ï¼špackage-å®‰è£…åœ¨æœ¬åœ°" class="headerlink" title="å®‰è£…æ–¹å¼ï¼špackage å®‰è£…åœ¨æœ¬åœ°"></a>å®‰è£…æ–¹å¼ï¼špackage å®‰è£…åœ¨æœ¬åœ°</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">s init start-fc3-python -d demo1</span><br><span class="line">cd demo1</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…ä¾èµ–</span></span><br><span class="line">touch code/requirements.txt</span><br><span class="line">echo &quot;emoji==2.0.0&quot; &gt; code/requirements.txt</span><br><span class="line">pip3 install -r code/requirements.txt -t ./code</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>emoji package å°±ä¼šå®‰è£…åœ¨ local çš„ code æ–‡ä»¶å¤¹ä¸­</p>
<p>ä¿®æ”¹ <code>code/index.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># @code/index.py</span></span><br><span class="line"><span class="keyword">from</span> emoji <span class="keyword">import</span> emojize</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    <span class="keyword">return</span> emojize(<span class="string">&quot;:thumbs_up:&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>éƒ¨ç½²ä»£ç </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æœ¬åœ°æµ‹è¯•</span></span><br><span class="line">s local invoke</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éƒ¨ç½²åˆ°è¿œç«¯</span></span><br><span class="line">s deploy</span><br></pre></td></tr></table></figure>



<p>å½“ç„¶éƒ¨ç½²ä¹Ÿæ˜¯å¯ä»¥ä¸Šä¼ ä»£ç çš„æ–¹å¼ï¼Œå¦‚ä¸‹å›¾ï¼Œå…¶æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/7d8a2d84-885d-41b9-9176-1e453fbbf978_0a9076aa-14b3-429c-b353-b8a17a50d60c.png"></p>
<p><em><strong>ç»“æœï¼š</strong></em></p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/bef8d5d1-00c5-41fe-9602-c53a43c0087b_83dd9e42-6950-4625-bc3c-20b18fef455d.png"></p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/d8ef8640-9b24-4ea9-9f98-018a77c1a333_662dc12b-8977-4705-97a5-ec7bcc63533f.png"></p>
<p>ç»“æœæ»¡è¶³é¢„æœŸï¼Œä½†æ˜¯ä»–ä¼šæŠŠ emoji package å’Œ index.py ä¸€èµ·ä¸Šä¼ äº†ã€‚æ‰€ä»¥ä»ä»£ç å¤§å°ä¸­å¾—çŸ¥ï¼Œæ•´ä½“ä¼šæ¯”è¾ƒå¤§ã€‚</p>
<h2 id="å®‰è£…æ–¹å¼ï¼šæ„å»º-layer"><a href="#å®‰è£…æ–¹å¼ï¼šæ„å»º-layer" class="headerlink" title="å®‰è£…æ–¹å¼ï¼šæ„å»º layer"></a>å®‰è£…æ–¹å¼ï¼šæ„å»º layer</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">s init start-fc3-python -d demo2</span><br><span class="line">cd demo2</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…ä¾èµ–</span></span><br><span class="line">touch code/requirements.txt</span><br><span class="line">echo &quot;emoji==2.0.0&quot; &gt; code/requirements.txt</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ code&#x2F;index.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># @code/index.py</span></span><br><span class="line"><span class="keyword">from</span> emoji <span class="keyword">import</span> emojize</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    <span class="keyword">return</span> emojize(<span class="string">&quot;:thumbs_up:&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>å…³é”®ä»£ç æ¥äº†ï¼Œ<strong>æ„å»º layerï¼Œå¹¶ä¸”ä¸Šä¼  layerã€‚</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">s build --publish-layer</span><br><span class="line"></span><br><span class="line">[2024-12-09 18:00:12][INFO][hello_world] You need to add a new configuration env configuration dependency in yaml to take effect. The configuration is as follows:</span><br><span class="line">environmentVariables:</span><br><span class="line">  PYTHONPATH: /opt/python</span><br><span class="line">  </span><br><span class="line">layers:</span><br><span class="line">  - acs:fc:cn-shenzhen:1719759326012690:layers/demo2-layer/versions/1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ„å»ºæˆåŠŸåï¼Œæç¤ºè¯´åœ¨ s.yaml ä¸­æ·»åŠ ä¸Š environmentVariables å’Œ layers èŠ‚ç‚¹ã€‚</p>
<p>ğŸ’¡ æ„å»º layer çš„æ„æ€å°±æ˜¯æŠŠ requirements package éƒ½æ„å»ºä¸€å±‚ image layer ä¸”ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œåç»­çš„ä»£ç å°±æ˜¯åŸºäºè¿™å±‚ï¼Œä¸ç”¨å¦å¤–çš„å®‰è£…ä»£ç ã€‚å¦‚æœæœ‰å…¶ä»–çš„é¡¹ç›®æƒ³å¤ç”¨è¿™äº› packageï¼Œç›´æ¥æ”¹ s.yaml çš„ layer èŠ‚ç‚¹å°±å¯ä»¥äº†ã€‚</p>
<p>âš ï¸ è®°å¾—è¦æŠŠ requirements.txt çš„æ–‡ä»¶è¦æ”¾åœ¨ å’Œ index.py çš„åŒçº§ç›®å½•ä¸‹ã€‚</p>
<p>æ‰€ä»¥å¾€ s.yaml é‡Œé¢å†™å…¥ä¸Šè¿°çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">props:</span></span><br><span class="line">      <span class="string">...</span></span><br><span class="line">      <span class="attr">environmentVariables:</span></span><br><span class="line">        <span class="attr">PYTHONPATH:</span> <span class="string">/opt/python</span></span><br><span class="line">      <span class="attr">layers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">acs:fc:cn-shenzhen:1719759326012690:layers/demo2-layer/versions/1</span></span><br></pre></td></tr></table></figure>



<p>éƒ¨ç½²ä»£ç </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æœ¬åœ°æµ‹è¯•</span></span><br><span class="line">s local invoke</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éƒ¨ç½²åˆ°è¿œç«¯</span></span><br><span class="line">s deploy</span><br></pre></td></tr></table></figure>

<p><em>****</em></p>
<p><em><strong>ç»“æœï¼š</strong></em></p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/3182e155-8a24-4d6e-80bf-72c8890ebdf5_e3de1325-4c7c-4b4f-8ce5-cc6c9d2bb8a4.png"></p>
<p>å› ä¸ºä¸ä¼šä¸Šä¼  emoji packageï¼Œä»£ç æ˜æ˜¾æ˜¯å°äº†å¾ˆå¤šã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li>serverless å°±æ˜¯ ä¸šåŠ¡ å’Œ trigger éš”ç¦»å¼€æ¥ï¼Œæœ¬æ–‡ç« ä¾‹å­ä¸­éƒ½æ˜¯å®Œæˆ ä¸šåŠ¡ï¼Œæ²¡æœ‰ triggerï¼›åªè¦åç»­è¡¥å……ä¸Š triggerï¼Œè¿™ä¸ªä¸šåŠ¡å°±å¯ä»¥ä¸²é€šäº†ã€‚</li>
<li>éƒ¨ç½²æ–¹å¼ï¼Œä¼˜å…ˆæ˜¯æ„å»º layerï¼Œåä¸Šä¼ ä»£ç ï¼Œå› ä¸º layer å¯ä»¥å¤ç”¨ï¼Œä¸”å‡å°‘é¡¹ç›®çš„ä»£ç ã€‚</li>
<li>å¦‚æœå¼€å‘&#x2F;æœ¬åœ°æµ‹è¯•&#x2F;éƒ¨ç½²ï¼Œå¯ä»¥éµå¾ªä¸‹é¢çš„æ–¹æ³•ï¼š</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆå§‹åŒ–</span></span><br><span class="line">s init start-fc3-python -d demo2</span><br><span class="line">cd demo2</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…ä¾èµ–</span></span><br><span class="line">touch code/requirements.txt</span><br><span class="line">echo &quot;emoji==2.0.0&quot; &gt; code/requirements.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æœ¬åœ°æµ‹è¯•</span></span><br><span class="line">s local invoke</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ„å»º layer</span></span><br><span class="line">s build --publish-layer</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éƒ¨ç½²</span></span><br><span class="line">s deploy</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="èµ„æ–™"><a href="#èµ„æ–™" class="headerlink" title="èµ„æ–™"></a>èµ„æ–™</h2><ol>
<li><a href="https://gitee.com/oldmanzhang/practice_serverlsess/tree/master/p03">æºä»£ç </a></li>
<li><a href="https://help.aliyun.com/zh/functioncompute/fc-3-0/user-guide/request-handlers?spm=a2c4g.11186623.4.2.72757bbcKfadgi&scm=20140722.H_2512964._.ID_2512964-OR_rec-V_1">é˜¿é‡Œäº‘ serverless è¯´æ˜</a></li>
<li><a href="https://manual.serverless-devs.com/user-guide/aliyun/fc3/build/">Serverless Devs Docs</a></li>
<li><a href="https://github.com/devsapp/start-fc?spm=5176.fcnext.0.0.18e978c8K4qMDn">start-fc-template</a></li>
</ol>
]]></content>
      <categories>
        <category>è‚¥ç”¨äº‘è®¡ç®—</category>
      </categories>
      <tags>
        <tag>serverless</tag>
      </tags>
  </entry>
  <entry>
    <title>RNN çš„åŸºç¡€</title>
    <url>/2024/08/06/%5B%E5%AD%A6%E8%82%A5AI%5D%20RNN%20%E7%9A%84%E5%9F%BA%E7%A1%80/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯é—®é¢˜"><a href="#èƒŒæ™¯é—®é¢˜" class="headerlink" title="èƒŒæ™¯é—®é¢˜"></a>èƒŒæ™¯é—®é¢˜</h2><p>æˆ‘ä»¬æœ‰æ—¶å€™éœ€è¦å¤„ç†ä¸€äº› _æ—¶é—´åºåˆ—æ•°æ®_ï¼Œæ¯”å¦‚ è‚¡ç¥¨é¢„æµ‹ï¼Œå¤©æ°”é¢„æµ‹ï¼Œæ ¹æ®å‰é¢å•è¯é¢„æµ‹åç»­ä¸€ä¸ªå•è¯ç­‰åœºæ™¯ã€‚NNï¼ˆNeural Networkï¼‰ åœ¨å¤„ç†è¿™äº›é—®é¢˜ï¼Œæœ‰ä»–çš„å±€é™æ€§ã€‚RNN ï¼ˆRecurrent Neural Networkï¼‰ï¼Œå°±æ˜¯ä¸ºäº†ç”¨äºå¤„ç†è¿™äº›é—®é¢˜ã€‚</p>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>ä¸€å¥è¯ï¼šèƒ½å¤Ÿè®°ä½å‰ X æ­¥ï¼Œç¦»å½“å‰æ—¶é—´è¶Šè¿‘çš„ï¼Œè¶Šè®°å¾—æ·±åˆ»ï¼Œå³è¶Šèƒ½å½±å“å½“å‰æ­¥çš„è¾“å‡ºã€‚</p>
<p>é‡Œé¢æœ‰å‡ å±‚æ„æ€ï¼š</p>
<ol>
<li>å½“å‰æ­¥è¾“å‡ºï¼Œä¸å‰ X æ­¥çš„è®°å¿†æ„æˆ</li>
<li>å‰ X æ­¥çš„è¾“å…¥ï¼Œå°±æ„æˆäº† å‰ X æ­¥çš„è®°å¿†</li>
<li>å‰ X æ­¥çš„è®°å¿†ï¼ŒX è¶Šå°ï¼Œæƒé‡è¶Šå¤§ï¼Œè¶Šèƒ½å½±å“å½“å‰æ­¥çš„è¾“å‡º</li>
</ol>
<p>å’Œäººçš„è®°å¿†å°±å¾ˆåƒï¼Œè¶Šè¿‘çš„äº‹ä»¶ï¼Œå½“ç„¶è®°å¾—è¶Šæ¸…äº†ï¼Œè¶Šå¾€å‰å€’ï¼Œå°±è®°å¾—è¶Šæ¨¡ç³Šã€‚</p>
<p>ç®€å•çš„ç¤ºæ„å›¾ï¼Œé¢œè‰²è¶Šçº¢ï¼Œå°±æ˜¯è®°å¾—è¶Šæ¸…æ¥šçš„ã€‚è¶Šå¾€åï¼Œ<code>â€œwhatâ€</code> è¿™ä¸ªå•è¯å°±å·²ç»ä¸è®°å¾—äº†ã€‚<br><img src="https://qiniu.oldzhangtech.com/mdpic/d972ff24-a2e9-4c69-b9f2-c13898cbba5d_f74254d1-fcc7-4ab7-a678-a74fa78fd7ee.png"></p>
<p>ğŸ’¡ æ‰€ä»¥ææ¸…æ¸…æ¥š <strong>è®°å¿†</strong>ï¼Œ<strong>è¾“å…¥</strong>ï¼Œ<strong>è¾“å‡º</strong>ï¼Œ<strong>æ—¶é—´æ­¥</strong> ä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯ RNN çš„å…³é”®ã€‚ï¼ˆNN å°±æ²¡æœ‰ <strong>è®°å¿†</strong> å’Œ <strong>æ—¶é—´æ­¥</strong> çš„æ¦‚å¿µï¼‰</p>
<p>æ—¶é—´æ­¥ï¼Œå°±æ˜¯è¡¨ç¤ºæ—¶é—´åºåˆ—ã€‚æ¯”å¦‚ è‚¡å¸‚æŒ‡æ ‡çš„æ¯ç§’é’Ÿæ—¶åˆ»ï¼Œå¤©æ°”æµ®åŠ¨çš„æ¯å¤©æ—¶åˆ»ï¼Œä¸€å¥è¯ä¸­çš„æ¯ä¸ªå•è¯çš„å‰åé¡ºåºæ—¶åˆ»ï¼Œä»–ä»¬éƒ½æ˜¯æœ‰å…ˆåå…³ç³»çš„ã€‚<br>è®°å¿†ï¼Œå°±å¥½åƒ **æ¯ä¸ªæ—¶é—´æ­¥ **çš„ä¸€ä¸ªå†…å­˜ï¼Œä»–è®°å½•ç€å½“å‰æ­¥çš„ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ›´åŠ ä¸“ä¸šçš„ <strong>éšçŠ¶æ€ï¼ˆHidden Stateï¼‰</strong>æ¥è¡¨ç¤ºã€‚ä»–éšç€æ—¶é—´æ­¥çš„é€’è¿›ï¼Œé‡Œé¢ä¿å­˜çš„æ¶ˆæ¯æ…¢æ…¢å¼±åŒ–ï¼Œç›´è‡³æ¶ˆå¤±ã€‚</p>
<h3 id="åŸç†å›¾"><a href="#åŸç†å›¾" class="headerlink" title="åŸç†å›¾"></a>åŸç†å›¾</h3><h3 id=""><a href="#" class="headerlink" title=""></a><img src="https://qiniu.oldzhangtech.com/mdpic/c332685c-2b24-4bba-a779-05fd81b85263_01dd4e9d-5ea6-446b-b12b-b23e191501f3.png"></h3><p>ä¸Šè¿°æ˜¯ RNN çš„åŸç†å›¾ã€‚<br>h: æ˜¯éšçŠ¶æ€ï¼Œx: æ˜¯è¾“å…¥ï¼Œo: æ˜¯è¾“å‡ºï¼Œ ä¸Šé¢ 3 ä¸ªå˜é‡éƒ½æ˜¯ä¸æ—¶é—´æ­¥ç›¸å…³çš„ï¼Œæœ‰æ—¶é—´æ ‡æ³¨ã€‚<br>å›¾ä¸­çš„æ„æ€æ˜¯ï¼š t æ—¶åˆ»çš„ hï¼ˆéšçŠ¶æ€ï¼‰ï¼Œç”± t-1 æ—¶åˆ»çš„ hï¼ˆéšçŠ¶æ€ï¼‰å’Œ t æ—¶åˆ»çš„ xï¼ˆè¾“å…¥ï¼‰ç”Ÿæˆï¼›t æ—¶åˆ»çš„ oï¼ˆè¾“å‡ºï¼‰ï¼Œç”± t æ—¶åˆ»çš„ hï¼ˆéšçŠ¶æ€ï¼‰ç”Ÿæˆã€‚</p>
<p>æ€»ç»“æˆä¸‹é¢çš„ä¸¤ä¸ªå…¬å¼:<br>$h_t &#x3D; f(x_t, h_{t-1})$<br>$o_t &#x3D; g(h_t)$   </p>
<p>å› ä¸º  åˆå¯ä»¥å±•å¼€æ¥ $[ h_{t-1} &#x3D; f(x_{t-1}, h_{t-2})]$  ï¼Œä¸” $h_{t-2}$ ä¹ŸåŒæ ·å±•å¼€ï¼Œè¿™æ ·å»¶ç»­ä¸‹å»ï¼Œå°±å¯ä»¥æ— é™å±•å¼€ã€‚<br>å› ä¸ºç¡¬ä»¶é™åˆ¶å’Œè®¡ç®—é™åˆ¶ï¼Œæˆ‘ä»¬ä¼šæœ‰ æ—¶é—´æ­¥ sequence çš„æ¦‚å¿µï¼Œå°±æ˜¯å½“å‰æ­¥çš„é¢„æµ‹ï¼Œä»…ä»…æ˜¯ä¸å‰ n æ­¥çš„éšçŠ¶æ€ç›¸å…³ï¼Œn å°±æ˜¯ sequence çš„æ„æ€ã€‚<br><img src="https://qiniu.oldzhangtech.com/mdpic/7e01c973-ba9d-4ab3-bda4-0132910d5ff5_fedcb4a7-55ad-4e45-9454-c26bda653585.png" alt="image.png"><br>æ¯”å¦‚ä¸Šå›¾ï¼Œ sequence &#x3D; 4ï¼Œ é•¿æ–¹å½¢å°±æ˜¯ éšçŠ¶æ€ï¼Œé•¿åº¦å°±æ˜¯æƒé‡ï¼Œè¶Šå¾€å·¦è¾¹ï¼Œä»£è¡¨æ—¶é—´è¶Šä¹…è¿œï¼Œé•¿åº¦è¶ŠçŸ®ï¼ŒéšçŠ¶æ€çš„æƒé‡è¶Šä½ã€‚åé¢å°±ä¼šé€æ¸æ¶ˆå¤±ï¼Œæ‰€ä»¥ $h_{t-5}$  å¯¹ $h_{t}$  å°±ä¸ä¼šå†èµ·ä½œç”¨äº†ã€‚</p>
<p>æ•´ä½“çš„å…¬å¼éå¸¸çš„ç®€å•ï¼Œå¯ä»¥è®°ä½ï¼Œæˆ–è€…ä¸ç”¨è®°å¿†ï¼Œäº†è§£å¤§è‡´é€šä¿—çš„æ„æ€ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ä¸‹é¢æ‰‹å†™ RNN çš„ç»„ä»¶å°±æŠŠä¸Šé¢çš„å…¬å¼ ç”¨ä»£ç å±•ç°å‡ºæ¥ã€‚</p>
<h2 id="æ‰‹å†™-RNN-ç»„ä»¶"><a href="#æ‰‹å†™-RNN-ç»„ä»¶" class="headerlink" title="æ‰‹å†™ RNN ç»„ä»¶"></a>æ‰‹å†™ RNN ç»„ä»¶</h2><p>æ ¹æ®ä¸Šè¿°çš„è¯´æ˜ï¼Œå½¢æˆ <strong>éšçŠ¶æ€</strong>ï¼Œæ˜¯æ•´ä¸ª <code>RNN</code> çš„å…³é”®ã€‚æ‰‹åŠ¨å®ç° <code>RNN</code> ç»„ä»¶ï¼Œå°±èƒ½äº†è§£ä»–çš„å†…éƒ¨è¿è¡Œæœºåˆ¶æ˜¯ä»€ä¹ˆï¼Œåˆ©äºç†è§£ä»–çš„åŸç†ã€‚</p>
<blockquote>
<p>æ‰‹å†™ç»„ä»¶ æ˜¯ä¸ºäº†å¯¹ <code>RNN</code> ç†è§£æ›´åŠ æ·±å…¥ï¼Œåç»­éƒ½ä½¿ç”¨ <code>nn.RNN</code> å·²ç»å°è£…å¥½çš„æ–¹æ³•ï¼Œä¸å†ä½¿ç”¨æ‰‹å†™ RNNã€‚å¯è¿è¡Œ ipynb æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/rnn_basic.ipynb">é“¾æ¥</a>ã€‚</p>
</blockquote>
<p>ä¸‹é¢æ˜¯æ¨¡æ‹Ÿæœ‰ 10 ä¸ªæ—¶åˆ»ï¼ˆ sequence å˜é‡ ï¼‰çš„è¾“å…¥æ•°æ®ï¼Œä» <em>è¾“å…¥</em> å½¢æˆ _éšçŠ¶æ€_ï¼Œå¹¶ä¸”ä» <em>éšçŠ¶æ€</em> ç”Ÿæˆ <em>è¾“å‡º</em> çš„è¿‡ç¨‹ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">hidden_size = <span class="number">20</span> <span class="comment"># è®°å¿†ä½“çš„ç»´åº¦</span></span><br><span class="line">input_size = <span class="number">1</span> <span class="comment"># è¾“å…¥ç‰¹å¾</span></span><br><span class="line">output_size = <span class="number">1</span> <span class="comment"># è¾“å‡ºç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥çš„æ˜ å°„å…³ç³»ï¼Œæ›´æ–° è®°å¿†ä½“çš„æ•°æ®</span></span><br><span class="line">i2h = nn.Linear(input_size + hidden_size, hidden_size)  <span class="comment"># è¾“å…¥åˆ°éšè—å±‚</span></span><br><span class="line"><span class="comment"># ä» è®°å¿†ä½“çš„æ•°æ® ç”Ÿæˆ è¾“å‡ºæ•°æ®</span></span><br><span class="line">i2o = nn.Linear(hidden_size, output_size)  <span class="comment"># éšè—å±‚åˆ°è¾“å‡ºå±‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªè¾“å…¥ï¼Œæ ¼å¼æ˜¯å°±æ˜¯ (sequence, input_feature)</span></span><br><span class="line">sequence = <span class="number">10</span></span><br><span class="line">X = torch.rand(sequence,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªè®°å¿†ä½“, sequence, feature</span></span><br><span class="line">hidden = torch.zeros(<span class="built_in">len</span>(X), hidden_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># [1] æ··åˆ è¾“å…¥ å’Œ å‰ä¸€ä¸ªè®°å¿†ä½“</span></span><br><span class="line">combined = torch.cat((X, hidden), <span class="number">1</span>)  <span class="comment"># torch.Size([1, 21])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [2] å½¢æˆ æ–°çš„è®°å¿†ä½“</span></span><br><span class="line">hidden = i2h(combined)</span><br><span class="line"><span class="comment"># [3] è¾“å‡º output</span></span><br><span class="line">output = i2o(hidden)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åç»­åŠ ä¸Š æŸå¤±å‡½æ•° å’Œ ä¼˜åŒ–å‡½æ•° å’Œ åå‘ä¼ æ’­ï¼Œå°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ RNN çš„æµç¨‹ã€‚</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ RNN ç»„ä»¶çš„å®ç°é€»è¾‘ï¼Œä»£ç ç®€å•æ¸…æ™°ï¼Œå°±ä¸å†ä¸€å¥å¥è¯´æ˜ã€‚</p>
<p>æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<ol>
<li>[1] + [2] å³æ˜¯  $f(x_t , h_{t-1})$ ï¼Œ  <code>torch.cat + i2h (full connect)</code> ï¼Œè¾“å‡º $h_t$<code>å½“å‰ hidden_state</code> ã€‚</li>
<li>[3] å³æ˜¯ $g(h_t)$ ï¼Œ <code>i2o (hidden)</code>ï¼Œè¾“å‡º $o_t$å½“å‰è¾“å‡ºï¼Œå°±æ˜¯ä» <code>å½“å‰hidden_state</code> ä¸­æ¥</li>
<li>ä¸Šè¿°ä»£ç æ•´åˆåˆ°ä¸€ä¸ª model é‡Œé¢ï¼Œå¾ªç¯èµ·æ¥ï¼Œå°±ä¼šæ˜¯ä¸€ä¸ªæ‰‹å†™ RNNã€‚</li>
<li>[1] ä¸­ï¼Œ<code>torch.cat((X, hidden), 1)</code> æ˜¯ <code>10 * input</code> å’Œ <code>hidden_state</code> æ··åˆå»ºç«‹è”ç³»ï¼›å½“ç„¶å¯ä»¥ $f(x_1, hidden_0)$; $f(x_2, hidden_1)$; $f(x_3, hidden_2)$ â€¦ $f(x_10, hidden_9)$ é€æ­¥å †å  <code>hidden_state</code>ï¼Œè¿™æ ·ä¼šæ›´åŠ çš„ç›´è§‚ã€‚</li>
</ol>
<h2 id="ä¾‹å­-é¢„æµ‹å­—ç¬¦"><a href="#ä¾‹å­-é¢„æµ‹å­—ç¬¦" class="headerlink" title="ä¾‹å­ - é¢„æµ‹å­—ç¬¦"></a>ä¾‹å­ - é¢„æµ‹å­—ç¬¦</h2><p>ç›®çš„ï¼šç”±â€œ2 ä¸ªå­—ç¬¦â€ï¼Œé¢„æµ‹ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼ŒåŒæ—¶è¿ç»­çŒœæµ‹ä¸‹å»ã€‚<br>è®­ç»ƒæ•°æ®ï¼š â€œhello worldâ€ã€‚</p>
<p><strong><em>åˆ†æè¿‡ç¨‹ï¼š</em></strong></p>
<ol>
<li>æ˜¯ <strong>åˆ†ç±»</strong>é—®é¢˜</li>
<li>â€œ2 ä¸ªå­—ç¬¦â€ æ˜¯ä¸€ä¸ªæœ‰è¿ç»­å…ˆåå…³ç³»çš„è¾“å…¥ï¼Œæ‰€ä»¥ä½¿ç”¨ RNN</li>
<li>å®šä¹‰ RNN çš„æ—¶å€™ input_feature å’Œ output_feature éƒ½æ˜¯ 8ï¼ˆå­—ç¬¦ä¸²çš„æ‰€æœ‰å”¯ä¸€å€¼æ€»æ•°æ˜¯ 8ï¼‰</li>
<li>X çš„ sequence å¯ä»¥å®šä¹‰æˆ 2</li>
</ol>
<p>è¯¦ç»†çš„ä»£ç å¯ä»¥ç›´æ¥è®¿é—® ipynb æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/rnn_classifications_charPredit.ipynb">é“¾æ¥</a>ã€‚<br>è®­ç»ƒåçš„ç»“æœï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æµ‹è¯•æ¨¡å‹</span></span><br><span class="line">start_str = <span class="string">&quot;he&quot;</span></span><br><span class="line">predict_times = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###### output predict</span></span><br><span class="line"><span class="comment"># Predicted string: hello w</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¾‹å­-é¢„æµ‹-GS10"><a href="#ä¾‹å­-é¢„æµ‹-GS10" class="headerlink" title="ä¾‹å­ - é¢„æµ‹ GS10"></a>ä¾‹å­ - é¢„æµ‹ GS10</h2><p>ç›®çš„ï¼šç”±å‰ 6 å¹´æ•°æ®ï¼Œæ˜¯å¦å¯ä»¥é¢„æµ‹åˆ° ä¸‹ä¸€å¹´çš„æ•°æ®<br>è®­ç»ƒæ•°æ®ï¼š ç¾å›½å›½å€ºæ”¶ç›Šç‡æ•°æ®<br><strong><em>åˆ†æè¿‡ç¨‹ï¼š</em></strong></p>
<ol>
<li>æ˜¯ <strong>å›å½’</strong>é—®é¢˜</li>
<li>â€œå‰ 6 å¹´æ•°æ®â€ é¢„æµ‹ä¸‹ä¸€å¹´ï¼Œå°±æ˜¯æœ‰ä¸€ä¸ªå…ˆåæ—¶é—´å…³ç³»ï¼Œæ‰€ä»¥ä½¿ç”¨ RNN</li>
<li>å®šä¹‰ RNN çš„æ—¶å€™ input_feature å’Œ output_feature éƒ½æ˜¯ 1ï¼ˆå› ä¸ºéƒ½æ˜¯ æ•°å€¼ä¸Šæ˜¯ 1 ä¸ªå€¼çš„å›å½’ï¼‰</li>
<li>X çš„ sequence å¯ä»¥å®šä¹‰æˆ 6</li>
</ol>
<p>è¯¦ç»†çš„ä»£ç å¯ä»¥ç›´æ¥è®¿é—® ipynb æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/rnn_regresssion_gs10.ipynb">é“¾æ¥</a>ã€‚<br>è®­ç»ƒåçš„ç»“æœï¼š<br><img src="https://qiniu.oldzhangtech.com/mdpic/3cf5a41c-6742-4031-afe8-d7931e87970f_48c9e63a-60a4-4845-8333-f73de20a0504.png" alt="image.png"></p>
<h2 id="ä»£ç æ³¨æ„é—®é¢˜"><a href="#ä»£ç æ³¨æ„é—®é¢˜" class="headerlink" title="ä»£ç æ³¨æ„é—®é¢˜"></a>ä»£ç æ³¨æ„é—®é¢˜</h2><blockquote>
<p>é›†ä¸­åœ¨è°ƒç”¨ nn.RNN çš„é—®é¢˜</p>
</blockquote>
<h3 id="nn-RNN-çš„-input-feature-å’Œ-X-ç»´åº¦å…³ç³»"><a href="#nn-RNN-çš„-input-feature-å’Œ-X-ç»´åº¦å…³ç³»" class="headerlink" title="nn.RNN çš„ input_feature å’Œ X ç»´åº¦å…³ç³»"></a>nn.RNN çš„ input_feature å’Œ X ç»´åº¦å…³ç³»</h3><p>åœ¨æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œè°ƒæ•´ <code>model(X)</code> ä¸­çš„ <code>X</code> ç»´åº¦ï¼Œæ˜¯æœ€è€—è´¹æ—¶é—´çš„ã€‚å¦‚æœè¯­æ„ä¸Šå»ç†è§£äº†ï¼Œé‚£ä¹ˆç”¨èµ·æ¥å°±ä¼šå¾—å¿ƒåº”æ‰‹å¾ˆå¤šã€‚</p>
<p>ğŸ”¥ æ³¨æ„ç‚¹</p>
<ol>
<li>æ¯”å¦‚ï¼šä¸€ä¸ª X.shape &#x3D; (5,3,10)ï¼Œå°±å¯ä»¥ç†è§£æˆ  <strong>5 ä¸ªæ ·æœ¬, 3 ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥æœ‰ 10 ä¸ªç‰¹å¾</strong></li>
<li><code>X dim</code> <strong>è‡³å°‘æ˜¯ 2 ç»´</strong>ï¼Œåˆ†åˆ«æ˜¯ <code>(sequence, feature)</code>; å¦‚æœæ˜¯ 3 ç»´ï¼Œåˆ†åˆ«æ˜¯ <code>(batch, sequence, feature)</code>ï¼›å½“ç„¶ ä¹Ÿå¯ä»¥å¤§äº 2 ç»´ã€‚</li>
</ol>
<p>å¯è¿è¡Œæ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/rnn_basic.ipynb">é“¾æ¥</a></p>
<p><strong>åˆ†ç±»é—®é¢˜</strong>, X.dim &#x3D; 3</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ RNN å±‚</span></span><br><span class="line"><span class="comment"># input_size ç†è§£æˆ ç‰¹å¾ä¼šæ¯”è¾ƒå¥½</span></span><br><span class="line">rnn = nn.RNN(input_size=<span class="number">10</span>, hidden_size=<span class="number">20</span>, num_layers=<span class="number">1</span>, batch_first=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè¾“å…¥å¼ é‡ (batch_size, seq_length, input_size)</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">5</span>, <span class="number">3</span>, <span class="number">10</span>)  <span class="comment"># 5 ä¸ªæ ·æœ¬, 3 ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥æœ‰ 10 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–éšè—çŠ¶æ€ (num_layers, batch_size, hidden_size)</span></span><br><span class="line">h0 = torch.zeros(<span class="number">1</span>, <span class="number">5</span>, <span class="number">20</span>)  <span class="comment"># 1 å±‚, 5 ä¸ªæ ·æœ¬, æ¯å±‚éšè—çŠ¶æ€æœ‰ 20 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå‰å‘ä¼ é€’</span></span><br><span class="line">output, hn = rnn(input_tensor, h0)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°è¾“å…¥å’Œè¾“å‡ºçš„å½¢çŠ¶</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Input shape:&quot;</span>, input_tensor.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Output shape:&quot;</span>, output.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hidden state shape:&quot;</span>, hn.shape)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Input shape: torch.Size([5, 3, 10])</span></span><br><span class="line"><span class="string">Output shape: torch.Size([5, 3, 20])</span></span><br><span class="line"><span class="string">Hidden state shape: torch.Size([1, 5, 20])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åŒæ ·æ˜¯ rnn çš„ model, X.dim &#x3D; 2ï¼Œä¸€æ ·å¯ä»¥è¿è¡Œï¼Œé‚£ä¹ˆä»–å°±ä»£è¡¨äº† (seq_length, input_size)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè¾“å…¥å¼ é‡ (seq_length, input_size)</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">3</span>, <span class="number">10</span>)  <span class="comment"># 3 ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥æœ‰ 10 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–éšè—çŠ¶æ€ (num_layers, batch_size, hidden_size)</span></span><br><span class="line">h0 = torch.zeros(<span class="number">1</span>, <span class="number">20</span>)  <span class="comment"># 1 å±‚, 5 ä¸ªæ ·æœ¬, æ¯å±‚éšè—çŠ¶æ€æœ‰ 20 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå‰å‘ä¼ é€’</span></span><br><span class="line">output, hn = rnn(input_tensor, h0)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Input shape:&quot;</span>, input_tensor.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Output shape:&quot;</span>, output.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hidden state shape:&quot;</span>, hn.shape)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Input shape: torch.Size([3, 10])</span></span><br><span class="line"><span class="string">Output shape: torch.Size([3, 20])</span></span><br><span class="line"><span class="string">Hidden state shape: torch.Size([1, 20])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>å›å½’é—®é¢˜</strong>ï¼ŒX.dim &#x3D; 3</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å›å½’çš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Š 1 ä¸ªç‰¹å¾è¾“å…¥ï¼Œ1 ä¸ªç‰¹å¾è¾“å‡º</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ RNN å±‚</span></span><br><span class="line"><span class="comment"># input_size ç†è§£æˆ ç‰¹å¾ä¼šæ¯”è¾ƒå¥½</span></span><br><span class="line">rnn = nn.RNN(input_size=<span class="number">1</span>, hidden_size=<span class="number">20</span>, num_layers=<span class="number">1</span>, batch_first=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè¾“å…¥å¼ é‡ (batch_size, seq_length, input_size)</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>)  <span class="comment"># 5 ä¸ªæ ·æœ¬, 3 ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥æœ‰ 1 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–éšè—çŠ¶æ€ (num_layers, batch_size, hidden_size)</span></span><br><span class="line">h0 = torch.zeros(<span class="number">1</span>, <span class="number">5</span>, <span class="number">20</span>)  <span class="comment"># 1 å±‚, 5 ä¸ªæ ·æœ¬, æ¯å±‚éšè—çŠ¶æ€æœ‰ 20 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå‰å‘ä¼ é€’</span></span><br><span class="line">output, hn = rnn(input_tensor, h0)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°è¾“å…¥å’Œè¾“å‡ºçš„å½¢çŠ¶</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Input shape:&quot;</span>, input_tensor.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Output shape:&quot;</span>, output.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hidden state shape:&quot;</span>, hn.shape)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Input shape: torch.Size([5, 3, 1])</span></span><br><span class="line"><span class="string">Output shape: torch.Size([5, 3, 20])</span></span><br><span class="line"><span class="string">Hidden state shape: torch.Size([1, 5, 20])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ output éœ€è¦ç»è¿‡ä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œæ‰æœ€åè½¬æ¢æˆçœŸæ­£çš„ outputã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œåˆ©ç”¨ä¸Šé¢çš„å›å½’ä¾‹å­ï¼Œæ¨¡æ‹Ÿ output_size &#x3D;1 è¿›è¡Œè¾“å‡ºã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å› ä¸º RNN å±‚æ˜¯æ²¡æœ‰ output_size,æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªç”¨äº output_sizeï¼Œæ¯”å¦‚å›å½’è¾“å‡º 1 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 20ä¸ªç‰¹å¾é‡Œé¢ï¼Œæå–ä¸€ä¸ªè¾“å‡º</span></span><br><span class="line">out_linear = nn.Linear(in_features=<span class="number">20</span>, out_features=<span class="number">1</span>)</span><br><span class="line">output2 = out_linear(output)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Output shape:&quot;</span>, output2.shape)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ input å¯¹åº”èµ·æ¥äº†ï¼Œå°±æ˜¯ # 5 ä¸ªæ ·æœ¬, 3 ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥æœ‰ 1 ä¸ªç‰¹å¾</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Output shape: torch.Size([5, 3, 1])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="nn-RNN-çš„-target-ä¸-y-çš„æ•°æ®çš„å¤„ç†"><a href="#nn-RNN-çš„-target-ä¸-y-çš„æ•°æ®çš„å¤„ç†" class="headerlink" title="nn.RNN çš„  target ä¸ y çš„æ•°æ®çš„å¤„ç†"></a>nn.RNN çš„  target ä¸ y çš„æ•°æ®çš„å¤„ç†</h3><p>è¿˜æ˜¯ä¸Šè¿°çš„ä¾‹å­ï¼Œå›å½’é—®é¢˜</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å›å½’çš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Š 1 ä¸ªç‰¹å¾è¾“å…¥ï¼Œ1 ä¸ªç‰¹å¾è¾“å‡º</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ RNN å±‚</span></span><br><span class="line"><span class="comment"># input_size ç†è§£æˆ ç‰¹å¾ä¼šæ¯”è¾ƒå¥½</span></span><br><span class="line">rnn = nn.RNN(input_size=<span class="number">1</span>, hidden_size=<span class="number">20</span>, num_layers=<span class="number">1</span>, batch_first=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè¾“å…¥å¼ é‡ (batch_size, seq_length, input_size)</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>)  <span class="comment"># 5 ä¸ªæ ·æœ¬, 3 ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥æœ‰ 1 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–éšè—çŠ¶æ€ (num_layers, batch_size, hidden_size)</span></span><br><span class="line">h0 = torch.zeros(<span class="number">1</span>, <span class="number">5</span>, <span class="number">20</span>)  <span class="comment"># 1 å±‚, 5 ä¸ªæ ·æœ¬, æ¯å±‚éšè—çŠ¶æ€æœ‰ 20 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå‰å‘ä¼ é€’</span></span><br><span class="line">output, hn = rnn(input_tensor, h0)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°è¾“å…¥å’Œè¾“å‡ºçš„å½¢çŠ¶</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Input shape:&quot;</span>, input_tensor.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Output shape:&quot;</span>, output.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hidden state shape:&quot;</span>, hn.shape)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Input shape: torch.Size([5, 3, 1])</span></span><br><span class="line"><span class="string">Output shape: torch.Size([5, 3, 20])</span></span><br><span class="line"><span class="string">Hidden state shape: torch.Size([1, 5, 20])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å› ä¸º RNN å±‚æ˜¯æ²¡æœ‰ output_size,æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªç”¨äº output_sizeï¼Œæ¯”å¦‚å›å½’è¾“å‡º 1 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 20ä¸ªç‰¹å¾é‡Œé¢ï¼Œæå–ä¸€ä¸ªè¾“å‡º</span></span><br><span class="line">out_linear = nn.Linear(in_features=<span class="number">20</span>, out_features=<span class="number">1</span>)</span><br><span class="line">output2 = out_linear(output)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Output shape:&quot;</span>, output2.shape)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ input å¯¹åº”èµ·æ¥äº†ï¼Œå°±æ˜¯ # 5 ä¸ªæ ·æœ¬, 3 ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥æœ‰ 1 ä¸ªç‰¹å¾</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Output shape: torch.Size([5, 3, 1])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>å› ä¸ºè®­ç»ƒæ•°æ® X.shape &#x3D; torch.Size([5, 3, 1]) <code>5 ä¸ªæ ·æœ¬, 3 ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥æœ‰ 1 ä¸ªç‰¹å¾</code>ï¼Œå¾—åˆ° output éƒ½æ˜¯ shape ä¸ X ä¸€è‡´ï¼Œéƒ½æ˜¯ torch.Size([5, 3, 1])ã€‚ ä½†æ˜¯æˆ‘ä»¬ä»…ä»…æ˜¯éœ€è¦ <strong>æœ€åæ—¶é—´æ­¥</strong> çš„æ•°æ®ï¼Œæ‰æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œå³ output[:, -1, :] å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å› ä¸º RNN å±‚æ˜¯æ²¡æœ‰ output_size,æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªç”¨äº output_sizeï¼Œæ¯”å¦‚å›å½’è¾“å‡º 1 ä¸ªç‰¹å¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 20ä¸ªç‰¹å¾é‡Œé¢ï¼Œæå–ä¸€ä¸ªè¾“å‡º</span></span><br><span class="line">out_linear = nn.Linear(in_features=<span class="number">20</span>, out_features=<span class="number">1</span>)</span><br><span class="line">output2 = out_linear(output[:,-<span class="number">1</span>,:])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Output shape:&quot;</span>, output2.shape)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ input å¯¹åº”èµ·æ¥äº†ï¼Œå°±æ˜¯ # 5 ä¸ªæ ·æœ¬, 3 ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥æœ‰ 1 ä¸ªç‰¹å¾</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Output shape: torch.Size([5, 1])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p><code>output[:, -1, :]</code> å– æœ€åæ—¶é—´æ­¥ çš„æ•°æ®ã€‚è¿™æ˜¯ä¸€ç§å–å·§çš„æ–¹æ³•ã€‚</p>
<p>ä½†æ˜¯æœ‰æ—¶å€™ï¼Œä»–å¹¶ä¸æ˜¯è¾“å‡ºæœ€åæ—¶é—´æ­¥çš„æ•°æ®ï¼Œæ‰€ä»¥è®°å¾—ç•™æ„æ„å»º targetï¼ˆçœŸå®å€¼ï¼‰ çš„æ—¶å€™ï¼Œæ³¨æ„æ˜¯å¦ä» model å‡ºæ¥çš„ yï¼ˆé¢„æµ‹å€¼ï¼‰ çš„ç»´åº¦ä¹‹é—´çš„å·®å¼‚ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="éšçŠ¶æ€"><a href="#éšçŠ¶æ€" class="headerlink" title="éšçŠ¶æ€"></a>éšçŠ¶æ€</h3><p>ä»–æ˜¯ä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œä»‹äºè¾“å…¥å’Œè¾“å‡ºä¹‹é—´ï¼Œæˆ–è€…è¯´è®°å¿†åŠ›ï¼Œä»–æ˜¯ RNN çš„ä¸€ä¸ªå…³é”®æ¦‚å¿µã€‚<br>ä»–åœ¨åç»­çš„ decode&amp;encode çš„æ¨¡å‹ä¸­ï¼Œéƒ½å‘æŒ¥ç€é‡è¦çš„ä½œç”¨ã€‚</p>
<h3 id="ä¼˜ç‚¹å’Œåœºæ™¯"><a href="#ä¼˜ç‚¹å’Œåœºæ™¯" class="headerlink" title="ä¼˜ç‚¹å’Œåœºæ™¯"></a>ä¼˜ç‚¹å’Œåœºæ™¯</h3><p>åºåˆ—æ•°æ®çš„ä»»åŠ¡é€‚åˆä½¿ç”¨ RNNã€‚</p>
<ol>
<li>è‚¡ç¥¨é¢„æµ‹</li>
<li>è‡ªç„¶è¯­è¨€å¤„ç†</li>
</ol>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ol>
<li>æ—¶é—´æ­¥è¿‡é•¿ï¼Œä¼šå¯¼è‡´å‰é¢çš„éšçŠ¶æ€ä¼šç»™å¿˜è®°äº†</li>
<li>æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸</li>
<li>è®¡ç®—æ•ˆç‡ç›¸å¯¹æ¯”è¾ƒä½</li>
</ol>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2>]]></content>
      <categories>
        <category>å­¦è‚¥AI</category>
      </categories>
      <tags>
        <tag>å­¦è‚¥AI</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>CNN</tag>
        <tag>NN</tag>
        <tag>å·ç§¯ç¥ç»ç½‘ç»œ</tag>
        <tag>RNN</tag>
      </tags>
  </entry>
</search>
