<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>seq2seq æ‰‹å·¥å®ç°åŠåŸç†åˆ†æ</title>
    <url>/2024/08/13/%5B%E5%AD%A6%E8%82%A5AI%5D%20seq2seq%20%E6%89%8B%E5%B7%A5%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯é—®é¢˜"><a href="#èƒŒæ™¯é—®é¢˜" class="headerlink" title="èƒŒæ™¯é—®é¢˜"></a>èƒŒæ™¯é—®é¢˜</h2><p>ç°å®ä¸­ï¼Œæœ‰ä¸€ç±»é—®é¢˜æ˜¯ <strong>è¾“å…¥è¾“å‡ºä¸å®šé•¿</strong> çš„ï¼Œæ¯”å¦‚</p>
<ol>
<li>ç¿»è¯‘ï¼Œä»ä¸­æ–‡åˆ°è‹±æ–‡</li>
<li>æ–‡ç”Ÿå›¾ï¼Œä¸€æ®µè¯ç”Ÿæˆä¸€ä¸ªå›¾ç‰‡</li>
<li>æ‘˜è¦ï¼Œæ€»ç»“ä¸€æ®µè¯çš„ä¿¡æ¯</li>
</ol>
<p>æ‰€ä»¥ <code>seq2seq</code> å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§ ä¸€ä¸²åºåˆ— ç”Ÿæˆ å¦å¤–ä¸€ä¸²åºåˆ— é—®é¢˜çš„æ¨¡å‹ã€‚</p>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><code>seq2seq</code>ï¼Œ<code>sequence to sequence</code>ï¼Œä¹Ÿæœ‰å¦å¤–ä¸€ç§å«æ³• <code>encoder and decoder</code>ã€‚ä»–æ˜¯ä¸€ç§ä¸Šå±‚æ¨¡å‹æ¶æ„ï¼Œå³æ˜¯ç»„åˆæ¨¡å‹ï¼Œä»–å¯ä»¥ç”±ä¸åŒçš„åº•å±‚æ¨¡å‹æ¥å®ç°ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å…ˆçœ‹åŸç†å›¾ã€‚<br><em>åŸç†å›¾</em><br><img src="https://qiniu.oldzhangtech.com/mdpic/65e94f22-668b-4d3f-accc-57617096e7d4_cd0a100f-9d6f-44db-86c6-5061e8e974ae.jpeg"><br>ä»åŸç†å›¾ä¸­å¯ä»¥çŸ¥é“ï¼Œ<code>seq2seq </code>æ¨¡å‹ æœ‰ä»¥ä¸‹çš„ç‰¹å¾ï¼š</p>
<ol>
<li>æ¨¡å‹éƒ½ä¼šæœ‰ä¸€ä¸ª <code>Encoder</code> ï¼Œä¸€ä¸ª <code>Decoder</code>ï¼Œå’Œä¸€ä¸ª <code>Context</code></li>
<li><code>Encoder</code> å°±æ˜¯å­—é¢æ„æ€çš„ â€“ ç¼–ç å™¨ï¼Œ<code>src_input</code> ç»è¿‡<code>Encoder</code> å¤„ç†ï¼Œè¾“å‡º <code>Context</code> ä¸­</li>
<li>åŒç†ï¼Œ<code>Decoder</code> å°±æ˜¯è§£ç å™¨ï¼Œ<code>tgt_input</code> å’Œ <code>Context</code> ç»è¿‡ <code>Decoder</code> å¤„ç†, è¾“å‡º <code>tgt_output</code></li>
<li><code>Encoder</code> å’Œ <code>Decoder</code> éƒ½å¿…é¡»èƒ½å¤Ÿè¯†åˆ« <code>Context</code><blockquote>
<p>srcï¼š sourceï¼Œ tgtï¼š target</p>
</blockquote>
</li>
</ol>
<p>ğŸ”¥ <code>Context</code> çš„ç»„æˆæ˜¯éå¸¸é‡è¦çš„ï¼Œä»–æ˜¯ <code>Encoder</code> å’Œ <code>Decoder</code> æ˜¯èƒ½å¤Ÿè¯†åˆ«çš„ä¸€ä¸ªä»‹è´¨ï¼Œæ˜¯é“¾æ¥ä¸¤è€…çš„æ¡¥æ¢ã€‚è¿™ç§ä»‹è´¨å¯ä»¥æ˜¯ _éšçŠ¶æ€_ï¼Œå¯ä»¥æ˜¯ _æ³¨æ„åŠ›çš„åŠ æƒè®¡ç®—å€¼_ï¼Œç­‰ç­‰ï¼Œè¿™äº›éƒ½ç”±åº•å±‚çš„æ¨¡å‹æ¥å†³å®šçš„ã€‚</p>
<p>å°±å¥½æ¯”å›½é™…è´¸æ˜“ä¸­ï¼Œæˆ‘ä»¬æƒ³ä¹°æ¾³å¤§åˆ©äºšé“çŸ¿ã€‚ ç¾å…ƒæ˜¯ç¡¬é€šè´§ï¼Œä¸­é—´ä»‹è´¨ï¼ŒZG å’Œ åœŸæ¾³ éƒ½è®¤ç¾å…ƒï¼Œæ‰€ä»¥ ZG encoder å…ˆæŠŠ RMB è½¬æˆ Dollarï¼Œç»™åˆ°åœŸæ¾³ decoderï¼ŒåœŸæ¾³å†æ¢å›è‡ªå·±çš„ æ¾³å…ƒã€‚</p>
<p>ğŸ”¥ <strong>ä¸å®šé•¿</strong>ï¼Œè¾“å…¥å€¼ï¼ˆæ¯”å¦‚ï¼Œé•¿åº¦æ˜¯ 8ï¼‰åœ¨ <code>Encoder</code> éƒ½è½¬æ¢æˆç»Ÿä¸€çš„ <code>Context</code>ï¼ˆæ¯”å¦‚ï¼Œ128 X 512 çš„ 2 å±‚ç¥ç»ç½‘ç»œï¼‰ï¼ŒåŒæ—¶ è¾“å‡ºå€¼çš„é•¿åº¦ï¼ˆæ¯”å¦‚ï¼Œé•¿åº¦æ˜¯ 10 ï¼‰ ç”± <code>Decoder</code> å’Œ <code>Context</code>  æ¥å†³å®šï¼Œå·²ç»ä¸è¾“å…¥å€¼æ— å…³äº†ã€‚</p>
<p>åŒæ—¶ï¼Œ<code>seq2seq</code> ä»…ä»…æ˜¯ä¸Šå±‚æ¶æ„ï¼Œåº•å±‚å®ç°çš„æ¨¡å‹æ˜¯å•¥éƒ½å¯ä»¥è§†æƒ…å†µè€Œå®šã€‚æ¯”å¦‚ï¼Œåº•å±‚å¯ä»¥æ˜¯ <code>RNN</code>ï¼Œå¯ä»¥æ˜¯ <code>LSTM</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯ <code>GRU</code>ï¼Œ ä¹Ÿå¯ä»¥æ˜¯ <code>Transformer</code>ã€‚æœ¬æ–‡ä¾‹å­ä¸­ä½¿ç”¨ <code>RNN</code> æ¥å®ç°ã€‚</p>
<h2 id="ä¾‹å­-â€“-ç¿»è¯‘"><a href="#ä¾‹å­-â€“-ç¿»è¯‘" class="headerlink" title="ä¾‹å­ â€“ ç¿»è¯‘"></a>ä¾‹å­ â€“ ç¿»è¯‘</h2><blockquote>
<p>ä¸‹é¢æ˜¯æ‰‹å·¥å®ç°ä¸€ä¸ªåŸºäº <code>RNN</code> çš„ <code>seq2seq</code> æ¨¡å‹ã€‚å¯è¿è¡Œçš„ ipynb æ–‡ä»¶çš„<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/seq2seq.ipynb">é“¾æ¥</a>ã€‚</p>
</blockquote>
<h3 id="ä»»åŠ¡ç›®æ ‡"><a href="#ä»»åŠ¡ç›®æ ‡" class="headerlink" title="ä»»åŠ¡ç›®æ ‡"></a>ä»»åŠ¡ç›®æ ‡</h3><p>ä¾‹å­çš„ç›®æ ‡ï¼Œä»æœ‰é™çš„ç¿»è¯‘èµ„æ–™ä¸­ï¼Œè®­ç»ƒå‡ºç¿»è¯‘çš„é€»è¾‘ï¼Œå®ç°ä»è‹±æ–‡ç¿»è¯‘æˆæ³•æ–‡ã€‚</p>
<h3 id="åˆ†æä»»åŠ¡"><a href="#åˆ†æä»»åŠ¡" class="headerlink" title="åˆ†æä»»åŠ¡"></a>åˆ†æä»»åŠ¡</h3><blockquote>
<p>è¿™é‡Œå…ˆä¸è®¨è®ºå­—ç¬¦çš„å¤„ç†æµç¨‹ï¼ˆæ¸…æ´—å­—ç¬¦ï¼Œè¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ç­‰ï¼‰ï¼Œæ‰€æœ‰çš„æµç¨‹ç®€å•åŒ–ï¼Œä»…ä»…æ˜¯éªŒè¯æ¨¡å‹çš„ä½¿ç”¨ã€‚</p>
</blockquote>
<ol>
<li>ç¿»è¯‘æ˜¯ä¸€ä¸ªâ€œåˆ†ç±»â€ä»»åŠ¡</li>
<li>è¿™ä¸ªæ˜¯ä¸€ä¸ªä¸å®šé•¿çš„è¾“å…¥å’Œè¾“å‡ºçš„ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>seq2seq</code> çš„æ¨¡å‹</li>
<li>åŒæ—¶è¾“å…¥å’Œè¾“å‡ºæ˜¯æœ‰æ—¶é—´åºåˆ—çš„ï¼Œæ‰€ä»¥åº•å±‚æ¨¡å‹ä½¿ç”¨å¸¦æœ‰è®°å¿†èƒ½åŠ›çš„æ¨¡å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>RNN</code></li>
</ol>
<p>â“ ä¸ºä»€ä¹ˆæ˜¯ä¸€ä»½åˆ†ç±»çš„ä»»åŠ¡ï¼Ÿ<br>è¿™å…¶å®æ˜¯ <code>word2index</code> çš„è¿‡ç¨‹ï¼Œæ¯ä¸ª <code>word</code> å°±æ˜¯ä¸€ä¸ªåˆ†ç±»ã€‚ä¸¾ä¾‹ï¼šæ¯”å¦‚ è¾“å…¥çš„æ˜¯è‹±æ–‡ï¼Œè‹±æ–‡ä¸­çš„ä¸€å…±æœ‰ 4000 ä¸ªå•è¯ï¼Œé‚£ä¹ˆè¾“å…¥çš„åˆ†ç±»å°±æ˜¯ 4000 ï¼›è¾“å‡ºçš„æ˜¯æ³•æ–‡ï¼Œæ³•æ–‡ä¸­çš„ä¸€å…±æœ‰ 2000 ä¸ªå•è¯ï¼Œé‚£ä¹ˆè¾“å‡ºçš„åˆ†ç±»å°±æ˜¯ 2000ã€‚</p>
<h3 id="ä»£ç ç»“æ„"><a href="#ä»£ç ç»“æ„" class="headerlink" title="ä»£ç ç»“æ„"></a>ä»£ç ç»“æ„</h3><p><img src="https://qiniu.oldzhangtech.com/mdpic/efa06cc1-1371-4e15-a0fd-0e5505739279_54099b97-f43c-47fc-ab0a-7f855bc6ad50.jpeg"><br>ä¸Šå›¾æ˜¯ æ•°æ®åœ¨ seq2seq æµåŠ¨ä¸­ä¸²èµ·ä¸åŒç»„ä»¶çš„è¿‡ç¨‹ã€‚</p>
<p><em>ç»„ä»¶è¯´æ˜ï¼š</em>   </p>
<ol>
<li><code>word_index</code>ï¼Œå°±æ˜¯æŠŠå•è¯è½¬æ¢æˆ <code>index</code></li>
<li><code>embedding</code>ï¼Œå°±è¦æŠŠç¦»æ•£çš„ <code>index</code> è½¬æ¢æˆå¯ä»¥è®¡ç®—çš„è¿ç»­çš„ <code>embedding</code>ï¼Œé€‚åˆæ¨¡å‹çš„è®¡ç®—</li>
<li><code>word_index</code> å’Œ <code>embedding</code> æ­£å¸¸æƒ…å†µæ˜¯ è¾“å…¥å’Œè¾“å‡ºéƒ½ä¸èƒ½å…±ç”¨çš„</li>
<li><code>encoder</code> é‡Œé¢æœ‰ <code>embedding</code>ï¼Œ<code>rnn</code><ol>
<li><code>rnn</code> è¾“å…¥ <code>src</code>ï¼Œ è¾“å‡º <code>hidden</code> éšçŠ¶æ€ï¼Œå³ <code>Context</code></li>
</ol>
</li>
<li><code>decoder</code> é‡Œé¢æœ‰ <code>embedding</code>ï¼Œ<code>rnn</code>ï¼Œ<code>full_connect</code><ol>
<li><code>rnn </code><strong>å¾ªç¯</strong>å åŠ è¾“å…¥ <code>tgt_input</code> å’Œ <code>Context</code>ï¼Œ è¾“å‡º <code>new hidden</code>,  <code>tgt_output</code></li>
<li><code>full_connect</code> è´Ÿè´£æŠŠ <code>tgt_output</code> ç”ŸæˆçœŸæ­£çš„ <code>real_tgt_ouput</code><blockquote>
<p>äº†è§£ä»–ä»¬çš„å…·ä½“èŒè´£åå†å»çœ‹ä»–ä»¬çš„ä»£ç å°±æ¸…æ™°å¤šäº†</p>
</blockquote>
</li>
</ol>
</li>
</ol>
<p><em>ä»£ç ç‰‡æ®µåˆ†æ</em>  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define the Encoder RNN</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EncoderRNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_size, hidden_size</span>):</span><br><span class="line">        <span class="built_in">super</span>(EncoderRNN, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = hidden_size</span><br><span class="line">        <span class="variable language_">self</span>.embedding = nn.Embedding(input_size, hidden_size)</span><br><span class="line">        <span class="variable language_">self</span>.rnn = nn.RNN(hidden_size, hidden_size, batch_first=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, input_seq, hidden</span>):</span><br><span class="line">        <span class="comment"># å†…éƒ¨è¿›è¡Œ embedding</span></span><br><span class="line">        <span class="comment"># ä¼ å…¥çš„æ˜¯ input_indices</span></span><br><span class="line">        embedded = <span class="variable language_">self</span>.embedding(input_seq)</span><br><span class="line">        output, hidden = <span class="variable language_">self</span>.rnn(embedded, hidden)</span><br><span class="line">        <span class="keyword">return</span> output, hidden</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_hidden</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> torch.zeros(<span class="number">1</span>, <span class="number">1</span>, <span class="variable language_">self</span>.hidden_size)</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¯ <code>encoder</code> çš„ä»£ç ï¼Œä½œç”¨å°±æ˜¯ï¼š</p>
<ol>
<li><code>src_input</code> è½¬æˆ <code>embedding</code></li>
<li><code>rnn</code> æŠŠ <code>embedding</code> è½¬æˆ <code>hidden</code>ï¼Œå³ <code>Context</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define the Decoder RNN</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecoderRNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, hidden_size, output_size</span>):</span><br><span class="line">        <span class="built_in">super</span>(DecoderRNN, ).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = hidden_size</span><br><span class="line">        <span class="variable language_">self</span>.embedding = nn.Embedding(output_size, hidden_size)</span><br><span class="line">        <span class="variable language_">self</span>.rnn = nn.RNN(hidden_size, hidden_size, batch_first=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.out = nn.Linear(hidden_size, output_size)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, input_seq, hidden</span>):</span><br><span class="line">        <span class="comment"># å†…éƒ¨è¿›è¡Œ embedding</span></span><br><span class="line">        <span class="comment"># ä¼ å…¥çš„æ˜¯ input_indices</span></span><br><span class="line">        embedded = <span class="variable language_">self</span>.embedding(input_seq)</span><br><span class="line">        output, hidden = <span class="variable language_">self</span>.rnn(embedded, hidden)</span><br><span class="line">        <span class="comment"># å°±æ˜¯ å…¨é“¾æ¥å±‚ ä» hidden -ã€‹ output_feature</span></span><br><span class="line">        output = <span class="variable language_">self</span>.out(output.squeeze(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> output, hidden</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_hidden</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> torch.zeros(<span class="number">1</span>, <span class="number">1</span>, <span class="variable language_">self</span>.hidden_size)</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¯ <code>dncoder</code> çš„ä»£ç ï¼Œä¸ <code>encoder </code>æ¯”è¾ƒå¤šäº†ä¸€ä¸ª <code>full connect</code> ä½¿ç”¨</p>
<ol>
<li><code>tgt_input</code> è½¬æˆ <code>embedding</code></li>
<li><code>rnn</code> æŠŠ <code>embedding</code> è½¬æˆ <code>hidden</code> å’Œ <code>output</code></li>
<li><code>full conect </code>å†æŠŠ <code>output</code> è½¬æˆ <code>output_feature</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define the Seq2Seq model</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Seq2Seq</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, encoder, decoder</span>):</span><br><span class="line">        <span class="built_in">super</span>(Seq2Seq, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># [1]</span></span><br><span class="line">        <span class="variable language_">self</span>.encoder = encoder</span><br><span class="line">        <span class="variable language_">self</span>.decoder = decoder</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, src_seq, tgt_seq, teacher_forcing_ratio=<span class="number">0.5</span></span>):</span><br><span class="line">        batch_size = src_seq.size(<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># count of words [[0, 1, 2, 9]]</span></span><br><span class="line">        max_len = tgt_seq.size(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 11</span></span><br><span class="line">        tgt_vocab_size = <span class="variable language_">self</span>.decoder.out.out_features</span><br><span class="line">        <span class="comment"># æœ‰ 11 ä¸ªéšçŠ¶æ€ï¼Œå°±æ˜¯ target ä¸­çš„å”¯ä¸€å€¼</span></span><br><span class="line">        outputs = torch.zeros(batch_size, max_len, tgt_vocab_size)</span><br><span class="line">        </span><br><span class="line">        encoder_hidden = <span class="variable language_">self</span>.encoder.init_hidden()</span><br><span class="line">        <span class="comment"># encoder çš„ä½œç”¨æ˜¯ è¾“å‡º hiddenï¼Œ output å°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰äº†</span></span><br><span class="line">        <span class="comment"># [2]</span></span><br><span class="line">        encoder_output, encoder_hidden = <span class="variable language_">self</span>.encoder(src_seq, encoder_hidden)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># tgt_seq ä½œç”¨ï¼Œå°±æ˜¯å–å¾—ç¬¬ä¸€ä¸ª &lt;sos&gt; token</span></span><br><span class="line">        decoder_input = tgt_seq[:, <span class="number">0</span>].unsqueeze(<span class="number">1</span>)  <span class="comment"># Start with &lt;sos&gt;</span></span><br><span class="line">        decoder_hidden = encoder_hidden</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># tgt_seq ä½œç”¨ï¼Œæˆªå–è¾“å‡ºçš„é•¿åº¦</span></span><br><span class="line">        <span class="comment"># ä¸å– 0ï¼Œæ˜¯å› ä¸º â€œ0â€œ index æ˜¯ä¸€ä¸ª &lt;sos&gt;</span></span><br><span class="line">        <span class="comment"># [3]</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, max_len):</span><br><span class="line">            <span class="comment"># [4]</span></span><br><span class="line">            decoder_output, decoder_hidden = <span class="variable language_">self</span>.decoder(decoder_input, decoder_hidden)</span><br><span class="line">            <span class="comment"># decoder_output shape (1,11)ï¼Œå…¶å®æ˜¯ä¸€ä¸ªå¤šåˆ†ç±»çš„é—®é¢˜</span></span><br><span class="line">            <span class="comment"># ä¸ outputs[:, t] = decoder_output æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸º batch_size æ’ç­‰äº 1ï¼Œæ‰€ä»¥æš‚æ—¶å½±å“ä¸å¤§ï¼Œä½†æ˜¯å®é™…åº”ç”¨ä¸­ï¼Œåº”è¯¥è¦æ”¹æˆå¯¹åº”çš„ batch</span></span><br><span class="line">            outputs[:, t, :] = decoder_output</span><br><span class="line">            top1 = decoder_output.argmax(<span class="number">1</span>).unsqueeze(<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># è¿™é‡Œæ˜¯å–å·§äº†ï¼Œteacher_forcing_ratio æ˜¯å–å·§äº†ã€‚</span></span><br><span class="line">            <span class="comment"># decode_input_t+1 æœ‰æ—¶æ˜¯ decode_output_tï¼Œ æœ‰æ—¶æ˜¯ real_target_seq_t</span></span><br><span class="line">            <span class="comment"># [5]</span></span><br><span class="line">            decoder_input = tgt_seq[:, t].unsqueeze(<span class="number">1</span>) <span class="keyword">if</span> random.random() &lt; teacher_forcing_ratio <span class="keyword">else</span> top1</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç æ˜¯ <code>seq2seq</code> æ¨¡å‹çš„å®šä¹‰ã€‚</p>
<p><em>è®­ç»ƒè¿‡ç¨‹</em><br>å¯ä»¥æ£€æŸ¥æ•°æ®åœ¨è¿™ä¸ªæ¨¡å‹ä¸­æµåŠ¨å¦‚ä¸‹ï¼š</p>
<ol>
<li>[1] é‡Œé¢åŒ…å«äº†ä¸€ä¸ª <code>encoder</code> å’Œ <code>decoder</code></li>
<li>[2] <code>forword</code> æ—¶,  <code>encoder</code> è½¬æ¢ <code>src_input</code> æˆ <code>hidden</code></li>
<li>[3] å¼€å§‹ <code>decoder</code> å¾ªç¯ï¼Œæœ€å¤§é•¿åº¦æ˜¯ <code>max_len</code>ã€‚åˆå§‹åŒ–å³æ˜¯ï¼š <code>decoder_input = â€œ&lt;sos&gt; indexâ€œ</code>ï¼Œ<code>decoder_hidden = encoder_hidden</code></li>
<li>[4] <code>decoder</code> è¾“å‡ºæ˜¯ <code>output_index</code> + <code>new_hidden</code></li>
<li>[5] <code>decoder_input+= output_index</code>, <code>decoder_hidden += new_hidden</code> å åŠ åå†èµ°æ­¥éª¤ [3] å¾ªç¯</li>
</ol>
<p>ğŸ’¡ <code>teacher_forcing</code> æ˜¯ä»€ä¹ˆï¼Ÿ<br>å°±æ˜¯è®­ç»ƒçš„æ—¶å€™ï¼Œæœ‰ä¸€å®šçš„æ¦‚ç‡è¾“å‡ºæ˜¯ <em>çœŸå®å€¼</em> è€Œä¸æ˜¯ _é¢„æµ‹å€¼_ã€‚å°±èƒ½æ˜¯æ¨¡å‹æ›´åŠ å¿«çš„æ”¶æ•›ï¼ŒåŠ é€Ÿæ¨¡å‹çš„å­¦ä¹ ã€‚ä½†æ˜¯è¿‡äºä¾èµ– _çœŸå®å€¼_ï¼Œå°±ä¼šå¯¼è‡´æ³›åŒ–èƒ½åŠ›å·®ã€‚<code>teacher_forcing_ratio</code> å°±å¯ä»¥è°ƒæ•´é˜ˆå€¼ã€‚</p>
<p><em>æ¨ç†è¿‡ç¨‹</em>  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">input_seq = torch.tensor(indices, dtype=torch.long).unsqueeze(<span class="number">0</span>)  <span class="comment"># (1, seq_len)</span></span><br><span class="line"><span class="comment"># å…¨éƒ¨çš„inputï¼Œéƒ½è½¬æˆ hidden</span></span><br><span class="line">encoder_hidden = model.encoder.init_hidden()</span><br><span class="line"><span class="comment"># encoder å’Œ decoder çš„ä½¿ç”¨æ˜¯åˆ†å¼€çš„ã€</span></span><br><span class="line"><span class="comment"># [1]</span></span><br><span class="line">encoder_output, encoder_hidden = model.encoder(input_seq, encoder_hidden)</span><br><span class="line"><span class="comment"># [2]</span></span><br><span class="line">decoder_input = torch.tensor([[fra_word2idx[<span class="string">&#x27;&lt;sos&gt;&#x27;</span>]]], dtype=torch.long)  <span class="comment"># Start token</span></span><br><span class="line">decoder_hidden = encoder_hidden</span><br><span class="line"></span><br><span class="line">translated_sentence = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># [3]</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(max_length):</span><br><span class="line">    <span class="comment"># decoder_input æ˜¯é€æ­¥çš„ç´¯åŠ çš„ï¼Œå°±æ˜¯ word1+word2+word3...</span></span><br><span class="line">    <span class="comment"># ç¬¬ä¸€ä¸ª decoder_hidden æ˜¯ encoder_hidden</span></span><br><span class="line">    <span class="comment"># ä»ç¬¬äºŒä¸ªå¼€å§‹ï¼Œå°±æ˜¯å¾ªç¯å¾—åˆ° decoder_hidden ä¸åœçš„ä¼ å…¥</span></span><br><span class="line">    <span class="comment"># encoder å’Œ decoder çš„ä½¿ç”¨æ˜¯åˆ†å¼€çš„</span></span><br><span class="line">    <span class="comment"># [4]</span></span><br><span class="line">    decoder_output, decoder_hidden = model.decoder(decoder_input, decoder_hidden)</span><br><span class="line">    top1 = decoder_output.argmax(<span class="number">1</span>).item()</span><br><span class="line">    <span class="comment"># &quot;&lt;UNK&gt;&quot;, which stands for â€œunknown.â€</span></span><br><span class="line">    <span class="comment"># [5]</span></span><br><span class="line">    translated_word = fra_idx2word.get(top1, <span class="string">&quot;&lt;UNK&gt;&quot;</span>)</span><br><span class="line">    translated_sentence.append(translated_word)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># [6]</span></span><br><span class="line">    <span class="keyword">if</span> translated_word == <span class="string">&#x27;&lt;eos&gt;&#x27;</span>:  <span class="comment"># End of sentence</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    decoder_input = torch.tensor([[top1]], dtype=torch.long)  <span class="comment"># Next input token</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> translated_sentence</span><br></pre></td></tr></table></figure>
<p><em>æ¨ç†è¿‡ç¨‹</em> å’Œ _è®­ç»ƒè¿‡ç¨‹_ï¼Œå…·ä½“åŸç†ä¸€è‡´ã€‚ æœ‰ä»¥ä¸‹çš„å·®å¼‚ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li>å¦‚ä½•å®šä¹‰å¼€å§‹è¾“å‡ºçš„æ ‡å¿—</li>
<li>å¦‚ä½•å®šä¹‰ç»“æŸè¾“å‡ºçš„æ ‡å¿—</li>
<li>å¦‚ä½•å®šä¹‰ä¸è®¤è¯†å­—ç¬¦çš„æ ‡å¿—</li>
</ol>
<p>ä»£ç åˆ†æï¼š</p>
<ol>
<li>[1] å•ç‹¬ä½¿ç”¨ <code>seq2seq&#39;s encoder</code>ï¼Œä¸” <em>ä¸€æ¬¡æ€§</em> ç”Ÿæˆ <code>encoder hidden</code></li>
<li>[2] <code>decoder_input</code> åˆå§‹åŒ–ï¼Œä»¥  â€˜<sos>â€˜ å¼€å¤´ï¼Œæ ‡å¿—å¼€å§‹è¾“å‡º</li>
<li>[3] <code>decoder</code> å¼€å§‹å¾ªç¯<ol>
<li>[4] å•ç‹¬ä½¿ç”¨ <code>seq2seq&#39;s decoder</code>, è¾“å‡º <code>ouput </code>å’Œ <code>new_hidden</code></li>
<li>[5] ç¢°åˆ°ä¸è®¤è¯†çš„åˆ†ç±»ï¼Œå°±ä½¿ç”¨ â€˜<UNK>â€˜å–ä»£</li>
<li>[6] å¦‚æœé‡åˆ° â€˜<eos>â€˜ å­—ç¬¦å°±ç›´æ¥ç»“æŸå¾ªç¯</li>
<li>å›åˆ° [3] ç»§ç»­å¾ªç¯</li>
</ol>
</li>
</ol>
<h3 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®­ç»ƒç»“æœ</span></span><br><span class="line">Epoch: <span class="number">0</span>, Loss: <span class="number">2.820215034484863</span></span><br><span class="line">Epoch: <span class="number">100</span>, Loss: <span class="number">1.0663029670715332</span></span><br><span class="line">Epoch: <span class="number">200</span>, Loss: <span class="number">1.1840879678726197</span></span><br><span class="line">Epoch: <span class="number">300</span>, Loss: <span class="number">1.224123215675354</span></span><br><span class="line">Epoch: <span class="number">400</span>, Loss: <span class="number">1.0645174384117126</span></span><br><span class="line">Epoch: <span class="number">500</span>, Loss: <span class="number">1.061875820159912</span></span><br><span class="line">Epoch: <span class="number">600</span>, Loss: <span class="number">1.0744179487228394</span></span><br><span class="line">Epoch: <span class="number">700</span>, Loss: <span class="number">1.0767890691757203</span></span><br><span class="line">Epoch: <span class="number">800</span>, Loss: <span class="number">1.099305510520935</span></span><br><span class="line">Epoch: <span class="number">900</span>, Loss: <span class="number">1.1019723176956178</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„æµ‹</span></span><br><span class="line">test_sentence = [<span class="string">&quot;i&quot;</span>, <span class="string">&quot;am&quot;</span>]</span><br><span class="line">translation = translate(model, test_sentence)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Translation:&quot;</span>, <span class="string">&quot; &quot;</span>.join(translation))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Translation: nous sommes &lt;eos&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li><code>seq2seq</code> æ˜¯ä¸€ç§ä¸Šå±‚æ¨¡å‹æ¶æ„ï¼Œåº”å¯¹è¾“å…¥å’Œè¾“å‡º<strong>ä¸å®šé•¿</strong>çš„åœºæ™¯</li>
<li><code>seq2seq</code> åº•å±‚å¯ä»¥ç”±<strong>ä¸åŒ</strong>çš„æ¨¡å‹æ„æˆ</li>
<li><code>seq2seq</code> çš„ <code>Context</code> æ˜¯ä¿å­˜äº†<strong>ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ï¼Œæ˜¯ <code>encoder</code> å’Œ <code>decoder</code> éƒ½å¿…é¡»èƒ½è¯†åˆ«çš„æ ¼å¼</li>
</ol>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
      <categories>
        <category>å­¦è‚¥AI</category>
      </categories>
      <tags>
        <tag>å­¦è‚¥AI</tag>
        <tag>seq2seq</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰‹å†™ Attention æ³¨æ„åŠ›æœºåˆ¶ åŠç†è§£</title>
    <url>/2024/08/16/%5B%E5%AD%A6%E8%82%A5AI%5D%20%E6%89%8B%E5%86%99%20Attention%20%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6%20%E5%8F%8A%E7%90%86%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯é—®é¢˜"><a href="#èƒŒæ™¯é—®é¢˜" class="headerlink" title="èƒŒæ™¯é—®é¢˜"></a>èƒŒæ™¯é—®é¢˜</h2><p><code>RNN</code> å’Œ å„ç§å˜ä½“ <code>RNN</code> ä¸­ <code>LSTM</code>&#x2F;<code>GRU</code> éƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•è§£å†³ é•¿è·ç¦»ä¿¡æ¯çš„æ„ŸçŸ¥ã€‚<code>RNN</code> çš„è§£å†³åŠæ³•æ˜¯åŠ å¤§ <code>sequence</code>ï¼Œæ›´é•¿çš„çª—å£è®°å¾—æ›´åŠ ä¹…è¿œçš„ä¿¡æ¯ï¼›<code>LSTM</code> å’Œ <code>GRU</code> å°±æ˜¯æŠŠè®°å¿†è®¾ç½®æˆä¸åŒçš„æƒé‡ï¼Œå¯¹é‡è¦çš„ä¿¡æ¯åŠ å¤§æƒé‡ã€‚<code>Attention</code> åˆæ˜¯å¦å¤–ä¸€ä¸ªè§’åº¦ï¼Œå»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="Attention-æ˜¯ä»€ä¹ˆ"><a href="#Attention-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Attention æ˜¯ä»€ä¹ˆ"></a>Attention æ˜¯ä»€ä¹ˆ</h2><p><code>Attention</code> ä¸­æ–‡æ˜¯æ³¨æ„åŠ›æœºåˆ¶ï¼Œæ˜¯å¯¹æŸä¸ªäº‹ç‰©çš„æŸéƒ¨åˆ†çš„å…³æ³¨ç‚¹ã€‚</p>
<p>ä»äººè„‘çš„è§’åº¦æƒ³ï¼Œæ—¶é—´å’Œèµ„æºéƒ½æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥åªèƒ½åœ¨ä¸€å®šçš„é™åº¦å†…å»å…³æ³¨æŸäº›éƒ¨åˆ†ã€‚æ¯”å¦‚çœ‹åˆ°ä¸€ç¾¤äººçš„ç…§ç‰‡ï¼Œæˆ‘ä»¬è‡ªç„¶å»æ‰¾ç¾å¥³ï¼›çœ‹ä¸€ä¸ªç¾å¥³çš„ç…§ç‰‡ï¼Œæˆ‘ä»¬è‡ªç„¶å»çœ‹ç¾å¥³çš„çœ¼ç›ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆä¼šä¸è‡ªä¸»çš„å»çœ‹è¿™äº›éƒ¨åˆ†è€Œä¸æ˜¯çœ‹å…¨æ™¯å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çš„æ³¨æ„åŠ›èµ„æºæ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬åªå¯¹å…³æ³¨ç‚¹é«˜çš„éƒ¨åˆ†æ„Ÿå…´è¶£ã€‚<br>è¿™æ˜¯å±äºåœ¨æˆ‘ä»¬äººè„‘é‡Œé¢çš„æ³¨æ„åŠ›æœºåˆ¶ã€‚<br>ä»æ¨¡å‹çš„è§’åº¦æƒ³ï¼Œç”¨æ•°å­¦å°†ä»–ä»¬å»ºæ¨¡ï¼Œä»–ä»¬åº”è¯¥æ˜¯æ³¨æ„åŠ›å¾—åˆ†æœ€é«˜çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æ¨¡å‹å¯ä»¥é‡ç‚¹å…³æ³¨çš„åœ°æ–¹ã€‚</p>
<p>æ€»ç»“ï¼Œä¸Šè¿°å°±æ˜¯ <code>Attention Score</code> çš„åŸºæœ¬çš„ç†è§£ã€‚è°å¾—åˆ†é«˜ï¼Œè°å°±å¯ä»¥å¾—åˆ°æ›´åŠ å¤šçš„å…³æ³¨ã€‚</p>
<p>ä¸‹é¢æŠŠ <code>Attention Score</code> ç”¨åœ¨ä¸€æ®µè¯çš„ç†è§£ä¸Šã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ä¸€å¥è¯ä½œä¸ºä¾‹å­ï¼šå§šæ˜ï¼Œä»–çˆ¸æœ‰ 2 ç±³é«˜ï¼Œä»–ä»å°çš„æ•°å­¦æˆç»©å¹¶ä¸å¥½ï¼Œç»å¸¸æ—·è¯¾ï¼Œä»–çˆ±åƒè‹¹æœï¼Œä»–è¡€å‹æ˜¯ Aã€‚çˆ±ç©æ¸¸æˆï¼Œä»–æœ€å–œæ¬¢çš„æ¸¸æˆå°±æ˜¯å¡å°”è¾¾ä¼ è¯´ï¼Œä»–è¿˜ç»å¸¸é€ƒè¯¾å»ç©ï¼›æœ‰æ—¶å€™ä»–ä¼šæ‰“ä¸€ä¸‹ç¯®çƒå’Œå…µä¹“çƒï¼Œä»–æœ€å–œæ¬¢çš„è¿åŠ¨æ˜¯è·‘æ­¥ã€‚ä»–ç°åœ¨èº«é«˜æ˜¯ 2.13 ç±³ï¼Œä½“é‡æ˜¯ 200 æ–¤ï¼Œé‹å­è¦ç©¿ 48 ç çš„ã€‚<br>è¯·é—®ï¼šä»–ä¸ºä»€ä¹ˆå¯ä»¥é•¿è¿™ä¹ˆé«˜ã€‚</p>
<p>ä»äººè„‘çš„è§’åº¦ï¼Œâ€œå§šæ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜â€ï¼Œå¾ˆè‡ªç„¶çš„æƒ³åˆ°ï¼Œä»–çˆ¶æ¯é«˜ï¼ŒåŸºå› å¥½ã€‚ä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªåˆ¤æ–­ï¼Œæ˜¯å› ä¸ºé—®é¢˜ï¼Œå’Œ â€œçˆ¶æ¯é«˜â€è¿™ä¸ªä¿¡æ¯æ˜¯ <strong>å…³è”åº¦æœ€é«˜</strong>çš„ã€‚<br>ä»æ¨¡å‹çš„è§’åº¦æƒ³ï¼Œç”¨æ•°å­¦å°†ä»–ä»¬å»ºæ¨¡ï¼Œå³ <em>é—®é¢˜</em> å’Œ <em>ä¿¡æ¯çš„æŸä¸ªéƒ¨åˆ†</em> ï¼Œè®¡ç®—çš„<code>Score</code> å¾—åˆ†æœ€é«˜ï¼Œæ‰€ä»¥ä»–ä»¬çš„å…³è”åº¦æœ€é«˜ï¼Œå³ä»–ä»¬å…·æœ‰é€»è¾‘ç›¸å…³æ€§ã€‚</p>
<p>æ€»ç»“ï¼Œ<code>Attention æœºåˆ¶</code> åœ¨è‡ªç„¶è¯­è¨€ç†è§£ä¸Šï¼Œå³ç›¸äº’çš„ <code>Score</code> è¶Šé«˜åˆ†ï¼Œå³ç›¸äº’çš„å…³è”æ€§å°±è¶Šå¤§ï¼Œå³ä»–ä»¬å…·æœ‰é€»è¾‘æ€§ã€‚</p>
<blockquote>
<p>é¢˜å¤–è¯ï¼š è¿™ä¸ªæœ‰ç‚¹åƒ <strong>é€»è¾‘</strong>ã€‚<br>æˆ‘ä»¬å¤§è„‘æ˜¯ç¥ç»å…ƒæ„æˆçš„ã€‚ç¥ç»å…ƒï¼Œå³æ˜¯ ç»™ä¸€ä¸ªé«˜ç”µå¹³å°±æ˜¯ 1 ï¼Œç»™ä¸€ä¸ªä½ç”µå¹³å°±æ˜¯ 0 çš„è§¦è§’ï¼›è¿™ä¸ªè§¦è§’ï¼Œåˆå¯ä»¥è§¦å‘å¦å¤–çš„ç¥ç»å…ƒã€‚è¿™ç§å°±æ˜¯ â€œä¸€ç”ŸäºŒï¼ŒäºŒç”Ÿä¸‰ï¼Œä¸‰ç”Ÿä¸‡ç‰©â€çš„ä½“ç°ã€‚å› ä¸ºè¿™ç§è§¦è§’çš„è§¦å‘ï¼Œå°±åœ¨æˆ‘ä»¬çš„å¤§è„‘é‡Œé¢å½¢æˆäº† <strong>é€»è¾‘</strong>ã€‚<br><code>Attention Score</code>ï¼Œæœ‰å¯èƒ½æ„æˆäº†æ¨¡å‹é¢†åŸŸä¸­çš„ _åŸºç¡€è§¦è§’_ï¼Œæœ€åå½¢æˆäº†æ¨¡å‹é¢†åŸŸä¸­ <strong>é€»è¾‘</strong>ã€‚</p>
</blockquote>
<h2 id="åˆ†æ¦‚å¿µè®²è§£"><a href="#åˆ†æ¦‚å¿µè®²è§£" class="headerlink" title="åˆ†æ¦‚å¿µè®²è§£"></a>åˆ†æ¦‚å¿µè®²è§£</h2><p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥ç®€å•çš„æ¢³ç†å‡º <code>Attention æœºåˆ¶</code>ã€‚ä½†æ˜¯è½åˆ°ç»†èŠ‚é‡Œé¢ï¼Œ<code>Attention Score</code> æ€ä¹ˆè®¡ç®—ï¼Œå°±æ˜¯ä»å®é™…çš„æ•°å­¦æ¨¡å‹çš„è§’åº¦å»è¯´æ˜äº†ã€‚ä¸‹é¢å°± <code>Attention Score</code> æ€ä¹ˆå»è®¡ç®—ä¸ºçº¿å¤´ï¼Œæ¥è®²è§£ä¸åŒæ¦‚å¿µã€‚</p>
<blockquote>
<p>ä¸‹é¢æ˜¯ä¸€æ­¥ä¸€æ­¥çš„è¯´æ˜ Attention æœºåˆ¶ çš„å„ç§ç»„ä»¶ï¼Œå’Œä»–ä»¬èƒ½å¤Ÿè§£å†³åˆ°ä»€ä¹ˆé—®é¢˜ã€‚</p>
</blockquote>
<h3 id="QKV-æœºåˆ¶"><a href="#QKV-æœºåˆ¶" class="headerlink" title="QKV æœºåˆ¶"></a>QKV æœºåˆ¶</h3><blockquote>
<p>Query Key Value</p>
</blockquote>
<p>å¦‚æœå¯¹ä¸Šè¿°çš„é‚£å¥è¯åˆ†æˆä¸åŒçš„ç‰‡æ®µï¼šâ€œä»–çˆ¸æœ‰ 2 ç±³é«˜â€ seg1ï¼Œâ€œä»–ä»å°çš„æ•°å­¦æˆç»©å¹¶ä¸å¥½â€ seg2ï¼Œâ€œç»å¸¸æ—·è¯¾â€ seg3ï¼Œâ€œä»–çˆ±åƒè‹¹æœâ€ seg4ï¼Œâ€œä»–è¡€å‹æ˜¯ Aâ€ seg5ï¼Œæ¯ä¸ªç‰‡æ®µéƒ½æºå¸¦äº†ä¸€å®šé‡çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç»Ÿç§°ä»–ä»¬æºå¸¦çš„ä¿¡æ¯æ˜¯ <strong>éšçŠ¶æ€</strong> <strong>hidden</strong>ã€‚å¯¹åº”ç€ï¼Œç‰‡æ®µçš„éšçŠ¶æ€å°±æ˜¯ h1, h2â€¦h5ã€‚</p>
<p>é¢å¯¹ â€œå§šæ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜â€ é—®é¢˜çš„æ—¶å€™ï¼Œè‡ªç„¶çš„å°±è®¤ä¸º <code>seg1</code> çš„å…³è”æ€§æ˜¯æœ€é«˜çš„ã€‚ä½†æ˜¯å¦‚æœé¢å¯¹ â€œä»–ä¸‰è§’å‡½æ•°ä¸æ‡‚â€é—®é¢˜çš„æ—¶å€™ï¼Œæ˜¾ç„¶æ˜¯ <code>seg2</code> çš„å…³è”æ€§æ˜¯æœ€é«˜çš„ã€‚<br>æ‰€ä»¥çš„å‡ºï¼Œ åŒä¸€ä¸ª<code>query</code> å¯¹åº”ä¸åŒçš„ <code>segment</code> çš„ï¼Œæœ‰ä¸åŒçš„ <code>Attention Score</code>ï¼›ä¸åŒçš„ <code>query</code> éƒ½åº”è¯¥å¯¹ åŒä¸€æ‰¹çš„ <code>segment</code> æœ‰ä¸åŒçš„ <code>Attention Score</code>ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/27d4a47e-6390-46e1-9cfc-cf807a964c95_1b303e9c-fe57-42f2-80ce-1b15069c47fc.jpeg"><br>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå°±æ˜¯è¿çº¿çš„å®½åº¦ä¸åŒï¼Œæ˜¾ç¤ºäº† <code>query</code> å’Œ ä¸åŒ <code>segment</code> ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œå³ä¸åŒçš„å¾—åˆ†ã€‚</p>
<p>å¦‚æœåŸºäºä¼ ç»Ÿçš„ <code>RNN</code> å»è¡¨è¾¾ <code>Attention</code>ï¼Œæœ‰ä¸€å®šçš„å±€é™æ€§ã€‚ <code>RNN</code> çš„è®¡ç®—éšçŠ¶æ€ <code>hidden</code> éƒ½æ˜¯ä¸å˜çš„ï¼Œå³æ¯ä¸ªä¿¡æ¯ï¼ˆç‰‡æ®µï¼‰ä»…ä»…åªæœ‰ä¸€ä¸ªç»´åº¦ï¼Œåªæœ‰ä¸€ä¸ªå€¼ã€‚<br>æ‰€ä»¥ <code>Attention æœºåˆ¶</code> å°† <code>hidden</code> åˆ†æ‹†æˆ <code>key</code> å’Œ <code>value</code>ï¼Œä¸” <code>query</code> å¾ªç¯å’Œæ‰€æœ‰çš„ <code>key</code> å’Œ <code>value</code> è®¡ç®—åæ‰å¾—åˆ° <code>Score</code>ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/ed7f2a6d-58cc-4d66-ab04-87e683be4ded_b6102f89-59fd-47a1-94f4-4c0096fa84d4.jpeg"><br>ä¸Šå›¾ç®€åŒ–å‡ºæ¥çš„å…¬å¼å°±æ˜¯ <code>Attention Score</code> &#x3D; $Attention(QW^Q,KW^K,VW^V)$ ï¼Œå°±æ˜¯ <strong>æ³¨æ„åŠ›è¯„åˆ†å…¬å¼</strong> äº†ã€‚</p>
<p>è¿™ç§æŠŠ <code>hidden</code> æ‹†åˆ†æˆ <code>key</code> å’Œ <code>value</code>ï¼Œå¹¶ä¸”ç»“åˆ  <code>query</code> è®¡ç®—å°±æ˜¯ <code>QKV æœºåˆ¶</code>ï¼ˆ query key value æœºåˆ¶ï¼‰ã€‚</p>
<h3 id="å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶"><a href="#å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶" class="headerlink" title="å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶"></a>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶</h3><blockquote>
<p>Multiple Head Attention</p>
</blockquote>
<p>ä»ä¸Šè¿°çš„ <code>QKV æœºåˆ¶</code> çŸ¥é“ï¼Œ<code>query</code> å°±æ˜¯æ ¹æ®å…´è¶£ç‚¹ï¼Œè§¦å‘å¯¹ç‰‡æ®µè®¡ç®—è¯„åˆ†ã€‚<br>å¦‚æœä»…ä»…æ˜¯ä¸€ä¸ª <code>query</code>ï¼Œå…¶å®å’Œ å•ä¸€ä½¿ç”¨ <code>RNN hidden</code> æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼›ä½†æ˜¯å¦‚æœå¢åŠ å¤šå‡ ä¸ª <code>query</code>ï¼Œå°±å¯ä»¥å¯¹ä¿¡æ¯è¿›è¡Œä¸åŒç»´åº¦çš„åˆ†å±‚ï¼Œä¹Ÿå°±æ˜¯ <strong>å¤šå¤´</strong> çš„æ„æ€ã€‚</p>
<p>ğŸ”¥ å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼Œå°±æ˜¯å­—å¦‚å…¶åï¼Œå¤šä¸ª <code>head</code>ï¼Œå¤šä¸ª <code>query</code>ï¼› ä¸€ä¸ª <code>head</code> å°±æ˜¯ ä¸€ä¸ª <code>query</code>ã€‚</p>
<p>æ¯”å¦‚ï¼Œâ€œå§šæ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜â€ï¼Œâ€œä»–ä¸‰è§’å‡½æ•°ä¸æ‡‚â€ è¿™ä¸¤ä¸ª <code>query</code> éƒ½åŒæ—¶å¯¹åŸä¿¡æ¯è¿›è¡Œç»Ÿè®¡è¯„åˆ†ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸åŒ <code>segment</code> å¯¹åº”çš„ <code>Attention Score</code>ã€‚</p>
<p>ğŸ”¥ æœ‰ç‚¹åƒæ˜¯  <code>CNN</code> çš„å·ç§¯æ ¸ï¼Œå¯ä»¥æŠ½å–ä¸åŒçš„ç‰¹å¾ç»´åº¦ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/d759a94d-fe06-4a2c-baee-e3600f458cd8_389bd982-7410-49f2-9f81-577b6901d74c.jpeg"><br><code>query</code>, <code>key</code>, <code>value</code> å› ä¸ºä¸åŒçš„ <code>head</code> éƒ½å¸¦æœ‰è‡ªå·±çš„ï¼ˆ$W^Q W^K W^V$ï¼‰ çŸ©é˜µè¿›è¡Œå­¦ä¹ ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå¸¦æ¥æ›´åŠ å¤šçš„å­¦ä¹ æ€§ã€‚</p>
<h3 id="è‡ªæ³¨æ„åŠ›æœºåˆ¶"><a href="#è‡ªæ³¨æ„åŠ›æœºåˆ¶" class="headerlink" title="è‡ªæ³¨æ„åŠ›æœºåˆ¶"></a>è‡ªæ³¨æ„åŠ›æœºåˆ¶</h3><blockquote>
<p>Self Attention</p>
</blockquote>
<p>æœ‰æ—¶å€™ï¼Œä¸€å¥è¯ä¸­ï¼Œå·²ç»è•´å«äº†é€»è¾‘ã€‚æ¯”å¦‚ä¸Šé¢çš„â€œå§šæ˜æè¿°â€ï¼Œå°±ç®—æ²¡æœ‰æé—®ï¼Œéƒ½å¯ä»¥ä»è‡ªèº«çš„å¥å­ä¸­å»ºç«‹äº†å…³è”ã€‚</p>
<p>æ¯”å¦‚ï¼Œâ€œä»–ä»å°çš„æ•°å­¦æˆç»©å¹¶ä¸å¥½â€ <code>seg2</code> å’Œ â€œç»å¸¸æ—·è¯¾â€ <code>seg3</code>ï¼Œä»–ä»¬ä¸¤ä¸ªç‰‡æ®µå°±æœ‰éå¸¸å¼ºçš„ç›¸å…³æ€§ï¼Œä»–ä»¬ <code>Attention Score</code> çš„å¾—åˆ†å°±é«˜ï¼›åŒç†â€œç»å¸¸æ—·è¯¾â€ <code>seg3</code>ï¼Œâ€œä»–çˆ±åƒè‹¹æœâ€ <code>seg4</code>ï¼Œä»–ä»¬çš„å¾—åˆ†å°±ä¸é«˜ã€‚</p>
<p>ğŸ”¥ æ‰€ä»¥å½“ <code>Query Key Value</code> éƒ½æ˜¯è‡ªå·±çš„ï¼Œå°±æ˜¯ <strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong>ï¼Œå¯¹è‡ªå·±çš„ä¿¡æ¯ç‰‡æ®µå»ºç«‹ <code>Attention Score</code>ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/0cdf99e8-066b-4390-a980-6c5ac39ce0b2_e1aab5d8-ebd1-4c02-8f37-6bed0a48f488.jpeg"><br>ä¸Šå›¾å¯ä»¥çŸ¥é“ï¼Œè¶Šç²—çš„çº¿ï¼Œå°±æ˜¯ä»–ä»¬çš„ <code>attention score</code> æ›´åŠ çš„é«˜åˆ†ï¼›ä¸”è¿™æ˜¯è‡ªèº«ç‰‡æ®µå’Œç‰‡æ®µä¹‹é—´çš„è¯„åˆ†ã€‚å°±æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„ä½“ç°ã€‚</p>
<h3 id="æ³¨æ„åŠ›å¾—åˆ†ä»£ç éƒ¨åˆ†"><a href="#æ³¨æ„åŠ›å¾—åˆ†ä»£ç éƒ¨åˆ†" class="headerlink" title="æ³¨æ„åŠ›å¾—åˆ†ä»£ç éƒ¨åˆ†"></a>æ³¨æ„åŠ›å¾—åˆ†ä»£ç éƒ¨åˆ†</h3><p><code>Attention Score</code>ï¼Œåˆ°åº•ä»–ä»¬æ˜¯å¦‚ä½•è®¡ç®—çš„å‘¢ï¼Ÿ<br>ä¸‹é¢æ˜¯ç®€æ˜“è‡ªæ³¨æ„åŠ›å¾—åˆ†çš„ä»£ç ç‰‡æ®µã€‚é‡Œé¢å·²ç»åŒ…å«äº† <strong>QKV æœºåˆ¶</strong>ï¼Œ<strong>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶</strong>ï¼Œå’Œ <strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong>ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># [0]</span></span><br><span class="line">query_f = nn.Linear(d_model, d_model)</span><br><span class="line">key_f = nn.Linear(d_model, d_model)</span><br><span class="line">value_f = nn.Linear(d_model, d_model)</span><br><span class="line">fc = nn.Linear(d_model, d_model)</span><br><span class="line"><span class="comment"># [3]</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, query, key, value, mask=<span class="literal">None</span></span>):</span><br><span class="line">    batch_size = query.size(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">transform</span>(<span class="params">x</span>):</span><br><span class="line">        <span class="keyword">return</span> x.view(batch_size, -<span class="number">1</span>, <span class="variable language_">self</span>.num_heads, <span class="variable language_">self</span>.d_k).transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="comment"># [1] å¯¹ queryï¼Œkeyï¼Œvalue è¿›è¡Œå…¨é“¾æ¥çš„è½¬æ¢</span></span><br><span class="line">    query = transform(query_f(query))</span><br><span class="line">    key = transform(key_f(key))</span><br><span class="line">    value = transform(value_f(value))</span><br><span class="line">    <span class="comment"># [2] å°è£…çš„æ–¹æ³•</span></span><br><span class="line">    attn_output, attn = ScaledDotProductAttention(<span class="variable language_">self</span>.d_k)(query, key, value, mask)</span><br></pre></td></tr></table></figure>
<p>_ä»£ç è§£æ_ï¼š  </p>
<ol>
<li>[0] query_fï¼Œkey_fï¼Œ value_f å®šä¹‰ å…¨é“¾æ¥ç½‘ç»œï¼Œç”¨äºå­¦ä¹ çš„å‚æ•°</li>
<li>[1] queryï¼Œkeyï¼Œvalue è¿›è¡Œå…¨é“¾æ¥çš„è½¬æ¢ï¼Œè¿™é‡Œæœ‰å‚æ•°çš„å­¦ä¹ </li>
<li>[2] å°è£…çš„æ–¹æ³•ï¼Œå¯ä»¥è®¡ç®—å‡ºæœ€åçš„ <code>Attention Sore</code>ï¼Œé‡Œé¢å·²ç»åŒ…å« ç‚¹ç§¯&#x2F;softmax ç­‰è®¡ç®—</li>
<li>[3] å¦‚æœ query, key, value éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ª <strong>å¤šå¤´çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong> çš„è®¡ç®—å…¬å¼</li>
</ol>
<p> å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„æ•°å­¦è¡¨è¾¾å¼ï¼š<br>$head_i&#x3D;Attention(QW_i^Q,KW_i^K,VW_i^V)$ ï¼ˆ $W_i^Q W_i^K W_i^V$ éƒ½æ˜¯ä¸åŒçš„å…¨é“¾æ¥ç½‘ç»œ ï¼‰</p>
<h3 id="ä¾‹å­è¯´æ˜"><a href="#ä¾‹å­è¯´æ˜" class="headerlink" title="ä¾‹å­è¯´æ˜"></a>ä¾‹å­è¯´æ˜</h3><p>å¯è¿è¡Œçš„ ipynb æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/attention.ipynb">é“¾æ¥</a>ã€‚<br>ä»»åŠ¡ï¼šè¾“å…¥æ•°æ®ï¼Œè®¡ç®—æ•°æ®ä¹‹é—´çš„æ³¨æ„åŠ›åˆ†æ•°ï¼Œå¹¶ä¸”å¯ä»¥è§†è§‰åŒ–æ•°æ®ä¹‹é—´çš„å…³æ³¨åº¦ã€‚</p>
<p><em>ä»£ç è§£æ</em>  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">input_seq = torch.tensor([</span><br><span class="line">    [<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>],  <span class="comment"># Token 1</span></span><br><span class="line">    [<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>],  <span class="comment"># Token 2</span></span><br><span class="line">    [<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>],  <span class="comment"># Token 3</span></span><br><span class="line">    [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>],  <span class="comment"># Token 4</span></span><br><span class="line">    [<span class="number">1.0</span>, <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.0</span>]   <span class="comment"># Token 5</span></span><br><span class="line">], dtype=torch.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dimensions</span></span><br><span class="line">d_k = input_seq.shape[<span class="number">1</span>]  <span class="comment"># Embedding dimension (4 in this case)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Query, Key, and Value are all set to the input sequence (self-attention)</span></span><br><span class="line">query = input_seq</span><br><span class="line">key = input_seq</span><br><span class="line">value = input_seq</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calculate attention scores (scaled dot-product)</span></span><br><span class="line"><span class="comment"># [1]</span></span><br><span class="line">scores = torch.matmul(query, key.transpose(-<span class="number">2</span>, -<span class="number">1</span>)) / torch.sqrt(torch.tensor(d_k))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attention scores:\n&quot;</span>, scores)</span><br><span class="line"><span class="comment"># Apply softmax to get attention weights</span></span><br><span class="line"><span class="comment"># [2]</span></span><br><span class="line">attention_weights = F.softmax(scores, dim=-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attention scores afert softmax:\n&quot;</span>, attention_weights)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calculate the output as a weighted sum of the values</span></span><br><span class="line"><span class="comment"># [3]</span></span><br><span class="line">output = torch.matmul(attention_weights, value)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attention Weights:\n&quot;</span>, attention_weights)</span><br></pre></td></tr></table></figure>

<ol>
<li><p>[1] ç®€å•ä½¿ç”¨å¯¹ query key è¿›è¡Œ ç‚¹ç§¯ æ¥è®¡ç®—åˆ†æ•°</p>
<blockquote>
<p>è¿™é‡Œä½¿ç”¨äº†ç®€åŒ–ç‰ˆæœ¬ï¼Œ<strong>æ²¡æœ‰</strong> $W^q$ $W^k$ çš„çŸ©é˜µå­¦ä¹ </p>
</blockquote>
</li>
<li><p>[2] softmax scoreï¼Œå…¨éƒ¨å€¼å½’ä¸€åˆ° (0,1) çš„å€¼ä¸­</p>
</li>
<li><p>[3] score å’Œ value ç›¸ä¹˜ï¼Œå¾—åˆ°æœ€åçš„ weightsï¼Œå°±æ˜¯æœ€åçš„ç»“æœ</p>
<blockquote>
<p>è¿™é‡Œä½¿ç”¨äº†ç®€åŒ–ç‰ˆæœ¬ï¼Œ<strong>æ²¡æœ‰</strong> $W^v$  çš„çŸ©é˜µå­¦ä¹ </p>
</blockquote>
</li>
</ol>
<p><em>è¿è¡Œç»“æœ</em>  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Attention scores:</span></span><br><span class="line"><span class="string"> tensor([[1.0000, 0.0000, 0.5000, 0.5000, 0.7500],</span></span><br><span class="line"><span class="string">        [0.0000, 1.0000, 0.5000, 0.5000, 0.2500],</span></span><br><span class="line"><span class="string">        [0.5000, 0.5000, 1.0000, 0.0000, 0.7500],</span></span><br><span class="line"><span class="string">        [0.5000, 0.5000, 0.0000, 1.0000, 0.2500],</span></span><br><span class="line"><span class="string">        [0.7500, 0.2500, 0.7500, 0.2500, 0.7500]])</span></span><br><span class="line"><span class="string">Attention scores afert softmax:</span></span><br><span class="line"><span class="string"> tensor([[0.2976, 0.1095, 0.1805, 0.1805, 0.2318],</span></span><br><span class="line"><span class="string">        [0.1205, 0.3275, 0.1986, 0.1986, 0.1547],</span></span><br><span class="line"><span class="string">        [0.1805, 0.1805, 0.2976, 0.1095, 0.2318],</span></span><br><span class="line"><span class="string">        [0.1986, 0.1986, 0.1205, 0.3275, 0.1547],</span></span><br><span class="line"><span class="string">        [0.2374, 0.1440, 0.2374, 0.1440, 0.2374]])</span></span><br><span class="line"><span class="string">Attention Weights:</span></span><br><span class="line"><span class="string"> tensor([[0.2976, 0.1095, 0.1805, 0.1805, 0.2318],</span></span><br><span class="line"><span class="string">        [0.1205, 0.3275, 0.1986, 0.1986, 0.1547],</span></span><br><span class="line"><span class="string">        [0.1805, 0.1805, 0.2976, 0.1095, 0.2318],</span></span><br><span class="line"><span class="string">        [0.1986, 0.1986, 0.1205, 0.3275, 0.1547],</span></span><br><span class="line"><span class="string">        [0.2374, 0.1440, 0.2374, 0.1440, 0.2374]])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/6d9f194c-b314-4af9-bb93-dd782176ad6a_169e0c5f-3757-4035-b6eb-aa505bd920b9.png" alt="image.png"><br>ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œæ³¨æ„åŠ›çš„çƒ­å›¾ï¼Œè¡¨ç¤ºæ¯ä¸ª token ä¹‹é—´çš„æ³¨æ„åŠ›çš„å…³ç³»ã€‚ Y è½´æ˜¯ <code>Query Token</code>ï¼ŒX è½´æ˜¯ <code>Key Token</code>ã€‚å›¾ä¸­æ¯ä¸€è¡Œä¸­è¶Šæ·±è‰²çš„æ–¹å—ï¼Œå°±ä»£è¡¨ <code>Query</code> åœ¨è¿™è¡Œä¸­çš„  <code>Key</code> çš„å¾—åˆ†æœ€é«˜ã€‚<br>æ¯”å¦‚ï¼Œç¬¬ä¸€è¡Œï¼Œ<code>query1</code> å¯¹ <code>key1</code>ï¼ˆè‡ªå·±ï¼‰çš„é¢œè‰²æœ€æ·±ï¼Œè¯´æ˜æ¯ä¸ª <code>Token</code> éƒ½åº”è¯¥ä¸è‡ªå·±çš„å…³è”åº¦é«˜ï¼›ç¬¬ 5 è¡Œï¼Œ<code>query5</code> å¯¹ <code>key1</code>ï¼Œ<code>key3</code>ï¼Œ<code>key5</code> çš„å¾—åˆ†ä¸€æ ·ä¸”é¢œè‰²æœ€æ·±ï¼Œè¯´æ˜ <code>query5</code> çš„å…³è”ä¸ <code>key1</code>ï¼Œ<code>key3</code>ï¼Œ<code>key5</code> ç›¸ä¸€æ ·ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>Attention æœºåˆ¶</code> çš„ä¼˜åŠ¿  </p>
<ol>
<li>å…³æ³¨ä½ æƒ³è¦çš„ä¿¡æ¯ï¼Œè§£å†³äº†é•¿åºåˆ—çš„é—®é¢˜</li>
<li>å¯ä»¥æœ‰å¤šç»´çš„è§’åº¦å»ç†è§£æ•°æ®</li>
<li>å…¶ä¸­è•´å«äº†é€»è¾‘</li>
</ol>
<p><code>Attention æœºåˆ¶</code> æ˜¯ <code>Transformer</code> çš„åŸºç¡€ï¼Œæ‰€æœ‰æ‰€æœ‰çš„ <code>NLP</code> ä¸­æ‰“å¼€äº†æ–°çš„ä¸€æ‰‡çª—ã€‚</p>
<h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://zh-v2.d2l.ai/chapter_attention-mechanisms/attention-cues.html#id4">Dive into deep learning</a></p>
]]></content>
      <categories>
        <category>å­¦è‚¥AI</category>
      </categories>
      <tags>
        <tag>å­¦è‚¥AI</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>Attention</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰‹å†™ LSTM å’Œ GRU ä¸”åŸç†åˆ†æ</title>
    <url>/2024/08/09/%5B%E5%AD%A6%E8%82%A5AI%5D%20%E6%89%8B%E5%86%99%20LSTM%20%E5%92%8C%20GRU%20%E4%B8%94%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯é—®é¢˜"><a href="#èƒŒæ™¯é—®é¢˜" class="headerlink" title="èƒŒæ™¯é—®é¢˜"></a>èƒŒæ™¯é—®é¢˜</h2><p><code>RNN</code> æ˜¯è§£å†³æ—¶é—´åºåˆ—æ•°æ®çš„æ¨¡å‹ã€‚ä½†æ˜¯ä»–æ— æ³•è§£å†³æ—¶é—´æ­¥è¿‡é•¿è€Œæ— æ³•è®°ä½é•¿æœŸä¿¡æ¯çš„è¿™ä¸ªé—®é¢˜ã€‚ä»è€Œè¯ç”Ÿäº†å¾ˆå¤š <code>RNN</code> çš„å˜ç§æ¨¡å‹æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚æˆ‘ä»¬ä»Šå¤©æ¥çœ‹ä¸‹ä»–ä»¬çš„åŸç†å’Œæ‰‹å†™ä»–ä»¬çš„å®ç°ã€‚</p>
<h2 id="å¤æ‚-RNN"><a href="#å¤æ‚-RNN" class="headerlink" title="å¤æ‚ RNN"></a>å¤æ‚ RNN</h2><p>å¸¸è§„çš„ <code>RNN</code> çš„é€»è¾‘å›¾å¦‚ä¸‹ï¼š<br><img src="https://qiniu.oldzhangtech.com/mdpic/95f069d6-06bc-4df6-bbc8-89dc1ab54513_145485d3-8e45-4726-b6e8-fcf46df277fa.jpeg"></p>
<p>ä»£ç å¦‚ä¸‹ï¼š<br>$h_{t} &#x3D; f(h_{t-1},x_t)$<br>$o_t &#x3D; g(h_t)$ </p>
<p>ä¸ºäº†è§£å†³ ä¼ ç»Ÿ <code>RNN</code> çš„é—®é¢˜ï¼Œå°±æœ‰äº†ä»¥ä¸‹çš„æ€è·¯ï¼š  </p>
<ol>
<li>åœ¨ä¸åŒçš„è½¬æ¢è¿‡ç¨‹ï¼ˆæ¯ä¸ªè¿çº¿ï¼‰ä¸­å¢åŠ å¤š ä¸€äº›è½»é‡çº§çš„è½¬æ¢ï¼Œå¢åŠ è®°å¿†åº¦</li>
<li>åŠ ä¸Šæ®‹å·®å±‚</li>
<li>å¢åŠ å¤šæ›´å¤šçš„è¾“å‡ºå±‚ï¼Œå…ˆæŠ½å–ä½ç»´ç‰¹å¾ï¼Œå†æŠ½å–é«˜ç»´ç‰¹å¾çš„æ–¹æ³•</li>
</ol>
<p>å„ç§çš„å˜ä½“çš„ <code>RNN</code> çš„æ¶æ„å›¾å¦‚ä¸‹ï¼š<br><img src="https://qiniu.oldzhangtech.com/mdpic/e58e3b3d-03da-4c17-bd57-fdde80d71a73_184ba76b-3fd9-45d1-b587-d4dd986b95fc.jpeg"></p>
<p>å…¶ä¸­æœ€ä¼˜ç§€çš„ä¸¤ç§å˜ä½“æ¨¡å‹å°±æ˜¯ <code>LSTM</code> å’Œ <code>GRU</code> çš„æ¨¡å‹ã€‚ä¸‹é¢åˆ†åˆ«å¯¹ä¸‹é¢çš„æ¨¡å‹è¿›è¡Œä»‹ç»ã€‚</p>
<h2 id="LSTM"><a href="#LSTM" class="headerlink" title="LSTM"></a>LSTM</h2><p><code>LSTM</code>ï¼ˆLong Short-Term Memoryï¼‰å…¨ç§° é•¿çŸ­æœŸè®°å¿†ã€‚ç®€å•çš„è¯´ï¼Œå°±æ˜¯è®°å¿†åˆ†é•¿æœŸå’ŒçŸ­æœŸçš„ã€‚é•¿æœŸçš„è®°å¿†ï¼Œå¯ä»¥é•¿æ—¶é—´å­˜æ´»ï¼›åŒç†ï¼ŒçŸ­æœŸè®°å¿†ç”Ÿå­˜æ—¶é—´å°±æ¯”è¾ƒçŸ­ã€‚</p>
<p>ğŸ”¥ <code>RNN</code> è®°å¿†æ˜¯å­˜åœ¨æ¯ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€ä¸­çš„ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œä¼šâ€œé—å¿˜â€æ—¶é—´é•¿çš„éšçŠ¶æ€ï¼Œå³æƒé‡é€æ­¥å‡å°‘ï¼› <code>LSTM</code> å°±æ˜¯ é’ˆå¯¹é‡è¦çš„è®°å¿†ï¼Œæ‹¿ä¸ªè®°äº‹æœ¬è®°ä½ï¼Œè®©ä»–ä¸ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå¿˜è®°äº†ã€‚</p>
<p><code>LSTM</code> ä¸äººç±»çš„æ—¥è®°ä¹ æƒ¯ä¸€è‡´ï¼Œæ¯å¤©è®°å½•åˆ°æ—¥è®°çš„äº‹æƒ…éƒ½æ˜¯é‡è¦çš„äº‹æƒ…ï¼Œä½†æ˜¯ä¸ä¼š 24 å°æ—¶æ¯åˆ†æ¯ç§’çš„äº‹æƒ…éƒ½è®°ä½ã€‚æŸå¹´æŸæœˆæŸæ—¥ä¸­äº†åŒè‰²çƒå¤´å¥–ï¼ˆé•¿æœŸè®°å¿†ï¼‰ï¼Œéƒ½ä¼šè®°å½•ä¸‹æ¥ï¼Œå¤šå¹´åå†ç¿»çœ‹ï¼Œéƒ½ä¼šè®°å¿†çŠ¹æ–°ï¼›åŒæ—¶ï¼Œ489 å¤©å‰çš„æ™šé¥­åƒäº†ä»€ä¹ˆï¼ˆçŸ­æœŸè®°å¿†ï¼‰ï¼Œå¤§ä½“ä¸ä¼šå‡ºç°åœ¨ä½ æ—¥è®°æœ¬å†…ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šåœ¨ä½ çš„è„‘æµ·å†…ã€‚</p>
<blockquote>
<p>è®°ä½äº†åŸç†å°±å¯ä»¥ï¼Œä¸éœ€è¦è¿‡å¤šçš„ç»†èŠ‚</p>
</blockquote>
<h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p><em>åŸç†å›¾</em><br><img src="https://qiniu.oldzhangtech.com/mdpic/6cf90fbb-3bef-4376-afa2-49b857b98e89_9a2d9ced-e5a5-4497-95db-0418b57fc8da.jpeg"><br>å¯¹æ¯” <code>RNN</code>ï¼Œ<code>LSTM</code> å°±å¯ä»¥å¯¹æŸäº›è®°å¿†è®¤ä¸ºæ˜¯é•¿æœŸçš„ä¸”é‡è¦çš„ï¼Œè¿›è¡ŒåŠ æƒï¼Œè®©ä»–çš„æƒé‡ä¸å‡å¼±ã€‚</p>
<p><em>é€»è¾‘è¯´æ˜</em><br>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µï¼š<code>Cell è®°å¿†</code> ä»–æ˜¯åŒ…å«åœ¨ <code>LSTMCell</code> é‡Œé¢ä¸€ä¸ªå†…ç½®çš„è®°å¿†ä½“ï¼Œä»–å°±æ˜¯ç”¨äºè®°ä½å“ªäº› <code>Long Term Memory</code>ã€‚ </p>
<p><code>LSTMCell</code>  å°±æ˜¯ <code>LSTMModel</code> çš„åŸºç¡€çš„ç»„ä»¶ï¼Œä¸‹å›¾å°±æ˜¯ <code>LSTMCell</code> çš„åŸç†å›¾ã€‚æ•´ä¸ª <code>Cell</code>  æœ‰ 3 ä¸ªé—¨æ¥æ§åˆ¶è®°å¿†ï¼ŒåŒ…æ‹¬äº† é—å¿˜é—¨&#x2F;è¾“å…¥é—¨&#x2F;è¾“å‡ºé—¨ï¼Œç”±ä»–ä»¬æ¥æ§åˆ¶ è¾“å…¥&#x2F;è¾“å‡º&#x2F;éšçŠ¶æ€&#x2F;è®°å¿† ä¹‹é—´çš„å…³ç³»ã€‚<br><img src="https://qiniu.oldzhangtech.com/mdpic/bdf5c0f7-e18f-401e-b7b5-c43ddab01baf_dbd5558a-4c81-447c-8bb6-a83b18f14a7c.png" alt="image.png"></p>
<blockquote>
<p>æˆ‘ä»¬ç›´æ¥ dive deep into codeï¼Œå¯¹ç…§è¿™ä¸ªåŸç†å›¾ï¼Œä¼šæ›´åŠ å®¹æ˜“ç†è§£ã€‚</p>
</blockquote>
<h3 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h3><p>ä¸‹é¢æ˜¯èŠ‚é€‰<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/lstm.ipynb">ä¾‹å­</a>ä¸­çš„ <strong>æ‰‹å†™LSTM</strong> çš„ <code>LSTM Cell</code> ä»£ç ç‰‡æ®µã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LSTMCell</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_size, hidden_size</span>):</span><br><span class="line">        <span class="built_in">super</span>(LSTMCell, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = hidden_size</span><br><span class="line">        <span class="comment"># è¾“å…¥é—¨</span></span><br><span class="line">        <span class="variable language_">self</span>.input_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="comment"># é—å¿˜é—¨</span></span><br><span class="line">        <span class="variable language_">self</span>.forget_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="comment"># è¾“å‡ºé—¨</span></span><br><span class="line">        <span class="variable language_">self</span>.output_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="comment"># æœ¬ Cell çš„è®°å¿†é—¨</span></span><br><span class="line">        <span class="variable language_">self</span>.cell_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, interState</span>):</span><br><span class="line">        h_prev, c_prev = interState</span><br><span class="line"></span><br><span class="line">        combined = torch.cat((x, h_prev), dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        i_t = torch.sigmoid(<span class="variable language_">self</span>.input_gate(combined))</span><br><span class="line">        f_t = torch.sigmoid(<span class="variable language_">self</span>.forget_gate(combined))</span><br><span class="line">        o_t = torch.sigmoid(<span class="variable language_">self</span>.output_gate(combined))</span><br><span class="line">        c_tilde = torch.tanh(<span class="variable language_">self</span>.cell_gate(combined))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¸»è¦é€»è¾‘ï¼Œä¸‹é¢ä¸¤è¡Œ</span></span><br><span class="line">        c_t = f_t * c_prev + i_t * c_tilde</span><br><span class="line">        h_t = o_t * torch.tanh(c_t)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> h_t, (h_t, c_t)</span><br></pre></td></tr></table></figure>
<p>è¯·ç»“åˆæ³¨é‡Šå’ŒåŸç†å›¾ï¼Œè¿›è¡Œé˜…è¯»</p>
<p><em>æ€»ç»“</em>   </p>
<ol>
<li>ä¸Šè¿°é€»è¾‘ éƒ½æ˜¯ç®€å•çš„ <strong>å…¨é“¾æ¥</strong> å’Œ <strong>æ¿€æ´»å‡½æ•°</strong> æ„æˆï¼Œæ‰€ä»¥ç†è§£åŸç†æ˜¯æœ€é‡è¦çš„ï¼Œå†…éƒ¨éƒ½æ˜¯ç»„è£…è€Œå·²</li>
<li>å› ä¸ºæ˜¯æ‰‹å†™ <code>LSTMCell</code>ï¼Œç®€åŒ–äº†é€»è¾‘ï¼Œä»…ä»…æ˜¯é’ˆå¯¹ å•ä¸ªæ•°æ® + è®°å¿† å¤„ç†ï¼›sequence çš„æ•°æ® å°±æ˜¯åœ¨è®­ç»ƒçš„æ—¶å€™ï¼Œè¿›è¡Œå¾ªç¯ï¼›batch çš„æ¦‚å¿µï¼Œå½“ç„¶ä¹Ÿæ˜¯æ²¡æœ‰çš„ã€‚<blockquote>
<p>âš ï¸ è¿™é‡Œå½±å“åˆ°äº† 1. X, y çš„æ•°æ®ç»“æ„ï¼› 2. æ¨¡å‹å†…çš„ forward çš„å¤„ç†æ–¹æ³•ï¼›3. train çš„æ–¹æ³•ã€‚å¯ä»¥å¯¹æ¯”æ–‡ä»¶åé¢çš„  nn.LSTM çš„è§£å†³æ–¹æ³•ï¼Œæ¥ä¸€èµ·æœç”¨ã€‚<br>æœ€å¥½çš„æ–¹å¼å½“ç„¶æ˜¯æŠŠ æ‰‹å†™ LSTMCell æ”¹å†™æˆ (batch, sequence, input_feature) X æ•°æ®ç»“æ„ éƒ½é€‚ç”¨çš„ä»£ç ã€‚</p>
</blockquote>
</li>
</ol>
<h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>ä¾‹å­ç›®æ ‡ï¼š è¾“å…¥ 5 ä¸ªæ•°å­—ï¼Œå¯ä»¥é¢„æµ‹ä¸‹ä¸€ä¸ªæ•°æ®æ˜¯å¤šå°‘ã€‚</p>
<p><em>åˆ†æè¿‡ç¨‹</em>  </p>
<ol>
<li>æ˜¯ å›å½’é—®é¢˜</li>
<li>â€œ5 ä¸ªæ•°å­—â€ æ˜¯ä¸€ä¸ªæœ‰è¿ç»­å…ˆåå…³ç³»çš„è¾“å…¥ï¼Œæ‰€ä»¥ä½¿ç”¨ç±» RNN çš„æ¨¡å‹</li>
<li>å®šä¹‰ RNN çš„æ—¶å€™ input_feature å’Œ output_feature éƒ½æ˜¯ 1</li>
</ol>
<p>è¯¦ç»†çš„ä»£ç å¯ä»¥ç›´æ¥è®¿é—® ipynb æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/lstm.ipynb">é“¾æ¥</a>ã€‚é‡Œé¢æœ‰ æ‰‹åŠ¨LSTM å’Œ nn.LSTM ä¸¤ç§ä¸åŒçš„å®ç°æ–¹æ¡ˆã€‚</p>
<p><em>è®­ç»ƒåçš„ç»“æœ</em>   </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®­ç»ƒè¿‡ç¨‹</span></span><br><span class="line">epoch: <span class="number">400</span> loss: <span class="number">0.01360714</span></span><br><span class="line">epoch: <span class="number">450</span> loss: <span class="number">0.00120955</span></span><br><span class="line">epoch: <span class="number">499</span> loss: <span class="number">0.0031908983</span></span><br><span class="line"><span class="comment"># åœ¨ 500 åæ”¶æ•›</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥ 45,46,47,48,49,50</span></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">[<span class="number">49.966102600097656</span>, <span class="number">50.8197021484375</span>, <span class="number">51.54384231567383</span>, <span class="number">52.14518737792969</span>, <span class="number">52.62910842895508</span>]</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="GRU"><a href="#GRU" class="headerlink" title="GRU"></a>GRU</h2><p><code>GRU</code>ï¼ˆGated Recurrent Unitï¼‰å…¨ç§° é—¨æ§å¾ªç¯å•å…ƒï¼Œå°±æ˜¯ä½¿ç”¨ é€»è¾‘ç”µè·¯çš„æ€è·¯å»è§£å†³æ¨¡å‹çš„é—®é¢˜ã€‚</p>
<p>ä»–å’Œ <code>LSTM</code> ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸ºäº†è§£å†³ <code>RNN</code> çš„é•¿æœŸè®°å¿†çš„é—®é¢˜ã€‚åŒæ—¶æ¯” <code>LSTM</code> çš„ä¼˜åŠ¿æ˜¯ï¼Œä»…ä»…æ˜¯ç”¨äº†ä¸¤ä¸ªé—¨ â€“ é‡ç½®é—¨ å’Œ æ›´æ–°é—¨ã€‚é—¨çš„æ•°é‡çš„å‡å°‘ï¼Œè‡ªç„¶å‚æ•°é‡å¯ä»¥è¿›ä¸€æ­¥çš„å‡å°‘ã€‚</p>
<blockquote>
<p>è®°ä½äº†åŸç†å°±å¯ä»¥ï¼Œä¸éœ€è¦è¿‡å¤šçš„ç»†èŠ‚</p>
</blockquote>
<h3 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h3><p><em>åŸç†å›¾</em><br><img src="https://qiniu.oldzhangtech.com/mdpic/98cd28fc-f93a-49b2-873c-6a432f819079_fbdfb78f-be9e-4200-b583-2b2205b6bd64.png" alt="image.png"><br><code>GRUCell</code>  å°±æ˜¯ <code>GRUModel</code> çš„åŸºç¡€çš„ç»„ä»¶ï¼Œä¸Šå›¾å°±æ˜¯ <code>GRUCell</code> çš„åŸç†å›¾ã€‚æ•´ä¸ª <code>Cell</code>  æœ‰ 2 ä¸ªé—¨æ¥æ§åˆ¶è®°å¿†ï¼ŒåŒ…æ‹¬äº† é‡ç½®é—¨&#x2F;æ›´æ–°é—¨ï¼Œç”±ä»–ä»¬æ¥æ§åˆ¶ è¾“å…¥&#x2F;è¾“å‡º&#x2F;éšçŠ¶æ€ ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p>âš ï¸ æ³¨æ„ï¼Œä¸ <code>LSTM</code> å¯¹æ¯”ï¼Œ<code>GRU</code> æ²¡æœ‰ <strong>è®°å¿†</strong> çš„æ¦‚å¿µï¼Œä»–çš„æ‰€æœ‰çš„è®°å¿†éƒ½æ˜¯éšçŠ¶æ€ä¸­ï¼Œå¹¶ä¸”ä»–æ˜¯ä½¿ç”¨ <code>é—¨</code> æ¥æ›´æ–°&#x2F;é‡ç½® éšçŠ¶æ€ã€‚ </p>
<h3 id="ç»„ä»¶-1"><a href="#ç»„ä»¶-1" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h3><p>ä¸‹é¢æ˜¯èŠ‚é€‰<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/gru.ipynb">ä¾‹å­</a>ä¸­çš„ <strong>æ‰‹å†™GRU</strong> çš„ <code>GRUCell</code> ä»£ç ç‰‡æ®µã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GRUCell</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_size, hidden_size</span>):</span><br><span class="line">        <span class="built_in">super</span>(GRUCell, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = hidden_size</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.update_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="variable language_">self</span>.reset_gate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">        <span class="variable language_">self</span>.hidden_candidate = nn.Linear(input_size + hidden_size, hidden_size)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, hidden</span>):</span><br><span class="line">        <span class="comment"># print(f&quot;cell forward : &#123;x.shape&#125; &#123;hidden.shape&#125;&quot;)</span></span><br><span class="line">        <span class="comment"># cell forward : torch.Size([1]) torch.Size([50])</span></span><br><span class="line">        combined = torch.cat((x, hidden), dim=<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        update_gate = torch.sigmoid(<span class="variable language_">self</span>.update_gate(combined))</span><br><span class="line">        reset_gate = torch.sigmoid(<span class="variable language_">self</span>.reset_gate(combined))</span><br><span class="line">        <span class="comment"># process reset</span></span><br><span class="line">        combined_hidden = torch.cat((x, reset_gate * hidden), dim=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># activate after process reset</span></span><br><span class="line">        hidden_candidate = torch.tanh(<span class="variable language_">self</span>.hidden_candidate(combined_hidden))</span><br><span class="line">        <span class="comment"># process update</span></span><br><span class="line">        hidden = (<span class="number">1</span> - update_gate) * hidden + update_gate * hidden_candidate</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hidden</span><br></pre></td></tr></table></figure>
<p>è¯·ç»“åˆæ³¨é‡Šå’ŒåŸç†å›¾ï¼Œè¿›è¡Œé˜…è¯»ã€‚</p>
<p>ä¸ <code>LSTM</code> å¯¹æ¯”   </p>
<ol>
<li><strong>æ²¡æœ‰</strong>äº† <code>Cell</code> çš„è®°å¿†ï¼Œä»–æ˜¯ç›´æ¥ä¿®æ”¹äº† éšçŠ¶æ€ <code>hidden</code></li>
<li>åªæœ‰ä¸¤ä¸ªé—¨ï¼Œæ›´æ–°é—¨ å’Œ é‡ç½®é—¨ï¼Œç»“æ„æ›´åŠ çš„ç®€å•</li>
</ol>
<p><em>æ€»ç»“</em>   </p>
<ol>
<li>ä¸Šè¿°é€»è¾‘ éƒ½æ˜¯ç®€å•çš„ <strong>å…¨é“¾æ¥</strong> å’Œ <strong>æ¿€æ´»å‡½æ•°</strong> æ„æˆï¼Œæ‰€ä»¥ç†è§£åŸç†æ˜¯æœ€é‡è¦çš„ï¼Œå†…éƒ¨éƒ½æ˜¯ç»„è£…è€Œå·²</li>
<li>å› ä¸ºæ˜¯æ‰‹å†™ <code>GRUCell</code>ï¼Œç®€åŒ–äº†é€»è¾‘ï¼Œä»…ä»…æ˜¯é’ˆå¯¹ å•ä¸ªæ•°æ® + è®°å¿† å¤„ç†ï¼›sequence çš„æ•°æ® å°±æ˜¯åœ¨è®­ç»ƒçš„æ—¶å€™ï¼Œè¿›è¡Œå¾ªç¯ï¼›batch çš„æ¦‚å¿µï¼Œå½“ç„¶ä¹Ÿæ˜¯æ²¡æœ‰çš„ã€‚<blockquote>
<p>âš ï¸ è¿™é‡Œå½±å“åˆ°äº† 1. X, y çš„æ•°æ®ç»“æ„ï¼› 2. æ¨¡å‹å†…çš„ forward çš„å¤„ç†æ–¹æ³•ï¼›3. train çš„æ–¹æ³•ã€‚å¯ä»¥å¯¹æ¯”æ–‡ä»¶åé¢çš„  nn.GRU çš„è§£å†³æ–¹æ³•ï¼Œæ¥ä¸€èµ·æœç”¨ã€‚<br>æœ€å¥½çš„æ–¹å¼å½“ç„¶æ˜¯æŠŠ æ‰‹å†™ GRUCell æ”¹å†™æˆ (batch, sequence, input_feature) X æ•°æ®ç»“æ„ éƒ½é€‚ç”¨çš„ä»£ç ã€‚</p>
</blockquote>
</li>
</ol>
<h3 id="ä¾‹å­-1"><a href="#ä¾‹å­-1" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>ä¸ <code>LSTM</code> çš„ä¾‹å­çš„é¢˜ç›®æ˜¯ä¸€è‡´çš„ï¼Œåˆ†æçš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€è‡´ã€‚</p>
<p>è¯¦ç»†çš„ä»£ç å¯ä»¥ç›´æ¥è®¿é—® ipynb æ–‡ä»¶<a href="https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/gru.ipynb">é“¾æ¥</a>ã€‚é‡Œé¢æœ‰ æ‰‹åŠ¨GRU å’Œ nn.GRU ä¸¤ç§ä¸åŒçš„å®ç°æ–¹æ¡ˆã€‚</p>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li>æ— è®ºæ˜¯ <code>RNN</code> å’Œ <code>ç±»RNN</code> æ¨¡å‹ <code>LSTM</code>&#x2F;<code>GRU</code> éƒ½æ˜¯ <strong>è¾“å‡ºæ—¶é—´æ­¥çš„éšçŠ¶æ€</strong>ï¼Œè¿™æ˜¯ æ—¶åºåºåˆ—ç›¸å…³çš„æ¨¡å‹çš„å…³é”®</li>
<li><code>LSTM</code> å’Œ <code>GRU</code> ï¼Œå…·æœ‰æ¨¡å‹çš„å¯è§£é‡Šæ€§ï¼ŒåŒæ—¶ä»–æ˜¯è§£å†³å…¶ä»–é—®é¢˜çš„æ–¹å¼ç”¨åœ¨å®šä¹‰æ¨¡å‹ä¸Šï¼Œä½“ç°è·¨å­¦ç§‘å­¦ä¹ çš„é‡è¦æ€§</li>
<li><code>LSTM</code> å’Œ <code>GRU</code> åœ¨ä½¿ç”¨åœºæ™¯ä¸Šéƒ½å¯ä»¥äº¤æ›¿ä½¿ç”¨ï¼Œçœ‹å“ªä¸ªæ¯”è¾ƒé€‚åˆ</li>
</ol>
]]></content>
      <categories>
        <category>å­¦è‚¥AI</category>
      </categories>
      <tags>
        <tag>å­¦è‚¥AI</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>LSTM</tag>
        <tag>GRU</tag>
      </tags>
  </entry>
  <entry>
    <title>å¾®ä¿¡äº‘å¼€å‘åŠäº‘å‡½æ•°</title>
    <url>/2024/11/07/%5B%E5%AD%A6%E8%82%A5%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91%5D%20%E5%BE%AE%E4%BF%A1%E4%BA%91%E5%BC%80%E5%8F%91-%E4%BA%91%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h2 id="äº‘å¼€å‘æ˜¯ä»€ä¹ˆ"><a href="#äº‘å¼€å‘æ˜¯ä»€ä¹ˆ" class="headerlink" title="äº‘å¼€å‘æ˜¯ä»€ä¹ˆ"></a>äº‘å¼€å‘æ˜¯ä»€ä¹ˆ</h2><p>å¦‚æœå¾®ä¿¡å°ç¨‹åºæ˜¯å‰ç«¯ï¼Œé‚£ä¹ˆåç«¯å°±æ˜¯ æœåŠ¡å™¨&#x2F;åç«¯ä»£ç è¿è¡Œ&#x2F;äº‘å­˜å‚¨&#x2F;æ•°æ®åº“ç­‰ï¼Œå‰åç«¯é…åˆæ‰æ˜¯ä¸€ä¸ªå®Œæ•´çš„é¢å‘æœåŠ¡çš„ç¨‹åºã€‚</p>
<p>å‰åç«¯é…ç½®ï¼Œä¸Šè¿°æ˜¯æ­£å¸¸çš„å¼€å‘çš„ç»„åˆã€‚ä½†æ˜¯åç«¯æ¶‰åŠåˆ°å¾ˆå¤šç¹ççš„æ­¥éª¤ï¼Œæ¯”å¦‚ åŸŸåç”³è¯·&#x2F;åŸŸåè§£æ&#x2F;åç«¯ä»£ç éƒ¨ç½²â€¦ä¸€ç³»åˆ—çš„é—®é¢˜ã€‚ç­‰è§£å†³å¥½è¿™äº›é—®é¢˜ï¼Œæ—¶é—´éƒ½è€—è´¹äº†åŠå¤©äº†ã€‚</p>
<p>å¾®ä¿¡äº‘å¼€å‘ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°çš„é—®é¢˜ã€‚åœ¨ <strong>å¾®ä¿¡å¼€å‘è€…å·¥å…·</strong> ä¸­å°±å¯ä»¥ä¸€é”®å¼€å‘ <strong>æ•°æ®åº“&#x2F;äº‘å‡½æ•°&#x2F;äº‘å­˜å‚¨</strong>ï¼Œæ–¹ä¾¿çµæ´»ã€‚</p>
<p>ç›¸åº”çš„ç½‘ç«™è¯´æ˜ï¼š <a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloudservice/wxcloud/guide/init.html">äº‘å¼€å‘ </a>ã€‚ä¸‹é¢å°±ç€ äº‘å‡½æ•°ï¼Œè¯´æ˜ä¸€ä¸‹ã€‚</p>
<h2 id="äº‘å‡½æ•°-hello-world"><a href="#äº‘å‡½æ•°-hello-world" class="headerlink" title="äº‘å‡½æ•° hello world"></a>äº‘å‡½æ•° hello world</h2><ol>
<li>æ–°å»ºä¸€ä¸ª <strong>äº‘ç¯å¢ƒ</strong>ï¼Œæ‰“å¼€ _å¾®ä¿¡å¼€å‘è€…å·¥å…·_ï¼Œç‚¹å‡» <em>äº‘å¼€å‘</em> æŒ‰é’®ã€‚</li>
</ol>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/a3303d65-ae28-4a4a-b024-d00ad6ff4095_ff179b1c-7af2-4c3e-90a7-90529e880779.png"></p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/55118c6e-7dd0-4378-aaad-398c8fa4f6f9_d3cdcadd-4568-4b51-81ad-2d66fe249616.png"></p>
<p>çº¢è‰²ç®­å¤´æ˜¯ <code>envId</code>ï¼Œåç»­åœ¨ä»£ç ä¸­ç”¨ä¸Šã€‚æš‚æ—¶å…ˆå»ºç«‹ä¸€ä¸ªç¯å¢ƒ <code>test</code>ã€‚</p>
<blockquote>
<p>â“ç¯å¢ƒæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>å°±æ˜¯ç”¨æ¥éš”ç¦»ä¸åŒ äº‘å‡½æ•°&#x2F;æ•°æ®åº“&#x2F;äº‘å­˜å‚¨çš„ ç©ºé—´ã€‚å¯ä»¥æƒ³è±¡ï¼Œä¸åŒçš„ç¯å¢ƒï¼Œå°±ç­‰äºä¸åŒçš„æˆ¿å­ï¼›ä¸åŒçš„æˆ¿å­é‡Œé¢è™½ç„¶éƒ½æœ‰ æ¡Œå­æ¤…å­ï¼Œä½†æ˜¯ä»–ä»¬éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚</p>
</blockquote>
<ol start="2">
<li>æ–°å»ºç›®å½•ï¼Œ<code>cloudfunctions</code> ï¼Œæ˜¯äº‘å‡½æ•°çš„ä¿å­˜ç›®å½•ã€‚åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰¾åˆ° <code>project.config.json</code> æ–‡ä»¶ï¼Œæ–°å¢ <code>cloudfunctionRoot</code> å­—æ®µï¼Œ<code>value</code> å°±æ˜¯ <code>cloudfunctions</code>ã€‚</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;cloudfunctionRoot&quot;</span>: <span class="string">&quot;cloudfunctions/&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ <strong>æ–°å»ºçš„ç›®å½•</strong> ä¸Šè¦é€‰æ‹©ä½ è¦åœ¨ <code>å“ªä¸ªç¯å¢ƒ</code> ä¸­è¿›è¡Œå¼€å‘äº‘å‡½æ•°ï¼Œæ¯”å¦‚ä¸‹å›¾ï¼Œé€‰æ‹©äº† æ–°å»ºçš„ <code>test</code> ç¯å¢ƒã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/5bed85c0-d45a-4bc6-84b7-4b3601f05b1d_678f3efa-eef6-4d5d-94a6-f9f2acf75f09.png"></p>
<ol start="3">
<li>åˆ›å»ºäº‘å‡½æ•°ï¼Œåœ¨ <code>cloudfunctions</code> ç›®å½• å³é”®ï¼Œç‚¹å‡» ã€æ–°å»º node.js äº‘å‡½æ•°ã€‘ï¼Œåå­—å« <code>add</code>ã€‚</li>
</ol>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/1e29e888-7ffc-4c8e-ad45-9211e11c3688_6c840fc5-13f7-4e5e-b1c0-257e5525e4c3.png"></p>
<p>add ç›®å½•ä¸‹ å¢åŠ å¤š 3 ä¸ªæ–‡ä»¶</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/b062fd6a-be83-4b1f-adaa-abc4b1c445aa_55aae544-8c59-4f95-8fee-fa139fc5b325.png"></p>
<ol start="4">
<li>ä¿®æ”¹ <code>add/index.js</code> ï¼Œå…¨æ–‡æ›¿æ¢æˆä¸‹é¢çš„ä»£ç ã€‚</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// äº‘å‡½æ•°å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">main</span> = <span class="title function_">async</span> (event, context) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">sum</span>: event.<span class="property">a</span> + event.<span class="property">b</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="5">
<li>ä¿®æ”¹ <code>package.json</code>ï¼Œ åˆ é™¤ <code>dependencies</code> é‡Œé¢çš„å€¼ï¼Œç±»ä¼¼çš„ä»£ç å¦‚ä¸‹</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<ol start="6">
<li>ä¸Šä¼ å‡½æ•°ï¼Œå˜æˆ <code>äº‘</code></li>
</ol>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/8677fd70-f4e7-48dc-8151-500ce61fc6c5_2e030105-4f2e-4076-9e42-aa5d749a7d49.png"></p>
<blockquote>
<p>å¦‚æœï¼Œæœ‰ä»¥ä¸‹çš„æƒ…å†µ</p>
<ol>
<li><code>index.js</code> ä¸­ <strong>æ²¡æœ‰</strong> <code>const cloud = require(&#39;wx-server-sdk&#39;)</code> ä»£ç </li>
<li><code>package.json</code> çš„ <code>dependencies</code> å­—æ®µ æ²¡æœ‰å€¼</li>
</ol>
<p>å°±å¯ä»¥  ç‚¹å‡»ã€ä¸Šä¼ å¹¶éƒ¨ç½²: æ‰€æœ‰æ–‡ä»¶ã€‘èœå•ï¼Œæ¯”å¦‚ æœ¬ä¾‹ã€‚</p>
<p>å¦‚æœæœ‰ä¸Šè¿°çš„æƒ…å†µï¼Œå°±å¯ä»¥  ç‚¹å‡»ã€ä¸Šä¼ å¹¶éƒ¨ç½²: äº‘ç«¯å®‰è£…ä¾èµ–ã€‘èœå•ã€‚</p>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/beccdf18-d285-4e40-a6f3-1ab02736ce83_c349e39c-ec34-4d3a-9292-92cbc54a50e9.png"></p>
</blockquote>
<blockquote>
<p>ğŸ’¡ â€˜wx-server-sdkâ€™ çš„å®‰è£…ï¼Œæ˜¯ä¸ºäº† äº‘å‡½æ•°ä¸­å¯ä»¥ è°ƒç”¨ <strong>æ•°æ®åº“</strong> å’Œ <strong>äº‘å­˜å‚¨</strong>ã€‚å¦‚æœä½ åœ¨å¾®ä¿¡å°ç¨‹åºä¸­æ˜¯ç›´æ¥ è°ƒç”¨ æ•°æ®åº“ å’Œ äº‘å­˜å‚¨ï¼Œå°±æ²¡æœ‰å¿…è¦åœ¨ äº‘å‡½æ•° ä¸­å€’ä¸€å€’äº†ã€‚</p>
</blockquote>
<ol start="7">
<li>è°ƒè¯•äº‘å‡½æ•°ï¼Œåœ¨ <strong>å¼€å‘è€…å·¥å…·</strong> å°±å¯ä»¥è°ƒè¯•åˆšåˆšä¸Šä¼ çš„äº‘å‡½æ•°</li>
</ol>
<p><img src="https://qiniu.oldzhangtech.com/mdpic/1ae346b2-e450-4d10-b42a-c05843452c69_385b46fd-7871-4826-8fb7-348178fcd442.png"></p>
<ol start="8">
<li>å°ç¨‹åºä¸­è°ƒç”¨ äº‘å‡½æ•° add</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">wx.<span class="property">cloud</span>.<span class="title function_">init</span>(&#123;</span><br><span class="line">      <span class="attr">env</span>: <span class="string">&#x27;test-safjlfjasdfasf&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">wx.<span class="property">cloud</span>.<span class="title function_">callFunction</span>(&#123;</span><br><span class="line">      <span class="comment">// äº‘å‡½æ•°åç§°</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">      <span class="comment">// ä¼ ç»™äº‘å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">b</span>: <span class="number">2</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">result</span>.<span class="property">sum</span>) <span class="comment">// 3</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">fail</span>: <span class="variable language_">console</span>.<span class="property">error</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>



<ol start="9">
<li>æ’’èŠ±</li>
</ol>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><em>å¾®ä¿¡äº‘å¼€å‘</em> å¼€å‘ _äº‘å‡½æ•°_ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå·¥å…·é‡Œé¢åŒæ—¶å¼€å‘å‰ç«¯å’Œåç«¯çš„ä»£ç ï¼Œå‡å°‘ç¹ççš„æ­¥éª¤ï¼ŒåŠ å¿«å¼€å‘çš„æ•ˆç‡ã€‚</p>
]]></content>
      <categories>
        <category>å¾®ä¿¡äº‘å¼€å‘</category>
      </categories>
      <tags>
        <tag>å¾®ä¿¡</tag>
        <tag>å¾®ä¿¡äº‘å¼€å‘</tag>
        <tag>äº‘å¼€å‘</tag>
        <tag>äº‘å‡½æ•°</tag>
        <tag>äº‘æ•°æ®åº“</tag>
        <tag>äº‘å­˜å‚¨</tag>
      </tags>
  </entry>
</search>
