---
title: æ‰‹å†™ Attention æ³¨æ„åŠ›æœºåˆ¶ åŠç†è§£
date: 2024-08-16 10:18:38
tags: 
    - å­¦è‚¥AI
    - Attention
    - æ·±åº¦å­¦ä¹ 
categories: å­¦è‚¥AI
description: "`RNN` å’Œ å„ç§å˜ä½“ `RNN` ä¸­ `LSTM`/`GRU` éƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•è§£å†³ é•¿è·ç¦»ä¿¡æ¯çš„æ„ŸçŸ¥ã€‚`RNN` çš„è§£å†³åŠæ³•æ˜¯åŠ å¤§ `sequence`ï¼Œæ›´é•¿çš„çª—å£è®°å¾—æ›´åŠ ä¹…è¿œçš„ä¿¡æ¯ï¼›`LSTM` å’Œ `GRU` å°±æ˜¯æŠŠè®°å¿†è®¾ç½®æˆä¸åŒçš„æƒé‡ï¼Œå¯¹é‡è¦çš„ä¿¡æ¯åŠ å¤§æƒé‡ã€‚`Attention` åˆæ˜¯å¦å¤–ä¸€ä¸ªè§’åº¦ï¼Œå»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚"
cover: https://qiniu.oldzhangtech.com/cover/%E5%A4%A7%E8%B0%B7%E7%BF%94%E5%B9%B3.jpg
---


## èƒŒæ™¯é—®é¢˜
`RNN` å’Œ å„ç§å˜ä½“ `RNN` ä¸­ `LSTM`/`GRU` éƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•è§£å†³ é•¿è·ç¦»ä¿¡æ¯çš„æ„ŸçŸ¥ã€‚`RNN` çš„è§£å†³åŠæ³•æ˜¯åŠ å¤§ `sequence`ï¼Œæ›´é•¿çš„çª—å£è®°å¾—æ›´åŠ ä¹…è¿œçš„ä¿¡æ¯ï¼›`LSTM` å’Œ `GRU` å°±æ˜¯æŠŠè®°å¿†è®¾ç½®æˆä¸åŒçš„æƒé‡ï¼Œå¯¹é‡è¦çš„ä¿¡æ¯åŠ å¤§æƒé‡ã€‚`Attention` åˆæ˜¯å¦å¤–ä¸€ä¸ªè§’åº¦ï¼Œå»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## Attention æ˜¯ä»€ä¹ˆ
`Attention` ä¸­æ–‡æ˜¯æ³¨æ„åŠ›æœºåˆ¶ï¼Œæ˜¯å¯¹æŸä¸ªäº‹ç‰©çš„æŸéƒ¨åˆ†çš„å…³æ³¨ç‚¹ã€‚

ä»äººè„‘çš„è§’åº¦æƒ³ï¼Œæ—¶é—´å’Œèµ„æºéƒ½æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥åªèƒ½åœ¨ä¸€å®šçš„é™åº¦å†…å»å…³æ³¨æŸäº›éƒ¨åˆ†ã€‚æ¯”å¦‚çœ‹åˆ°ä¸€ç¾¤äººçš„ç…§ç‰‡ï¼Œæˆ‘ä»¬è‡ªç„¶å»æ‰¾ç¾å¥³ï¼›çœ‹ä¸€ä¸ªç¾å¥³çš„ç…§ç‰‡ï¼Œæˆ‘ä»¬è‡ªç„¶å»çœ‹ç¾å¥³çš„çœ¼ç›ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆä¼šä¸è‡ªä¸»çš„å»çœ‹è¿™äº›éƒ¨åˆ†è€Œä¸æ˜¯çœ‹å…¨æ™¯å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çš„æ³¨æ„åŠ›èµ„æºæ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬åªå¯¹å…³æ³¨ç‚¹é«˜çš„éƒ¨åˆ†æ„Ÿå…´è¶£ã€‚
è¿™æ˜¯å±äºåœ¨æˆ‘ä»¬äººè„‘é‡Œé¢çš„æ³¨æ„åŠ›æœºåˆ¶ã€‚
ä»æ¨¡å‹çš„è§’åº¦æƒ³ï¼Œç”¨æ•°å­¦å°†ä»–ä»¬å»ºæ¨¡ï¼Œä»–ä»¬åº”è¯¥æ˜¯æ³¨æ„åŠ›å¾—åˆ†æœ€é«˜çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æ¨¡å‹å¯ä»¥é‡ç‚¹å…³æ³¨çš„åœ°æ–¹ã€‚

æ€»ç»“ï¼Œä¸Šè¿°å°±æ˜¯ `Attention Score` çš„åŸºæœ¬çš„ç†è§£ã€‚è°å¾—åˆ†é«˜ï¼Œè°å°±å¯ä»¥å¾—åˆ°æ›´åŠ å¤šçš„å…³æ³¨ã€‚

ä¸‹é¢æŠŠ `Attention Score` ç”¨åœ¨ä¸€æ®µè¯çš„ç†è§£ä¸Šã€‚

æˆ‘ä»¬ä½¿ç”¨ä¸€å¥è¯ä½œä¸ºä¾‹å­ï¼šå§šæ˜ï¼Œä»–çˆ¸æœ‰ 2 ç±³é«˜ï¼Œä»–ä»å°çš„æ•°å­¦æˆç»©å¹¶ä¸å¥½ï¼Œç»å¸¸æ—·è¯¾ï¼Œä»–çˆ±åƒè‹¹æœï¼Œä»–è¡€å‹æ˜¯ Aã€‚çˆ±ç©æ¸¸æˆï¼Œä»–æœ€å–œæ¬¢çš„æ¸¸æˆå°±æ˜¯å¡å°”è¾¾ä¼ è¯´ï¼Œä»–è¿˜ç»å¸¸é€ƒè¯¾å»ç©ï¼›æœ‰æ—¶å€™ä»–ä¼šæ‰“ä¸€ä¸‹ç¯®çƒå’Œå…µä¹“çƒï¼Œä»–æœ€å–œæ¬¢çš„è¿åŠ¨æ˜¯è·‘æ­¥ã€‚ä»–ç°åœ¨èº«é«˜æ˜¯ 2.13 ç±³ï¼Œä½“é‡æ˜¯ 200 æ–¤ï¼Œé‹å­è¦ç©¿ 48 ç çš„ã€‚
è¯·é—®ï¼šä»–ä¸ºä»€ä¹ˆå¯ä»¥é•¿è¿™ä¹ˆé«˜ã€‚

ä»äººè„‘çš„è§’åº¦ï¼Œâ€œå§šæ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜â€ï¼Œå¾ˆè‡ªç„¶çš„æƒ³åˆ°ï¼Œä»–çˆ¶æ¯é«˜ï¼ŒåŸºå› å¥½ã€‚ä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªåˆ¤æ–­ï¼Œæ˜¯å› ä¸ºé—®é¢˜ï¼Œå’Œ â€œçˆ¶æ¯é«˜â€è¿™ä¸ªä¿¡æ¯æ˜¯ **å…³è”åº¦æœ€é«˜**çš„ã€‚
ä»æ¨¡å‹çš„è§’åº¦æƒ³ï¼Œç”¨æ•°å­¦å°†ä»–ä»¬å»ºæ¨¡ï¼Œå³ _é—®é¢˜_ å’Œ _ä¿¡æ¯çš„æŸä¸ªéƒ¨åˆ†_ ï¼Œè®¡ç®—çš„`Score` å¾—åˆ†æœ€é«˜ï¼Œæ‰€ä»¥ä»–ä»¬çš„å…³è”åº¦æœ€é«˜ï¼Œå³ä»–ä»¬å…·æœ‰é€»è¾‘ç›¸å…³æ€§ã€‚

æ€»ç»“ï¼Œ`Attention æœºåˆ¶` åœ¨è‡ªç„¶è¯­è¨€ç†è§£ä¸Šï¼Œå³ç›¸äº’çš„ `Score` è¶Šé«˜åˆ†ï¼Œå³ç›¸äº’çš„å…³è”æ€§å°±è¶Šå¤§ï¼Œå³ä»–ä»¬å…·æœ‰é€»è¾‘æ€§ã€‚

> é¢˜å¤–è¯ï¼š è¿™ä¸ªæœ‰ç‚¹åƒ **é€»è¾‘**ã€‚
> æˆ‘ä»¬å¤§è„‘æ˜¯ç¥ç»å…ƒæ„æˆçš„ã€‚ç¥ç»å…ƒï¼Œå³æ˜¯ ç»™ä¸€ä¸ªé«˜ç”µå¹³å°±æ˜¯ 1 ï¼Œç»™ä¸€ä¸ªä½ç”µå¹³å°±æ˜¯ 0 çš„è§¦è§’ï¼›è¿™ä¸ªè§¦è§’ï¼Œåˆå¯ä»¥è§¦å‘å¦å¤–çš„ç¥ç»å…ƒã€‚è¿™ç§å°±æ˜¯ â€œä¸€ç”ŸäºŒï¼ŒäºŒç”Ÿä¸‰ï¼Œä¸‰ç”Ÿä¸‡ç‰©â€çš„ä½“ç°ã€‚å› ä¸ºè¿™ç§è§¦è§’çš„è§¦å‘ï¼Œå°±åœ¨æˆ‘ä»¬çš„å¤§è„‘é‡Œé¢å½¢æˆäº† **é€»è¾‘**ã€‚
> `Attention Score`ï¼Œæœ‰å¯èƒ½æ„æˆäº†æ¨¡å‹é¢†åŸŸä¸­çš„ _åŸºç¡€è§¦è§’_ï¼Œæœ€åå½¢æˆäº†æ¨¡å‹é¢†åŸŸä¸­ **é€»è¾‘**ã€‚

## åˆ†æ¦‚å¿µè®²è§£
ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥ç®€å•çš„æ¢³ç†å‡º `Attention æœºåˆ¶`ã€‚ä½†æ˜¯è½åˆ°ç»†èŠ‚é‡Œé¢ï¼Œ`Attention Score` æ€ä¹ˆè®¡ç®—ï¼Œå°±æ˜¯ä»å®é™…çš„æ•°å­¦æ¨¡å‹çš„è§’åº¦å»è¯´æ˜äº†ã€‚ä¸‹é¢å°± `Attention Score` æ€ä¹ˆå»è®¡ç®—ä¸ºçº¿å¤´ï¼Œæ¥è®²è§£ä¸åŒæ¦‚å¿µã€‚
> ä¸‹é¢æ˜¯ä¸€æ­¥ä¸€æ­¥çš„è¯´æ˜ Attention æœºåˆ¶ çš„å„ç§ç»„ä»¶ï¼Œå’Œä»–ä»¬èƒ½å¤Ÿè§£å†³åˆ°ä»€ä¹ˆé—®é¢˜ã€‚

### QKV æœºåˆ¶
> Query Key Value

å¦‚æœå¯¹ä¸Šè¿°çš„é‚£å¥è¯åˆ†æˆä¸åŒçš„ç‰‡æ®µï¼šâ€œä»–çˆ¸æœ‰ 2 ç±³é«˜â€ seg1ï¼Œâ€œä»–ä»å°çš„æ•°å­¦æˆç»©å¹¶ä¸å¥½â€ seg2ï¼Œâ€œç»å¸¸æ—·è¯¾â€ seg3ï¼Œâ€œä»–çˆ±åƒè‹¹æœâ€ seg4ï¼Œâ€œä»–è¡€å‹æ˜¯ Aâ€ seg5ï¼Œæ¯ä¸ªç‰‡æ®µéƒ½æºå¸¦äº†ä¸€å®šé‡çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç»Ÿç§°ä»–ä»¬æºå¸¦çš„ä¿¡æ¯æ˜¯ **éšçŠ¶æ€** **hidden**ã€‚å¯¹åº”ç€ï¼Œç‰‡æ®µçš„éšçŠ¶æ€å°±æ˜¯ h1, h2...h5ã€‚

é¢å¯¹ â€œå§šæ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜â€ é—®é¢˜çš„æ—¶å€™ï¼Œè‡ªç„¶çš„å°±è®¤ä¸º `seg1` çš„å…³è”æ€§æ˜¯æœ€é«˜çš„ã€‚ä½†æ˜¯å¦‚æœé¢å¯¹ â€œä»–ä¸‰è§’å‡½æ•°ä¸æ‡‚â€é—®é¢˜çš„æ—¶å€™ï¼Œæ˜¾ç„¶æ˜¯ `seg2` çš„å…³è”æ€§æ˜¯æœ€é«˜çš„ã€‚
æ‰€ä»¥çš„å‡ºï¼Œ åŒä¸€ä¸ª`query` å¯¹åº”ä¸åŒçš„ `segment` çš„ï¼Œæœ‰ä¸åŒçš„ `Attention Score`ï¼›ä¸åŒçš„ `query` éƒ½åº”è¯¥å¯¹ åŒä¸€æ‰¹çš„ `segment` æœ‰ä¸åŒçš„ `Attention Score`ã€‚

![](https://qiniu.oldzhangtech.com/mdpic/27d4a47e-6390-46e1-9cfc-cf807a964c95_1b303e9c-fe57-42f2-80ce-1b15069c47fc.jpeg)
å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå°±æ˜¯è¿çº¿çš„å®½åº¦ä¸åŒï¼Œæ˜¾ç¤ºäº† `query` å’Œ ä¸åŒ `segment` ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œå³ä¸åŒçš„å¾—åˆ†ã€‚

å¦‚æœåŸºäºä¼ ç»Ÿçš„ `RNN` å»è¡¨è¾¾ `Attention`ï¼Œæœ‰ä¸€å®šçš„å±€é™æ€§ã€‚ `RNN` çš„è®¡ç®—éšçŠ¶æ€ `hidden` éƒ½æ˜¯ä¸å˜çš„ï¼Œå³æ¯ä¸ªä¿¡æ¯ï¼ˆç‰‡æ®µï¼‰ä»…ä»…åªæœ‰ä¸€ä¸ªç»´åº¦ï¼Œåªæœ‰ä¸€ä¸ªå€¼ã€‚
æ‰€ä»¥ `Attention æœºåˆ¶` å°† `hidden` åˆ†æ‹†æˆ `key` å’Œ `value`ï¼Œä¸” `query` å¾ªç¯å’Œæ‰€æœ‰çš„ `key` å’Œ `value` è®¡ç®—åæ‰å¾—åˆ° `Score`ã€‚

![](https://qiniu.oldzhangtech.com/mdpic/ed7f2a6d-58cc-4d66-ab04-87e683be4ded_b6102f89-59fd-47a1-94f4-4c0096fa84d4.jpeg)
ä¸Šå›¾ç®€åŒ–å‡ºæ¥çš„å…¬å¼å°±æ˜¯ `Attention Score` = $Attention(QW^Q,KW^K,VW^V)$ ï¼Œå°±æ˜¯ **æ³¨æ„åŠ›è¯„åˆ†å…¬å¼** äº†ã€‚

è¿™ç§æŠŠ `hidden` æ‹†åˆ†æˆ `key` å’Œ `value`ï¼Œå¹¶ä¸”ç»“åˆ  `query` è®¡ç®—å°±æ˜¯ `QKV æœºåˆ¶`ï¼ˆ query key value æœºåˆ¶ï¼‰ã€‚
### å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶
> Multiple Head Attention

ä»ä¸Šè¿°çš„ `QKV æœºåˆ¶` çŸ¥é“ï¼Œ`query` å°±æ˜¯æ ¹æ®å…´è¶£ç‚¹ï¼Œè§¦å‘å¯¹ç‰‡æ®µè®¡ç®—è¯„åˆ†ã€‚
å¦‚æœä»…ä»…æ˜¯ä¸€ä¸ª `query`ï¼Œå…¶å®å’Œ å•ä¸€ä½¿ç”¨ `RNN hidden` æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼›ä½†æ˜¯å¦‚æœå¢åŠ å¤šå‡ ä¸ª `query`ï¼Œå°±å¯ä»¥å¯¹ä¿¡æ¯è¿›è¡Œä¸åŒç»´åº¦çš„åˆ†å±‚ï¼Œä¹Ÿå°±æ˜¯ **å¤šå¤´** çš„æ„æ€ã€‚

ğŸ”¥ å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼Œå°±æ˜¯å­—å¦‚å…¶åï¼Œå¤šä¸ª `head`ï¼Œå¤šä¸ª `query`ï¼› ä¸€ä¸ª `head` å°±æ˜¯ ä¸€ä¸ª `query`ã€‚

æ¯”å¦‚ï¼Œâ€œå§šæ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜â€ï¼Œâ€œä»–ä¸‰è§’å‡½æ•°ä¸æ‡‚â€ è¿™ä¸¤ä¸ª `query` éƒ½åŒæ—¶å¯¹åŸä¿¡æ¯è¿›è¡Œç»Ÿè®¡è¯„åˆ†ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸åŒ `segment` å¯¹åº”çš„ `Attention Score`ã€‚

ğŸ”¥ æœ‰ç‚¹åƒæ˜¯  `CNN` çš„å·ç§¯æ ¸ï¼Œå¯ä»¥æŠ½å–ä¸åŒçš„ç‰¹å¾ç»´åº¦ã€‚

![](https://qiniu.oldzhangtech.com/mdpic/d759a94d-fe06-4a2c-baee-e3600f458cd8_389bd982-7410-49f2-9f81-577b6901d74c.jpeg)
`query`, `key`, `value` å› ä¸ºä¸åŒçš„ `head` éƒ½å¸¦æœ‰è‡ªå·±çš„ï¼ˆ$W^Q W^K W^V$ï¼‰ çŸ©é˜µè¿›è¡Œå­¦ä¹ ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå¸¦æ¥æ›´åŠ å¤šçš„å­¦ä¹ æ€§ã€‚

### è‡ªæ³¨æ„åŠ›æœºåˆ¶
> Self Attention

æœ‰æ—¶å€™ï¼Œä¸€å¥è¯ä¸­ï¼Œå·²ç»è•´å«äº†é€»è¾‘ã€‚æ¯”å¦‚ä¸Šé¢çš„â€œå§šæ˜æè¿°â€ï¼Œå°±ç®—æ²¡æœ‰æé—®ï¼Œéƒ½å¯ä»¥ä»è‡ªèº«çš„å¥å­ä¸­å»ºç«‹äº†å…³è”ã€‚

æ¯”å¦‚ï¼Œâ€œä»–ä»å°çš„æ•°å­¦æˆç»©å¹¶ä¸å¥½â€ `seg2` å’Œ â€œç»å¸¸æ—·è¯¾â€ `seg3`ï¼Œä»–ä»¬ä¸¤ä¸ªç‰‡æ®µå°±æœ‰éå¸¸å¼ºçš„ç›¸å…³æ€§ï¼Œä»–ä»¬ `Attention Score` çš„å¾—åˆ†å°±é«˜ï¼›åŒç†â€œç»å¸¸æ—·è¯¾â€ `seg3`ï¼Œâ€œä»–çˆ±åƒè‹¹æœâ€ `seg4`ï¼Œä»–ä»¬çš„å¾—åˆ†å°±ä¸é«˜ã€‚

ğŸ”¥ æ‰€ä»¥å½“ `Query Key Value` éƒ½æ˜¯è‡ªå·±çš„ï¼Œå°±æ˜¯ **è‡ªæ³¨æ„åŠ›æœºåˆ¶**ï¼Œå¯¹è‡ªå·±çš„ä¿¡æ¯ç‰‡æ®µå»ºç«‹ `Attention Score`ã€‚

![](https://qiniu.oldzhangtech.com/mdpic/0cdf99e8-066b-4390-a980-6c5ac39ce0b2_e1aab5d8-ebd1-4c02-8f37-6bed0a48f488.jpeg)
ä¸Šå›¾å¯ä»¥çŸ¥é“ï¼Œè¶Šç²—çš„çº¿ï¼Œå°±æ˜¯ä»–ä»¬çš„ `attention score` æ›´åŠ çš„é«˜åˆ†ï¼›ä¸”è¿™æ˜¯è‡ªèº«ç‰‡æ®µå’Œç‰‡æ®µä¹‹é—´çš„è¯„åˆ†ã€‚å°±æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„ä½“ç°ã€‚

### æ³¨æ„åŠ›å¾—åˆ†ä»£ç éƒ¨åˆ†
`Attention Score`ï¼Œåˆ°åº•ä»–ä»¬æ˜¯å¦‚ä½•è®¡ç®—çš„å‘¢ï¼Ÿ
ä¸‹é¢æ˜¯ç®€æ˜“è‡ªæ³¨æ„åŠ›å¾—åˆ†çš„ä»£ç ç‰‡æ®µã€‚é‡Œé¢å·²ç»åŒ…å«äº† **QKV æœºåˆ¶**ï¼Œ**å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶**ï¼Œå’Œ **è‡ªæ³¨æ„åŠ›æœºåˆ¶**ã€‚

```python
    # [0]
    query_f = nn.Linear(d_model, d_model)
    key_f = nn.Linear(d_model, d_model)
    value_f = nn.Linear(d_model, d_model)
    fc = nn.Linear(d_model, d_model)
    # [3]
    def forward(self, query, key, value, mask=None):
        batch_size = query.size(0)

        def transform(x):
            return x.view(batch_size, -1, self.num_heads, self.d_k).transpose(1, 2)
        # [1] å¯¹ queryï¼Œkeyï¼Œvalue è¿›è¡Œå…¨é“¾æ¥çš„è½¬æ¢
        query = transform(query_f(query))
        key = transform(key_f(key))
        value = transform(value_f(value))
        # [2] å°è£…çš„æ–¹æ³•
        attn_output, attn = ScaledDotProductAttention(self.d_k)(query, key, value, mask)
```
_ä»£ç è§£æ_ï¼š  

1. [0] query_fï¼Œkey_fï¼Œ value_f å®šä¹‰ å…¨é“¾æ¥ç½‘ç»œï¼Œç”¨äºå­¦ä¹ çš„å‚æ•°
2. [1] queryï¼Œkeyï¼Œvalue è¿›è¡Œå…¨é“¾æ¥çš„è½¬æ¢ï¼Œè¿™é‡Œæœ‰å‚æ•°çš„å­¦ä¹ 
3. [2] å°è£…çš„æ–¹æ³•ï¼Œå¯ä»¥è®¡ç®—å‡ºæœ€åçš„ `Attention Sore`ï¼Œé‡Œé¢å·²ç»åŒ…å« ç‚¹ç§¯/softmax ç­‰è®¡ç®—
4. [3] å¦‚æœ query, key, value éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ª **å¤šå¤´çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶** çš„è®¡ç®—å…¬å¼

 å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„æ•°å­¦è¡¨è¾¾å¼ï¼š  
$head_i=Attention(QW_i^Q,KW_i^K,VW_i^V)$ ï¼ˆ $W_i^Q W_i^K W_i^V$ éƒ½æ˜¯ä¸åŒçš„å…¨é“¾æ¥ç½‘ç»œ ï¼‰
### ä¾‹å­è¯´æ˜
å¯è¿è¡Œçš„ ipynb æ–‡ä»¶[é“¾æ¥](https://gitee.com/oldmanzhang/resource_machine_learning/blob/master/deep_learning/attention.ipynb)ã€‚
ä»»åŠ¡ï¼šè¾“å…¥æ•°æ®ï¼Œè®¡ç®—æ•°æ®ä¹‹é—´çš„æ³¨æ„åŠ›åˆ†æ•°ï¼Œå¹¶ä¸”å¯ä»¥è§†è§‰åŒ–æ•°æ®ä¹‹é—´çš„å…³æ³¨åº¦ã€‚

_ä»£ç è§£æ_  
```python
input_seq = torch.tensor([
    [1.0, 0.0, 1.0, 0.0],  # Token 1
    [0.0, 1.0, 0.0, 1.0],  # Token 2
    [1.0, 1.0, 0.0, 0.0],  # Token 3
    [0.0, 0.0, 1.0, 1.0],  # Token 4
    [1.0, 0.5, 0.5, 0.0]   # Token 5
], dtype=torch.float32)

# Dimensions
d_k = input_seq.shape[1]  # Embedding dimension (4 in this case)

# Query, Key, and Value are all set to the input sequence (self-attention)
query = input_seq
key = input_seq
value = input_seq

# Calculate attention scores (scaled dot-product)
# [1]
scores = torch.matmul(query, key.transpose(-2, -1)) / torch.sqrt(torch.tensor(d_k))
print("Attention scores:\n", scores)
# Apply softmax to get attention weights
# [2]
attention_weights = F.softmax(scores, dim=-1)
print("Attention scores afert softmax:\n", attention_weights)

# Calculate the output as a weighted sum of the values
# [3]
output = torch.matmul(attention_weights, value)

print("Attention Weights:\n", attention_weights)
```

1. [1] ç®€å•ä½¿ç”¨å¯¹ query key è¿›è¡Œ ç‚¹ç§¯ æ¥è®¡ç®—åˆ†æ•°
> è¿™é‡Œä½¿ç”¨äº†ç®€åŒ–ç‰ˆæœ¬ï¼Œ**æ²¡æœ‰** $W^q$ $W^k$ çš„çŸ©é˜µå­¦ä¹ 

2. [2] softmax scoreï¼Œå…¨éƒ¨å€¼å½’ä¸€åˆ° (0,1) çš„å€¼ä¸­
3. [3] score å’Œ value ç›¸ä¹˜ï¼Œå¾—åˆ°æœ€åçš„ weightsï¼Œå°±æ˜¯æœ€åçš„ç»“æœ
> è¿™é‡Œä½¿ç”¨äº†ç®€åŒ–ç‰ˆæœ¬ï¼Œ**æ²¡æœ‰** $W^v$  çš„çŸ©é˜µå­¦ä¹ 


_è¿è¡Œç»“æœ_  
```python
'''
Attention scores:
 tensor([[1.0000, 0.0000, 0.5000, 0.5000, 0.7500],
        [0.0000, 1.0000, 0.5000, 0.5000, 0.2500],
        [0.5000, 0.5000, 1.0000, 0.0000, 0.7500],
        [0.5000, 0.5000, 0.0000, 1.0000, 0.2500],
        [0.7500, 0.2500, 0.7500, 0.2500, 0.7500]])
Attention scores afert softmax:
 tensor([[0.2976, 0.1095, 0.1805, 0.1805, 0.2318],
        [0.1205, 0.3275, 0.1986, 0.1986, 0.1547],
        [0.1805, 0.1805, 0.2976, 0.1095, 0.2318],
        [0.1986, 0.1986, 0.1205, 0.3275, 0.1547],
        [0.2374, 0.1440, 0.2374, 0.1440, 0.2374]])
Attention Weights:
 tensor([[0.2976, 0.1095, 0.1805, 0.1805, 0.2318],
        [0.1205, 0.3275, 0.1986, 0.1986, 0.1547],
        [0.1805, 0.1805, 0.2976, 0.1095, 0.2318],
        [0.1986, 0.1986, 0.1205, 0.3275, 0.1547],
        [0.2374, 0.1440, 0.2374, 0.1440, 0.2374]])
'''
```
![image.png](https://qiniu.oldzhangtech.com/mdpic/6d9f194c-b314-4af9-bb93-dd782176ad6a_169e0c5f-3757-4035-b6eb-aa505bd920b9.png)
ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œæ³¨æ„åŠ›çš„çƒ­å›¾ï¼Œè¡¨ç¤ºæ¯ä¸ª token ä¹‹é—´çš„æ³¨æ„åŠ›çš„å…³ç³»ã€‚ Y è½´æ˜¯ `Query Token`ï¼ŒX è½´æ˜¯ `Key Token`ã€‚å›¾ä¸­æ¯ä¸€è¡Œä¸­è¶Šæ·±è‰²çš„æ–¹å—ï¼Œå°±ä»£è¡¨ `Query` åœ¨è¿™è¡Œä¸­çš„  `Key` çš„å¾—åˆ†æœ€é«˜ã€‚
æ¯”å¦‚ï¼Œç¬¬ä¸€è¡Œï¼Œ`query1` å¯¹ `key1`ï¼ˆè‡ªå·±ï¼‰çš„é¢œè‰²æœ€æ·±ï¼Œè¯´æ˜æ¯ä¸ª `Token` éƒ½åº”è¯¥ä¸è‡ªå·±çš„å…³è”åº¦é«˜ï¼›ç¬¬ 5 è¡Œï¼Œ`query5` å¯¹ `key1`ï¼Œ`key3`ï¼Œ`key5` çš„å¾—åˆ†ä¸€æ ·ä¸”é¢œè‰²æœ€æ·±ï¼Œè¯´æ˜ `query5` çš„å…³è”ä¸ `key1`ï¼Œ`key3`ï¼Œ`key5` ç›¸ä¸€æ ·ã€‚

## æ€»ç»“
`Attention æœºåˆ¶` çš„ä¼˜åŠ¿  

1. å…³æ³¨ä½ æƒ³è¦çš„ä¿¡æ¯ï¼Œè§£å†³äº†é•¿åºåˆ—çš„é—®é¢˜
2. å¯ä»¥æœ‰å¤šç»´çš„è§’åº¦å»ç†è§£æ•°æ®
3. å…¶ä¸­è•´å«äº†é€»è¾‘

`Attention æœºåˆ¶` æ˜¯ `Transformer` çš„åŸºç¡€ï¼Œæ‰€æœ‰æ‰€æœ‰çš„ `NLP` ä¸­æ‰“å¼€äº†æ–°çš„ä¸€æ‰‡çª—ã€‚

## å¼•ç”¨
[Dive into deep learning](https://zh-v2.d2l.ai/chapter_attention-mechanisms/attention-cues.html#id4)



